
var app = app || {};

(function () {

  app.ChatModel = Backbone.Model.extend({});

})();

var app = app || {};

(function () {

  app.ChatroomHeaderModel = Backbone.Model.extend({});

})();

var app = app || {};

(function () {

  app.ContainerModel = Backbone.Model.extend({});

})();

var app = app || {};

(function () {

  app.LoginModel = Backbone.Model.extend({
    defaults: {
      error: ""
    }
  });


})();

var app = app || {};

(function () {

  app.UserModel = Backbone.Model.extend({});
  
})();

var app = app || {};

(function () {

  app.ChatCollection = Backbone.Collection.extend({
    model: app.ChatModel
  });

})();

var app = app || {};

(function () {

  app.UserCollection = Backbone.Collection.extend({model: app.UserModel});

})();

var app = app || {};

(function () {

app.ChatroomModel = Backbone.Model.extend({
  defaults: {
    chatroom: new app.ChatroomHeaderModel({ name: 'DOO'}),
    onlineUsers: new app.UserCollection(),
    offlineUsers: new app.UserCollection(),
    chatlog: new app.ChatCollection([
      // message and sender upon entering chatroom
      new app.ChatModel({ sender: 'Butters', message: 'awwwwww hamburgers. ||):||', timestamp: _.now(), url: ''})
      ]),
    chatrooms: null,
    privateRooms: null,
    owner: null,
    modelsLoadedSum: 0,
  },
  loadModel: function() {
    console.log('crm.f.loadModel');
  },
  addUser: function(user) {
    console.log('crm.f.addUser');
    this.get('onlineUsers').add(new app.UserModel({ username: user.username, userImage: user.userImage }));
    console.log("--adding-user---");
  },
  removeUser: function(user) {
    console.log('crm.f.removeUser');
    var onlineUsers = this.get('onlineUsers');
    var foundUser = onlineUsers.find(function(userModel) { return userModel.get('username') == user.username; });
    if (foundUser) {
      onlineUsers.remove(foundUser);
    }
  },
  addChat: function(chat) {
    console.log('crm.f.addChat');
    var now = _.now();
    this.get('chatlog').add(new app.ChatModel({ sender: chat.sender, message: chat.message, timestamp: now, url: chat.url}));
    // this.trigger('gorp', chat);
  },
});

})();

var app = app || {};

(function () {

  app.InvitationModel = Backbone.Model.extend({

  });
  
})();

var app = app || {};

(function () {

  app.ChatroomList = Backbone.Collection.extend({
    model: app.ChatroomModel,
  });

})();
var app = app || {};

(function () {

  app.PrivateRoomCollection = Backbone.Collection.extend({
    model: app.ChatroomModel,
  });

})();

var app = app || {};

(function () {

  app.InvitationCollection = Backbone.Collection.extend({
    model: app.InvitationModel
  });

})();
var app = app || {};

(function ($) {

app.ChatroomView = Backbone.View.extend({
  template: _.template($('#chatroom-template').html()),
  chatTemplate: _.template($('#chatbox-message-template').html()),
  roomTemplate: _.template($("#room-list-template").html()),
  headerTemplate: _.template($('#chatroom-header-template').html()),
  directMessageHeaderTemplate: _.template($('#direct-message-header-template').html()),
  onlineUserTemplate: _.template($('#online-users-list-template').html()),
  offlineUserTemplate: _.template($('#offline-users-list-template').html()),
  dateTemplate: _.template('<div class="followWrap"><div class="followMeBar"><span> <%= moment(timestamp).format("MMMM Do") %> </span></div></div>'),
  events: {
    'keypress .message-input': 'messageInputPressed',
    'keypress .direct-message-input': 'directMessageInputPressed',
    'click .chat-directory .room': 'setRoom',
    'keyup #chat-search-input': 'searchValidation',
    'click .remove-chatroom': 'removeRoom',
    'click .destroy-chatroom': 'destroyRoom',
    'click .destroy-this-particular-chatroom': 'destroyThisParticularRoom',
    'keyup #chatroom-name-input': 'doesChatroomExist',
    'click .user': 'initDirectMessage',
  },


  doesChatroomExist: function(e) {
    e.preventDefault();
    var this_ = this;
    var check = function() {
      if ($.trim($('#chatroom-name-input').val()).length > 0) {
        var chatroomName = $('#chatroom-name-input').val();
         this_.vent.trigger('doesChatroomExist', chatroomName);
      } else {
         this_.$('#chatroom-name-validation-container').children().remove();
         this_.$('#chatroom-name-input').removeClass('input-valid input-invalid');
      }
    };
    _.debounce(check(), 150);
  },

  renderChatroomAvailability: function(availability) {
    this.createChatroomView.trigger('chatroomAvailability', availability);
  },



  initialize: function(options) {
    console.log('chatroomView.f.initialize: ', options);
    // passed the viewEventBus
    var self = this;
    this.vent = options.vent;
  },
  render: function(model) {
    console.log('crv.f.render');
    this.model = model || this.model;
    this.$el.html(this.template(this.model.toJSON()));
    this.afterRender();
    return this;
  },
  afterRender: function() {
    this.setSubViews();
    this.setChatListeners();
    this.chatroomSearchTypeahead();
  },
  setSubViews: function() {
    this.chatImageUploadView = new app.ChatImageUploadView();
    this.chatImageUploadView.setElement(this.$('#chatImageUploadContainer'));
    this.createChatroomView = new app.CreateChatroomView({vent: this.vent});
    this.createChatroomView.setElement(this.$('#createChatroomContainer'));
  },
  setChatListeners: function() {

    var onlineUsers = this.model.get('onlineUsers');
    this.listenTo(onlineUsers, "add", this.renderUser, this);
    this.listenTo(onlineUsers, "remove", this.renderUsers, this);
    this.listenTo(onlineUsers, "reset", this.renderUsers, this);

    var offlineUsers = this.model.get('offlineUsers');
    this.listenTo(offlineUsers, "add", this.renderOfflineUser, this);
    this.listenTo(offlineUsers, "remove", this.renderOfflineUsers, this);
    this.listenTo(offlineUsers, "reset", this.renderOfflineUsers, this);

    var chatlog = this.model.get('chatlog');
    this.listenTo(chatlog, "add", this.renderChat, this);
    this.listenTo(chatlog, "remove", this.renderChats, this);
    this.listenTo(chatlog, "reset", this.renderChats, this);

    var chatrooms = this.model.get('chatrooms');
    this.listenTo(chatrooms, "add", this.renderRoom, this);
    this.listenTo(chatrooms, "remove", this.renderRooms, this);
    this.listenTo(chatrooms, "reset", this.renderRooms, this);

    var privateRooms = this.model.get('privateRooms');
    this.listenTo(privateRooms, "add", this.renderPrivateRoom, this);
    this.listenTo(privateRooms, "remove", this.renderPrivateRooms, this);
    this.listenTo(privateRooms, "reset", this.renderPrivateRooms, this);

    this.listenTo(this.model, "change:chatroom", this.renderHeader, this);

    this.listenTo(this.chatImageUploadView, 'chat-image-uploaded', this.chatUploadImage);
    this.listenTo(this.chatImageUploadView, 'message-image-uploaded', this.messageUploadImage);

    this.listenTo(this.model, "moreChats", this.renderMoreChats, this);

    this.listenTo(this.model, "userInvited", this.userInvited, this);

    this.listenTo(this.model, "chatroomExists", this.chatroomExists, this);
    this.listenTo(this.model, "chatroomAvailability", this.renderChatroomAvailability, this);
    this.listenTo(this.model, "homeRoomAvailability", this.renderHomeRoomAvailability, this);

    var this_ = this;
    this.$('#chatbox-content').scroll(function(){
        // checks if there's enough chats to warrant a getMoreChats call
      if ($('#chatbox-content').scrollTop() === 0 && this_.model.get('chatlog').length >= 25) {
        if (this_.model.get('chatroom').get('chatType') === 'message') {
          _.debounce(this_.getMoreDirectMessages(), 3000);
        } else {
          _.debounce(this_.getMoreChats(), 3000);
        }
      }
    });

    $(window).resize(function() {
      var windowHeight = $(window).height();
      if (windowHeight > 500) {
        var newHeight = windowHeight - 285;
        $('#chatbox-content').height(newHeight);
      }
    });

  },

  welcome: _.once(function() {
    if (this.model.get('chatrooms').length === 0 &&
      this.model.get("privateRooms").length === 0) {
      // this.$('#public-rooms').append('<div class="no-rooms">Welcome to the Parlor. To start, join this room by searching and pressing enter. The room will be saved to your list of rooms.</div><div class="no-rooms">Search or create chatrooms yonder <i class="fa fa-long-arrow-up"></i></div>');
      swal({
        title: "Welcome to Chjat",
        text: "To start, join the Chjat room by searching and pressing enter. The room will be saved to your list of rooms. Or, if you're feeling adventurous, search for a public room, join it, create your own, invite your friends, enemies, awkward acquaintinces, make your room private, get down and dirty, you know what I mean, discuss dirty things, you know? Root vegetables.",
        // type: "info",
        // showCancelButton: true,
        confirmButtonColor: "#749CA8",
        confirmButtonText: "Boop",
        // closeOnConfirm: false,
        // html: false
        imageUrl: "/img/fly-pig-serious-icon.png",
      });
    }
  }),

  chatroomSearchTypeahead: function() {
    // interesting - the 'this' makes a difference, can't find #chat-search-input otherwise
      var this_ = this;
      var blood = new Bloodhound({
        datumTokenizer: Bloodhound.tokenizers.obj.whitespace('name'),
        queryTokenizer: Bloodhound.tokenizers.whitespace,
        prefetch: {
          url: '/api/publicChatrooms',
          filter: function(data) {
             return _.map(data, function(chatroom) {
                return { name: chatroom };
             });
          },
          ttl: 0,
        },
        remote: {
          url: '/api/searchChatrooms?name=%QUERY',
          wildcard: '%QUERY',
          rateLimitWait: 300,
        }
      });
      blood.clearPrefetchCache();
      blood.initialize();
      var type =  this.$('#chat-search-input').typeahead({
        minLength: 2,
        classNames: {
          input: 'typeahead-input',
          hint: 'typeahead-hint',
          selectable: 'typeahead-selectable',
          menu: 'typeahead-menu',
          highlight: 'typeahead-highlight',
          dataset: 'typeahead-dataset',
        },
      },
      {
        limit: 5,
        source: blood,
        name: 'chatroom-search',
        display: 'name',
      }).on('typeahead:select typeahead:autocomplete', function(obj) {
         var chatroomName = $('#chat-search-input').val();
         this_.vent.trigger('doesSearchChatroomExist', chatroomName);
      });
  },



// headers

  renderHeader: function() {
    this.$('#chatbox-header').html(this.headerTemplate(this.model.get('chatroom').toJSON()));
    this.chatroomSettingsView = new app.ChatroomSettingsView({vent: this.vent, model: this.model.get('chatroom')});
    this.chatroomSettingsView.setElement(this.$('#chatroom-header-container'));
    this.listenTo(this.chatroomSettingsView, 'updateRoom', this.updateRoom);
  },

  renderDirectMessageHeader: function() {
    this.$('#chatbox-header').html(this.directMessageHeaderTemplate(this.model.get('chatroom').toJSON()));
  },

  userInvited: function(data) {
    this.chatroomSettingsView.trigger('userInvited', data);
  },




// users

  renderUsers: function() {
    console.log('crv.f.renderUsers');
    onlineUsers = this.model.get("onlineUsers");
    this.$('.online-users').empty();
    this.model.get("onlineUsers").each(function (user) {
      this.renderUser(user);
    }, this);
  },
  renderUser: function(model) {
    this.$('.online-users').append(this.onlineUserTemplate(model.toJSON()));
  },
  renderOfflineUsers: function() {
    console.log('crv.f.renderOfflineUsers');
    this.$('.offline-users').empty();
    this.model.get("offlineUsers").each(function (user) {
      this.renderOfflineUser(user);
    }, this);
  },
  renderOfflineUser: function(model) {
    this.$('.offline-users').append(this.offlineUserTemplate(model.toJSON()));
  },





// chatlog

  renderChats: function() {
    console.log('crv.f.renderChats');
    var chatlog = this.model.get("chatlog");
    this.$('#chatbox-content').empty();
    chatlog.each(function(chat) {
      this.renderChat(chat);
    }, this);
    if ( chatlog.length === 0) {
      chatlog.push(new app.ChatModel({ sender: 'Chjat', message: "¯\\_(ツ)_/¯", timestamp: _.now(), url: ''}));
    }
    this.afterChatsRender();
  },

  renderChat: function(model) {
    this.renderDateDividers(model);
    var chatTemplate = $(this.chatTemplate(model.toJSON()));
    chatTemplate.appendTo(this.$('#chatbox-content')).hide().fadeIn().slideDown();
    $('#chatbox-content')[0].scrollTop = $('#chatbox-content')[0].scrollHeight;
  },

  renderDateDividers: function(model) {
    this.currentDate = moment(model.get('timestamp')).format('dddd, MMMM Do YYYY');
    if ( this.currentDate !== this.previousDate ) {
      var currentDate = $(this.dateTemplate(model.toJSON()));
      currentDate.appendTo(this.$('#chatbox-content')).hide().fadeIn().slideDown();
      this.previousDate = this.currentDate;
    }
  },

  getMoreChats: function() {
    console.log('crv.f.getMoreChats');
    var chatroom = this.model.get('chatroom'),
    name = chatroom.get('name'),
    modelsLoadedSum = chatroom.get('modelsLoadedSum');
    var chatlogLength = chatroom.get('chatlogLength');
    this.vent.trigger('getMoreChats', { name: name, modelsLoadedSum: modelsLoadedSum, chatlogLength: chatlogLength});
    chatroom.set('modelsLoadedSum', (modelsLoadedSum - 1));
  },

  getMoreDirectMessages: function() {
    console.log('crv.f.getMoreDriectMessages');
    var chatroom = this.model.get('chatroom'),
    id = chatroom.get('id'),
    modelsLoadedSum = chatroom.get('modelsLoadedSum');
    var chatlogLength = chatroom.get('chatlogLength');
    this.vent.trigger('getMoreDirectMessages', { id: id, modelsLoadedSum: modelsLoadedSum, chatlogLength: chatlogLength});
    chatroom.set('modelsLoadedSum', (modelsLoadedSum - 1));
  },

  renderMoreChats: function(chats) {
    console.log('crv.f.renderMoreChats');
    var this_ = this;
    var originalHeight = $('#chatbox-content')[0].scrollHeight;
    this.moreChatCollection = [];
    _.each(chats, function(model) {
      this_.renderMoreDateDividers(model);
      var chatTemplate = $(this.chatTemplate(model.toJSON()));
      this_.moreChatCollection.push(chatTemplate);
    }, this);
    _.each(this.moreChatCollection.reverse(), function(template) {
      template.prependTo(this.$('#chatbox-content'));
    });

    this.dateDivider.load($(".followMeBar"));
    $('#chatbox-content')[0].scrollTop = $('#chatbox-content')[0].scrollHeight - originalHeight;
  },

  renderMoreDateDividers: function(model) {
    this.currentDate = moment(model.attributes.timestamp).format('dddd, MMMM Do YYYY');
    if ( this.currentDate !== this.previousDate ) {
      var currentDate = $(this.dateTemplate(model.toJSON()));
      this.moreChatCollection.push(currentDate);
      this.previousDate = this.currentDate;
    }
  },

  autosizer: function() {
    autosize($('#message-input'));
  },
  
  scrollBottomInsurance: function(){
    var this_ = this;
    var interval = setInterval(function(){
      this.$('#chatbox-content')[0].scrollTop = this.$('#chatbox-content')[0].scrollHeight;
    }, 50);
    return setTimeout(function(){
      clearInterval(interval);
    }, 800);
  },

  afterChatsRender: function() {
    this.autosizer();
    this.dateDivider.load($(".followMeBar"));
    this.scrollBottomInsurance();
  },





// rooms

  searchRoom: function() {
      var name = $('#chat-search-input').val();
      this.addChatroom(name);
      $('#chat-search-input').val('');
  },
  searchValidation: function(e) {
    if (e.keyCode === 13 && $.trim($('#chat-search-input').val()).length > 0 && $('#chat-search-input').hasClass('input-valid')) {
      this.searchRoom();
    } else if ($('#chat-search-input').val() === '') {
      $('#chat-search-input').removeClass('input-valid input-invalid');
    } else {
      this.vent.trigger('doesSearchChatroomExist', $('#chat-search-input').val());
    }
    return this;
  },
  chatroomExists: function(availability) {
    $('#chat-search-input').removeClass('input-valid input-invalid');
    if (availability === false) {
      $('#chat-search-input').addClass('input-valid');
    } else {
      $('#chat-search-input').addClass('input-invalid');
    }
  },
  createRoom: function(form) {
    this.vent.trigger('createRoom', form);
  },
  updateRoom: function(form) {
    var id = this.model.get('chatroom').get('id');
    form.id = id;
    this.vent.trigger('updateRoom', form);
  },
  destroyRoom: function(e) {
    e.preventDefault();
    var roomName = this.model.get('chatroom').get('name');
    var this_ = this;
    var confirmation = swal({
      title: "Do you wish to destroy " + roomName + "?",
      text: "This kills the room.",
      type: "warning",
      showCancelButton: true,
      confirmButtonColor: "#DEB0B0",
      confirmButtonText: "Muahaha!",
      closeOnConfirm: false,
      html: false
    }, function(){
      var roomId = this_.model.get('chatroom').id;
      var userInRoom = true;
      this_.vent.trigger('destroyRoom', { id: roomId, roomName: roomName, userInRoom: userInRoom });
    });
  },
  destroyThisParticularRoom: function(e) {
    e.preventDefault();
    var roomName = $(e.target).data("room-name");
    var this_ = this;
    var confirmation = swal({
      title: "Do you wish to destroy " + roomName + "?",
      text: "This kills the room.",
      type: "warning",
      showCancelButton: true,
      confirmButtonColor: "#DEB0B0",
      confirmButtonText: "Muahaha!",
      closeOnConfirm: false,
      html: false
    }, function(){
      var currentRoomId = this_.model.get('chatroom').id;
      var roomId = $(e.target).data("room-id");
      var userInRoom = currentRoomId === roomId;
      this_.vent.trigger('destroyRoom', { id: roomId, roomName: roomName, userInRoom: userInRoom });
    });
  },
  addChatroom: function(name) {
    console.log('crv.f.addChatroom');
    this.vent.trigger('addRoom', name);
  },
  removeRoom: function(e) {
    var this_ = this;
    var confirmation = swal({
      title: "Remove This Room?",
      text: "Are you sure? Are you sure you're sure? How sure can you be?",
      type: "warning",
      showCancelButton: true,
      confirmButtonColor: "#DEB0B0",
      confirmButtonText: "Muahaha!",
      closeOnConfirm: false,
      html: false
    }, function(){
      swal({
        title: "Removed!",
        text: "You are free of this chatroom. Go on, you're free now.",
        type: "success",
        confirmButtonColor: "#749CA8"
      });
      var currentRoomId = this_.model.get('chatroom').id;
      var roomId = $(e.target).data("room-id");
      var roomName = $(e.target).data("room-name");
      var userInRoom = currentRoomId === roomId;
      this_.vent.trigger('removeRoom', {id: roomId, roomName: roomName, userInRoom: userInRoom});
    });
  },
  renderRooms: function() {
    console.log('crv.f.renderRooms');
    this.$('#public-rooms').empty();
    this.model.get('chatrooms').each(function (room) {
      this.renderRoom(room);
    }, this);
    this.welcome();
  },
  renderRoom: function(model) {
    var name1 = model.get('name'),
    name2 = this.model.get('chatroom').get('name');
    this.$('#public-rooms').append(this.roomTemplate(model.toJSON()));
    if (name1 === name2) {
      this.$('#public-rooms').find('.room-name').last().addClass('active').fadeIn();
    }
  },
  renderPrivateRooms: function() {
    console.log('crv.f.renderPrivateRooms');
    this.$('#private-rooms').empty();
    this.model.get('privateRooms').each(function (room) {
      this.renderPrivateRoom(room);
    }, this);
  },
  renderPrivateRoom: function(model) {
    var name1 = model.get('name'),
    name2 = this.model.get('chatroom').get('name');
    this.$('#private-rooms').append(this.roomTemplate(model.toJSON()));
    if (name1 === name2) {
      this.$('#private-rooms').find('.room-name').last().addClass('active').fadeIn();
    }
  },
  joinRoom: function(obj) {
    console.log('crv.f.joinRoom');
    this.currentDate = '';
    this.previousDate = '';
    this.vent.trigger('joinRoom', obj.name);
  },
// change to 'joinDirectMessage'
  initDirectMessage: function(e) {
    var recipient = {},
    $tar = $(e.currentTarget);
    recipient.username = $tar.text().trim();
    recipient.userImage = $tar.find('img').attr('src');
    this.currentDate = '';
    this.previousDate = '';
    if (this.model.get('chatroom').get('currentUser') !== recipient.username) {
      this.vent.trigger('initDirectMessage', recipient);
    }
  },





// image upload

  chatUploadImage: function(response) {
    this.vent.trigger("chat", response);
    this.scrollBottomInsurance();
  },
  messageUploadImage: function(response) {
    this.vent.trigger("directMessage", response);
    this.scrollBottomInsurance();
  },





  //events

  messageInputPressed: function(e) {
    if (e.keyCode === 13 && $.trim($('.message-input').val()).length > 0) {
      // fun fact: separate events with a space in trigger's first arg and you
      // can trigger multiple events.
      if (e.shiftKey || e.ctrlKey) {
        console.log('shift');
      } else {
        this.vent.trigger("chat", { message: this.$('.message-input').val()});
        this.$('.message-input').val('');
        return false;
      }
    } else {
      this.vent.trigger("typing");
      console.log('wut');
    }
    return this;
  },
  directMessageInputPressed: function(e) {
    if (e.keyCode === 13 && $.trim($('.direct-message-input').val()).length > 0) {
      // fun fact: separate events with a space in trigger's first arg and you
      // can trigger multiple events.
      this.vent.trigger("directMessage", { message: this.$('.direct-message-input').val()});
      this.$('.direct-message-input').val('');
      return false;
    } else {
      this.vent.trigger("typing");
    }
    return this;
  },
  setRoom: function(e) {
    console.log('crv.f.setRoom');
    var $tar = $(e.target);
    if ($tar.is('.room-name')) {
      this.joinRoom({id: $tar.data('room-id'), name: $tar.data('room')});
    }
  },


  dateDivider: (function() {

    var $window = $(window),
    $stickies;

    load = function(stickies) {
      $stickies = stickies;
      $('#chatbox-content').scroll(scrollStickiesInit);
    };

    scrollStickiesInit = function() {
      $(this).off("scroll.stickies");
      $(this).on("scroll.stickies", _.debounce(_whenScrolling, 150));
    };

    _whenScrolling = function() {
      $stickies.removeClass('fixed');
      $stickies.each(function(i, sticky) {
        var $thisSticky = $(sticky),
        $thisStickyTop = $thisSticky.offset().top;
        if ($thisStickyTop <= 162) {
          $thisSticky.addClass("fixed");
        }
      });
    };

    return {
      load: load
    };
  })()




});

})(jQuery);
var app = app || {};


(function($) {

  app.ChatroomSettingsView = Backbone.View.extend({

    el: $('#chatroom-header-container'),
    userInvitedTemplate: _.template('<div class="user-invited-response success"><%= username %> Invited!</div>'),
    invitationErrorTemplate: _.template('<div class="user-invited-response failure">Failure!</div>'),
    events: {
      'change #preferences-image-upload': 'renderThumb',
      'attachImage #preferences-form': 'upload',
      'click #preferences-btn': 'submit',
      'keyup #invite-user-input': 'inviteUser',
    },

    initialize: function(options) {
      this.vent = options.vent;
      this.userSearchTypeahead();
      var this_ = this;
      $("form").submit(function(e) {
        e.preventDefault();
      });

      this.listenTo(this, "userInvited", this.userInvited, this);
    },

    render: function() {
      this.renderThumb();
    },

    renderThumb: function() {
      var input = this.$('#preferences-image-upload');
      var img = this.$('#uploaded-preferences-image')[0];
      if(input.val() !== '') {
        var selected_file = input[0].files[0];
        var reader = new FileReader();
        reader.onload = (function(aImg) {
          return function(e) {
            aImg.src = e.target.result;
          };
        })(img);
        reader.readAsDataURL( selected_file );
      }

    },

    submit: function(e) {
      e.preventDefault();

      this.$form = this.$('#preferences-form');
      this.$form.trigger('attachImage');
    },

    upload: function() {
      var _this = this;
        var formData = new FormData(this.$form[0]);
      if (this.$('#preferences-image-upload')[0].files.length > 0) {
        $.ajax({
          type: 'POST',
          url: '/api/uploadChatroomImage',
          data: formData,
          cache: false,
          dataType: 'json',
          processData: false,
          contentType: false,
          error: function( xhr ) {
            swal({
              title: "OH NO OH NO OH NO",
              text: "Your image. It uh, won't fit. 'Too big. It needs to be less than 500 Kb,' the computer monkeys say. 'And .jpeg, .png, or .gif file'.",
              imageUrl: '/img/scuba-pig.png',
              confirmButtonColor: "#749CA8"
            });
          },
          success: function( response ) {
            console.log('imgUpload response: ', response);
            var form = _this.createRoomFormData();
            form.roomImage = response.roomImage;
            _this.trigger('updateRoom', form);
            $('#preferences-modal').modal('hide');
            _this.clearField();
          }
        });
      } else {
        var form = this.createRoomFormData();
        this.trigger('updateRoom', form);
      }
      return false;
    },


    createRoomFormData: function() {
      var formData = {};
      this.$('#preferences-form').find( 'input' ).each(function(i, el) {
        if ($(el).data('create') === 'privacy') {
          var val = $(el).prop('checked');
          formData['privacy'] = val;
        } else if ($(el).val() !== '' && $(el).val() !== 'on') {
          formData[$(el).data('create')] = $(el).val();
          $(el).val('');
        }
      });
      delete formData.undefined;
      return formData;
    },


    clearField: function() {
      this.$('#uploaded-preferences-image')[0].src = '';
      this.$('#preferences-image-upload').val('');
    },

    inviteUser: function(e) {
      e.preventDefault();
      var recipient = $.trim($('#invite-user-input').val());
      if (e.keyCode === 13 && recipient.length > 0) {
        // e.preventDefault();
        var sender = this.model.get('currentUser'),
            roomId = this.model.get('id'),
            roomName = this.model.get('name'),
            invitationObj = {sender: sender, roomId: roomId, roomName: roomName, recipient: recipient};
        this.vent.trigger('inviteUser', invitationObj);
        $('#invite-user-input').val('');
      }
      return this;
    },

    userSearchTypeahead: function() {
      var this_ = this;
      var blood = new Bloodhound({
        datumTokenizer: Bloodhound.tokenizers.obj.whitespace('username'),
        queryTokenizer: Bloodhound.tokenizers.whitespace,
        prefetch: {
          url: '/allUsers',
          filter: function(data) {
             return _.map(data, function(user) {
                return { username: user };
             });
          },
          ttl: 0,
        },
        remote: {
          url: '/searchUsers?username=%QUERY',
          wildcard: '%QUERY',
          rateLimitWait: 300,
        }
      });
      blood.clearPrefetchCache();
      blood.initialize();
      $('#invite-user-input').typeahead({
        minLength: 2,
        classNames: {
          input: 'typeahead-input',
          hint: 'typeahead-hint',
          selectable: 'typeahead-selectable',
          menu: 'typeahead-menu',
          highlight: 'typeahead-highlight',
          dataset: 'typeahead-dataset',
        },
      },
      {
        limit: 5,
        source: blood,
        name: 'user-search',
        display: 'username',
      }).on('typeahead:select typeahead:autocomplete', function(obj) {

      });
    },

    userInvited: function(username) {
      if (username.error === 'error') {
        $('.invite-user-container').append(this.invitationErrorTemplate());
      }
      $('.invite-user-container').append(this.userInvitedTemplate({username: username}));
      setTimeout(function() {
        $('.invite-user-container .success').fadeOut(300, function() {
          $(this).remove();
        });
        $('.invite-user-container .failure').fadeOut(300, function() {
          $(this).remove();
        });
      }, 1000);
    },


  });

})(jQuery);
var app = app || {};

(function ($) {

  app.ContainerView = Backbone.View.extend({
    el: '#view-container',
    initialize: function(options) {
      this.model.on("change:viewState", this.render, this);
    },
    render: function() {
      var view = this.model.get('viewState');
      this.$el.html(view.render().el);
    }
  });

})(jQuery);
var app = app || {};


(function($) {

  app.CreateChatroomView = Backbone.View.extend({

    el: $('#createChatroomContainer'),
    events: {
      'change #chatroomImageUpload': 'renderThumb',
      'attachImage #createChatroomForm': 'upload',
      'click #createChatroomBtn': 'submit',
    },

    initialize: function(options) {
      this.vent = options.vent;
      this.listenTo(this, "chatroomAvailability", this.renderChatroomAvailability, this);
    },

    render: function() {
      this.renderThumb();
    },

    renderThumb: function() {
      var input = this.$('#chatroomImageUpload');
      var img = this.$('#uploadedChatroomImage')[0];
      if(input.val() !== '') {
        var selected_file = input[0].files[0];
        var reader = new FileReader();
        reader.onload = (function(aImg) {
          return function(e) {
            aImg.src = e.target.result;
          };
        })(img);
        reader.readAsDataURL( selected_file );
      }

    },

    submit: function(e) {
      e.preventDefault();
      if (!this.$('#chatroom-name-input').hasClass('input-valid')) {
        swal({
          title: "OH NO OH NO OH NO",
          text: "Chatroom Already, It Already Exists! And. Don't Go In There. Don't. You. Those Poor . . . I Threw Up In My Hat! OH NO. WHY. OH NO. OH NO.",
          imageUrl: '/img/scuba-pig.png',
          confirmButtonColor: "#749CA8"
        });
      } else {
        this.$form = this.$('#createChatroomForm');
        this.$form.trigger('attachImage');
      }
    },

    upload: function() {
      var _this = this;
      var formData = new FormData(this.$form[0]);
      if (this.$('#chatroomImageUpload')[0].files.length > 0) {
        $.ajax({
          type: 'POST',
          url: '/api/uploadChatroomImage',
          data: formData,
          cache: false,
          dataType: 'json',
          processData: false,
          contentType: false,
          error: function( xhr ) {
            swal({
              title: "OH NO OH NO OH NO",
              text: "Your image. It uh, won't fit. 'Too big. It needs to be less than 500 Kb,' the computer monkeys say. 'And .jpeg, .png, or .gif file'.",
              imageUrl: '/img/scuba-pig.png',
              confirmButtonColor: "#749CA8"
            });
          },
          success: function( response ) {
            console.log('imgUpload response: ', response);
            var form = _this.createRoomFormData();
            response.name = form.name;
            response.privacy = form.privacy;
              _this.vent.trigger('createRoom', response);
            $('#createChatroomModal').modal('hide');
            _this.clearField();
          }
        });
      } else {
        var form = _this.createRoomFormData();
       this.vent.trigger('createRoom', form);
      }
      return false;
    },


    createRoomFormData: function() {
      var formData = {};
      formData.roomImage = '/img/chjat-icon1.png';
      this.$('#createChatroomForm').find( 'input' ).each(function(i, el) {
        if ($(el).prop('type') === "button") {

        } else if ($(el).data('create') === 'privacy') {
          var val = $(el).prop('checked');
          formData['privacy'] = val;
        } else if ($(el).val() !== '') {
          formData[$(el).data('create')] = $(el).val();
          $(el).val('');
        }
      });
      return formData;

    },

    clearField: function() {
      this.$('#uploadedChatroomImage')[0].src = '';
      this.$('#chatroomImageUpload').val('');
    },

    renderChatroomAvailability: function(availability) {
      this.$('.room-name-validation').removeClass('input-valid input-invalid');
      this.$('.room-name-validation-message').children().remove();
      if (availability === true) {
        this.$('.room-name-validation').addClass('input-valid');
        this.$('.room-name-validation-message').append('<div id="#chatroom-name-validation" class="fa fa-check">Name Available</div>');
      } else {
        this.$('.room-name-validation').addClass('input-invalid fa fa-times');
        this.$('.room-name-validation-message').append('<div id="#chatroom-name-validation" class="fa fa-times">Name Unavailable</div>');
      }
      setTimeout(function() {
        this.$('.room-name-validation-message').children().fadeOut(600, function(){
          $(this).children().remove();
        });
      }, 2000);
    }

  });

})(jQuery);
var app = app || {};


(function($) {

  app.ChatImageUploadView = Backbone.View.extend({

    el: $('#chatImageUploadContainer'),
  
    events: {
      'change #chatImageUpload': 'renderThumb',
      'attachImage #chatImageUploadForm': 'upload',
      'click #addChatImageBtn': 'submit',
    },


    render: function() {
      this.renderThumb();
    },

    renderThumb: function() {
      var input = this.$('#chatImageUpload');
      var img = this.$('#uploadedChatImage')[0];
      if(input.val() !== '') {
        var selected_file = input[0].files[0];
        var reader = new FileReader();
        reader.onload = (function(aImg) {
          return function(e) {
            aImg.src = e.target.result;
          };
        })(img);
        reader.readAsDataURL( selected_file );
      }
    },

    submit: function(e) {
      e.preventDefault();
      this.$form = this.$('#chatImageUploadForm');
      this.$form.trigger('attachImage');
    },

    upload: function() {
      var _this = this;
        var formData = new FormData(this.$form[0]);
      if (this.$('#chatImageUpload')[0].files.length > 0) {
        $.ajax({
          type: 'POST',
          url: '/api/uploadChatImage',
          data: formData,
          cache: false,
          dataType: 'json',
          processData: false,
          contentType: false,
          error: function( xhr ) {
            swal({
              title: "OH NO OH NO OH NO",
              text: "Your image. It uh, won't fit. 'Too big. It needs to be less than 500 Kb,' the computer monkeys say. 'And .jpeg, .png, or .gif file'.",
              type: "error",
              imageUrl: '/img/scuba-pig.png',
              confirmButtonColor: "#749CA8",
            });
          },
          success: function( response ) {
            console.log('imgUpload response: ', response);
            _this.$el.data('chat-type') === 'chat' ?
              _this.trigger('chat-image-uploaded', response) :
              _this.trigger('message-image-uploaded', response);
            console.log('imgUpload path ', response.path);
            $('#chatImageUploadModal').modal('hide');
            _this.clearField();
          }
        });
      } else {
       this.trigger('image-uploaded');
      }
      return false;
    },


    clearField: function() {
      this.$('#uploadedChatImage')[0].src = '';
      this.$('#chatImageUpload').val('');
    }

  });

})(jQuery);
var app = app || {};

(function ($) {

  app.LoginView = Backbone.View.extend({
    template: _.template($('#login').html()),
    errorTemplate: _.template('<div class="login-error"><%= message %></div>'),
    events: {
      'submit': 'submit',
      'keyup': 'onHitEnter'
    },
    initialize: function(options) {
    // LoginView gets passed the viewEventBus when the MainController is initialized
      this.vent = options.vent;

    // This tells the view to listen to an event on its model,
    // if there's an error, the callback (this.render) is called with the  
    // view as context
      this.listenTo(this.model, "change:error", this.render, this);
    },
    render: function() {
      this.$el.html(this.template(this.model.toJSON()));
      return this;
    },
    submit: function(e) {
      e.preventDefault();
      this.onLogin();
    },
    onHitEnter: function(e) {
      if(e.keyCode == 13) {
        this.onLogin();
        return false;
      }
    },
    onLogin: function() {
      // triggers the login event and passing the username data to js/main.js
      var this_ = this;
      var sendData = {username: this.$('#emailOrUsername').val(), password: this.$('#password').val()};
      $.ajax({
        url: "/login",
        method: 'POST',
        data: sendData,
        success: function(data) {
          console.log('success data: ', data);
          if (data.message) {
            this_.renderValidation(this_.errorTemplate(data));
          } else if (data._id) {
            app.ChatroomRouter.navigate('auth', { trigger: true });
            this_.vent.trigger("login", data);
          } else {
            console.log('oops, the else: ', data);
          }
        }
      });
    },
    renderValidation: function(what) {
      $('.login-error-container').empty();
      $(what).appendTo($('.login-error-container')).hide().fadeIn();
      setTimeout(function() {
        $('.login-error-container').children().first().fadeOut();
      }, 2000);
    },
    
  });
  
})(jQuery);
var app = app || {};

(function ($) {

  app.NavbarView = Backbone.View.extend({
    el: '.login-menu',
    template: _.template($('#navbar-template').html()),
    invitationTemplate: _.template($('#invitation-template').html()),
    events: {
      'click .delete-invitation': 'deleteInvitation',
      'click .accept-invitation': 'acceptInvitation',
      'change #user-preferences-image-upload': 'renderThumb',
      'attachImage #user-preferences-form': 'upload',
      'click #user-preferences-btn': 'submit',
      'keyup #user-preferences-home-room-input': 'doesHomeRoomExist',
      'click .logout': 'logout',
    },

    logout: function() {
       $.ajax({
          type: 'POST',
          url: '/logout',
          processData: false,
          contentType: false,
          error: function( xhr ) {
            console.log('error: ', xhr );
          }
        });
    },

    initialize: function(options) {
      this.vent = options.vent;
      this.model = new app.UserModel({ username: '', userImage: '', homeRoom: '', invitations: new app.InvitationCollection() });
      this.listenTo(this.model, "change", this.render, this);

      var invitations = this.model.get('invitations');

      this.listenTo(invitations, "reset", this.renderInvitations, this);
      this.listenTo(this, "homeRoomAvailability", this.renderHomeRoomAvailability, this);

      this.render();
    },
    render: function() {
      this.$el.html(this.template(this.model.toJSON()));

      this.renderInvitations();
      this.setHomeRoomTyepahead();


      return this;
    },
    renderInvitations: function() {
      this.$('#invitations').empty();
      var invitations = this.model.get('invitations');
      var this_ = this;
      invitations.each(function(invite) {
        this_.renderInvitation(invite);
      }, this);
      if (invitations.length === 0) {
        this.$('.pink-fuzz').hide();
        this.$('#invitations').append("<div>You've got no invitations, like dang</div>");
      } else {
        this.$('.pink-fuzz').show();
      }
    },
    renderInvitation: function(model) {
      this.$('#invitations').append(this.invitationTemplate(model.toJSON()));
    },
    deleteInvitation: function(e) {
      var roomId = $(e.target).data('roomid');
      this.vent.trigger('deleteInvitation', roomId);
    },
    acceptInvitation: function(e) {
      var roomId = $(e.target).data('roomid');
      this.vent.trigger('acceptInvitation', roomId);
    },


    renderThumb: function() {
      var input = this.$('#user-preferences-image-upload');
      var img = this.$('#uploaded-user-preferences-image')[0];
      if(input.val() !== '') {
        var selected_file = input[0].files[0];
        var reader = new FileReader();
        reader.onload = (function(aImg) {
          return function(e) {
            aImg.src = e.target.result;
          };
        })(img);
        reader.readAsDataURL( selected_file );
      }
    },

    submit: function(e) {
      e.preventDefault();
      if (this.$('#user-preferences-home-room-input').hasClass('input-invalid')) {
        swal({
          title: "OH NO OH NO OH NO",
          text: "Chatroom Can't, It Doesn't Exist! And. I Don't Know. Should. You? I Mean How DO we. How do? How do now?",
          imageUrl: '/img/scuba-pig.png',
          confirmButtonColor: "#749CA8"
        });
      } else {
        this.$form = this.$('#user-preferences-form');
        this.$form.trigger('attachImage');
      }
    },

    upload: function() {
      var this_ = this;
      var formData = new FormData(this.$form[0]);
      if (this.$('#user-preferences-image-upload')[0].files.length > 0) {
        $.ajax({
          type: 'POST',
          url: '/updateUserImage',
          data: formData,
          cache: false,
          dataType: 'json',
          processData: false,
          contentType: false,
          error: function( xhr ) {
            swal({
              title: "OH NO OH NO OH NO",
              text: "Your image. It uh, won't fit. 'Too big' the computer monkeys say. Either that, or it's not a .jpeg, .png, or .gif. But what do I know, I'm just the guy staring at the computer screen behind you.",
              imageUrl: '/img/scuba-pig.png',
              confirmButtonColor: "#749CA8"
            });
          },
          success: function( response ) {
            console.log('imgUpload response: ', response);
            var form = this_.createUserFormData();
            form.userImage = response.userImage;
            this_.vent.trigger('updateUser', form);
            $('#user-preferences-modal').modal('hide');
            this_.clearField();
          }
        });
      } else {
        var form = this.createUserFormData();
        this.vent.trigger('updateUser', form);
      }
      return false;
    },

    createUserFormData: function() {
      var formData = {};
      this.$('#user-preferences-form').find( 'input' ).each(function(i, el) {
        if ($(el).data('create') === 'privacy') {
          var val = $(el).prop('checked');
          formData['privacy'] = val;
        } else if ($(el).val() !== '' && $(el).val() !== 'on') {
          formData[$(el).data('create')] = $(el).val();
          $(el).val('');
        }
      });
      delete formData.undefined;
      return formData;
    },

    clearField: function() {
      this.$('#uploaded-user-preferences-image')[0].src = '';
      this.$('#user-preferences-image-upload').val('');
    },

    setHomeRoomTyepahead: function() {
      var this_ = this;
      var blood = new Bloodhound({
        datumTokenizer: Bloodhound.tokenizers.obj.whitespace('name'),
        queryTokenizer: Bloodhound.tokenizers.whitespace,
        prefetch: {
          url: '/api/publicChatrooms',
          filter: function(data) {
             return _.map(data, function(chatroom) {
                return { name: chatroom };
             });
          },
          ttl_ms: 0,
        },
        remote: {
          url: '/api/searchChatrooms?name=%QUERY',
          wildcard: '%QUERY',
          rateLimitWait: 300,
        }
      });
      blood.clearPrefetchCache();
      blood.initialize();
      var type = this.$('#user-preferences-home-room-input').typeahead({
        minLength: 2,
        classNames: {
          input: 'typeahead-input',
          hint: 'typeahead-hint',
          selectable: 'typeahead-selectable',
          menu: 'typeahead-menu',
          highlight: 'typeahead-highlight',
          dataset: 'typeahead-dataset',
        },
      },
      {
        limit: 5,
        source: blood,
        name: 'home-room-search',
        display: 'name',
      }).on('typeahead:select typeahead:autocomplete', function(obj) {
        this_.doesHomeRoomExist();
      });
    },

    doesHomeRoomExist: function() {
      this.$('.room-name-validation').removeClass('input-valid input-invalid');
      var this_ = this;
      var check = function() {
        if ($.trim($('#user-preferences-home-room-input').val()).length > 0) {
          var chatroomName = $('#user-preferences-home-room-input').val();
          this_.vent.trigger('doesHomeRoomExist', chatroomName);
        } else {
         this_.$('#user-preferences-home-room-input').children().remove();
         this_.$('#user-preferences-home-room-input').removeClass('input-valid input-invalid');
       }
     };
     _.debounce(check(), 30);
   },

   renderHomeRoomAvailability: function(availability) {

    this.$('.room-name-validation').removeClass('input-valid input-invalid');
    this.$('.room-name-validation-message').children().remove();
    if (availability === false) {
      this.$('.room-name-validation').addClass('input-valid');
      this.$('.room-name-validation-message').append('<div id="#chatroom-name-validation" class="fa fa-check"></div>');
    } else {
      this.$('.room-name-validation').addClass('input-invalid fa fa-times');
      this.$('.room-name-validation-message').append('<div id="#chatroom-name-validation" class="fa fa-times">Chatroom Does Not Exist</div>');
    }
    setTimeout(function() {
      this.$('.room-name-validation-message').children().fadeOut(600, function(){
        $(this).children().remove();
      });
    }, 2000);
  },

  });

})(jQuery);
var app = app || {};

(function ($) {

  app.RegisterView = Backbone.View.extend({
    template: _.template($('#register').html()),
    invalidTemplate: _.template('<div class="user-info-invalid fa fa-times"><%= message %></div>'),
    validTemplate: _.template('<div class="user-info-valid fa fa-check"><%= message %></div>'),
    events: {
      "submit": "submit",
      "keyup #username": "validateUsername",
      "keyup #email": "validateEmail",
      "keyup #retypePassword": "validatePassword",
    },
    initialize: function(options) {
      this.render();
      this.vent = options.vent;
    },
    submit: function(e) {
      e.preventDefault();
      var passwordValidation = this.validatePassword();
      if (passwordValidation) {
        this.signUp();
      } else {

      }
    },
    helpers: function() {
      this.instructions();
    },
    instructions: function() {
      $('input').on('focus', function(e) {
         $(this).parent().find("label[for="+e.target.name+"]").fadeIn(400);
      });
      $('input').on('blur', function(e) {
         $(this).parent().find("label[for="+e.target.name+"]").fadeOut(400);
      });
    },
    render: function() {
      this.$el.html(this.template());
      return this;
    },
    signUp: function() {
      var this_ = this;
      var sendData = {
        username: this.$('#username').val(),
        password: this.$('#password').val(),
        name: this.$('#name').val(),
        email: this.$('#email').val()
      };
      $.ajax({
        url: "/register",
        method: 'POST',
        data: sendData,
        success: function(data) {
          if (data.message) {
            this_.renderValidation(this_.errorTemplate(data));
          } else if (data.user) {
            app.ChatroomRouter.navigate('auth', { trigger: true });
            this_.vent.trigger("login", data.user);
          } else {
            console.log('oops, the else: ', data);
          }
        }
      });
    },
    validateUsername: function() {
      if ($('#username').val().length < 5) { return; }
      var this_ = this;
      _.debounce($.post('/usernameValidation', { username: $('#username').val() },function(data) {
         data.usernameAvailable ?
           this_.renderValidation(this_.validTemplate({message: ' username available'}))
         :
           this_.renderValidation(this_.invalidTemplate({message: ' username taken'}));
      }), 150);
    },
    validateEmail: function() {
      if (!$('#email').val().match(/^\S+@\S+\.\S+$/)) { return; }
      var this_ = this;
      _.debounce($.post('/emailValidation', { email: $('#email').val() },function(data) {
         data.emailAvailable ?
           this_.renderValidation(this_.validTemplate({message: ' email available'}))
         :
           this_.renderValidation(this_.invalidTemplate({message: ' email taken'}));
      }), 150);
    },
    renderValidation: function(what) {
      $('.register-error-container').empty();
      $(what).appendTo($('.register-error-container')).hide().fadeIn();
      this.validationtimout = null;
      clearTimeout(this.validationTimeout);
      this.validationTimeout = setTimeout(function() {
        $('.register-error-container').children().first().fadeOut();
      }, 2000);
    },
    validatePassword: function() {
      if ($('#retypePassword').val().length > 5) {
        if ($('#password').val() !== $('#retypePassword').val()) {
          this.renderValidation(this.invalidTemplate({message: ' password does not match'}));
          return false;
        } else {
          this.renderValidation(this.validTemplate({message: ' password match'}));
          return true;
        }
      }
    },

  });

})(jQuery);

// The ChatClient is implemented on main.js.
// The chatclient is a constructor function on the MainController.
// It both listens to and emits events on the socket, eg:
// It has its own methods that, when called, emit to the socket w/ data.
// It also sets response listeners on connection, these response listeners
// listen to the socket and trigger events on the appEventBus on the 
// MainController
var ChatClient = function(options) {

	var self = this;

	// is-typing helper variables
	var TYPING_TIMER_LENGTH = 400; // ms
  var typing = false;
  var lastTypingTime;
  
  // this vent holds the appEventBus
	self.vent = options.vent;

	self.hostname = 'http://' + window.location.host;

  // connects to socket, sets response listeners
	self.connect = function() {
    console.log('sc.f.connect');
		// this io might be a little confusing... where is it coming from?
		// it's coming from the static middleware on server.js bc everything
		// in the /public folder has been attached to the server, and visa
		// versa.

    // local
      // self.socket = io.connect(self.hostname);

    // heroku
      self.socket = io.connect('http://www.chjat.com/', { transports: ['websocket'] } );

    self.setResponseListeners(self.socket);
  };



///// ViewEventBus methods ////
    // methods that emit to the chatserver

// LOGIN
  self.login = function(user) {
    console.log('sc.f.login: ', user);
    self.socket.emit("login", user);
  };
  self.logout = function() {
    console.log('sc.f.logout: ');
    self.socket.emit("logout");
  };


// ROOM
  self.connectToRoom = function(roomName) {
    console.log('sc.f.connectToRoom');
    self.socket.emit("connectToRoom", roomName);
  };
  self.joinRoom = function(roomName) {
    self.socket.emit('joinRoom', roomName);
  };
  self.addRoom = function(roomName) {
    console.log('sc.f.addRoom');
    self.socket.emit("addRoom", roomName);
  };
  self.removeRoom = function(roomData) {
    console.log('sc.f.removeRoom');
    self.socket.emit("removeRoom", roomData);
  };
  self.createRoom = function(formData) {
    console.log('sc.f.createRoom');
    self.socket.emit("createRoom", formData);
  };
  self.updateRoom = function(formData) {
    console.log('sc.f.updateRoom');
    self.socket.emit("updateRoom", formData);
  };
  self.destroyRoom = function(roomInfo) {
    console.log('sc.f.destroyRoom');
    self.socket.emit("destroyRoom", roomInfo);
  };


// CHAT
  self.chat = function(chat) {
    console.log('sc.f.chat: ', chat);
		self.socket.emit("chat", chat);
	};
  self.getMoreChats = function(chatReq) {
    self.socket.emit('getMoreChats', chatReq);
  };


// DIRECT MESSAGE
  self.initDirectMessage = function(recipient) {
    self.socket.emit('initDirectMessage', recipient);
  };
  self.directMessage = function(directMessage) {
    self.socket.emit('directMessage', directMessage);
  };
  self.getMoreDirectMessages = function(directMessageReq) {
    self.socket.emit('getMoreDirectMessages', directMessageReq);
  };
  

// TYPING
	self.addChatTyping = function(data) {
    var message = data.username + ' is typing';
    $('.typetypetype').text(message);
	};
	self.removeChatTyping = function() {
    $('.typetypetype').empty();
	};
  self.updateTyping = function() {
    if (self.socket) {
      if (!typing) {
        typing = true;
        self.socket.emit('typing');
      }
      lastTypingTime = (new Date()).getTime();
      setTimeout(function() {
        var typingTimer = (new Date()).getTime();
        var timeDiff = typingTimer - lastTypingTime;
        if (timeDiff >= TYPING_TIMER_LENGTH && typing) {
           self.socket.emit('stop typing');
           typing = false;
        }
      }, TYPING_TIMER_LENGTH);
    }
  };


// INVITATIONS
  self.inviteUser = function(invitationObj) {
    self.socket.emit("inviteUser", invitationObj);
  };
  self.deleteInvitation = function(roomId) {
    self.socket.emit("deleteInvitation", roomId);
  };
  self.acceptInvitation = function(roomId) {
    self.socket.emit("acceptInvitation", roomId);
  };

// UPDATE USER
  self.updateUser = function(userObj) {
    self.socket.emit("updateUser", userObj);
  };


// ERROR HANDLING
  self.doesChatroomExist = function(chatroomQuery) {
    self.socket.emit('doesChatroomExist', chatroomQuery);
  };
  self.doesHomeRoomExist = function(homeRoomQuery) {
    self.socket.emit('doesHomeRoomExist', homeRoomQuery);
  };
  self.doesSearchChatroomExist = function(homeRoomQuery) {
    self.socket.emit('doesSearchChatroomExist', homeRoomQuery);
  };


  




  ////////////// chatserver listeners/////////////

  // these guys listen to the chatserver/socket and emit data to main.js,
  // specifically to the appEventBus.
	self.setResponseListeners = function(socket) {


// LOGIN
    socket.on('initUser', function(user) {
      console.log('sc.e.initUser');
      self.vent.trigger('initUser', user);
      self.connectToRoom(user.homeRoom);
    });


// CHAT
		socket.on('userJoined', function(user) {
			console.log('sc.e.userJoined');
			self.vent.trigger("userJoined", user);
		});
		socket.on('userLeft', function(user) {
			console.log('sc.e.userLeft');
			self.vent.trigger("userLeft", user);
		});
		socket.on('chat', function(chat) {
			console.log('sc.e.chat');
			self.vent.trigger("chatReceived", chat);
		});
    socket.on('moreChats', function(chats) {
      self.vent.trigger("moreChats", chats);
    });
    socket.on('noMoreChats', function() {
      self.vent.trigger("noMoreChats");
    });


// DIRECT MESSAGE
    socket.on('setDirectMessageChatlog', function(chatlog) {
      self.vent.trigger("setDMchatlog", chatlog);
    });
    socket.on('setDirectMessageHeader', function(header) {
      self.vent.trigger("setDMheader", header);
    });
    socket.on('directMessage', function(message) {
      self.vent.trigger("directMessageReceived", message);
    });



// TYPING
    socket.on('typing', function(data) {
      self.addChatTyping(data);
    });
    socket.on('stop typing', function() {
      self.removeChatTyping();
    });


// SET ROOM
    socket.on('chatlog', function(chatlog) {
      console.log('sc.e.chatlog');
      self.vent.trigger("setChatlog", chatlog);
    });
    socket.on('chatrooms', function(chatrooms) {
      console.log('sc.e.chatrooms');
      self.vent.trigger("setChatrooms", chatrooms);
    });
    socket.on('privateRooms', function(rooms) {
      console.log('sc.e.privateRooms');
      self.vent.trigger("setPrivateRooms", rooms);
    });
    socket.on('onlineUsers', function(onlineUsers) {
      console.log('sc.e.onlineUsers');
      self.vent.trigger("setOnlineUsers", onlineUsers);
    });
    socket.on('offlineUsers', function(offlineUsers) {
      console.log('sc.e.offlineUsers');
      self.vent.trigger("setOfflineUsers", offlineUsers);
    });
    socket.on('chatroomHeader', function(headerObj) {
      console.log('sc.e.chatroomHeader');
      self.vent.trigger("setChatroomHeader", headerObj);
    });


// REDIRECT TO HOME ROOM
    socket.on('redirectToHomeRoom', function(data) {
      console.log('sc.e.redirectToHomeRoom');
      self.vent.trigger("redirectToHomeRoom", data);
    });

// ROOM AVAILABILITY
    socket.on('chatroomAvailability', function(availabilty) {
      self.vent.trigger('chatroomAvailability', availabilty);
    });
    socket.on('homeRoomAvailability', function(availabilty) {
      self.vent.trigger('homeRoomAvailability', availabilty);
    });
    socket.on('chatroomExists', function(availabilty) {
      self.vent.trigger('chatroomExists', availabilty);
    });

// ERROR HANDLING
    socket.on('chatroomAlreadyExists', function() {
      self.vent.trigger("chatroomAlreadyExists");
    });

    socket.on('destroyRoomResponse', function(res) {
      self.vent.trigger("destroyRoomResponse", res);
    });

// INVITATIONS
    socket.on('refreshInvitations', function(invitations) {
      self.vent.trigger("refreshInvitations", invitations);
    });
    socket.on('userInvited', function(user) {
      self.vent.trigger("userInvited", user);
    });

// LOGOUT
    socket.on('logout', function() {
      self.logout();
    });


	};
};


app.MainController = function() {

	var self = this;


  //These allows us to bind and trigger on the object from anywhere in the app.
  self.appEventBus = _.extend({}, Backbone.Events);
  self.viewEventBus = _.extend({}, Backbone.Events);

  self.init = function() {

    // loginModel
    self.loginModel = new app.LoginModel();
    self.loginView = new app.LoginView({vent: self.viewEventBus, model: self.loginModel});
    self.registerView = new app.RegisterView({vent: self.viewEventBus });
    self.navbarView = new app.NavbarView({vent: self.viewEventBus});

    // The ContainerModel gets passed a viewState, LoginView, which
    // is the login page. That LoginView gets passed the viewEventBus
    // and the LoginModel.
    self.containerModel = new app.ContainerModel({ viewState: self.loginView});

    // next, a new ContainerView is intialized with the newly created containerModel
    // the login page is then rendered.
    self.containerView = new app.ContainerView({ model: self.containerModel });
    self.containerView.render();

    $('form').keypress(function(e) {
      return e.keyCode != 13;
    });


  };


  self.authenticated = function() {
    console.log('f.main.authenticated');
    
    $("body").css("overflow", "hidden");
    $('form').keypress(function(e) {
      return e.keyCode != 13;
    });

    self.chatClient = new ChatClient({ vent: self.appEventBus });
    self.chatClient.connect();

    // new model and view created for chatroom
    self.chatroomModel = new app.ChatroomModel({ name: 'Chjat' });
    self.chatroomList = new app.ChatroomList();
    self.privateRoomCollection = new app.PrivateRoomCollection();
    self.chatroomModel.set('chatrooms', self.chatroomList);
    self.chatroomModel.set('privateRooms', self.privateRoomCollection);
    self.chatroomView  = new app.ChatroomView({vent: self.viewEventBus, model: self.chatroomModel });
    self.containerModel.set('viewState', self.chatroomView);
    $('body').on('hidden.bs.modal', '.modal', function () {
      $(this).removeData('bs.modal');
    });
  };






  ////////////  Busses ////////////
    // These Busses listen to the socketclient
   //    ---------------------------------



  //// viewEventBus Listeners /////
  
  self.viewEventBus.on("login", function(user) {
    self.chatClient.login(user);
  });
  self.viewEventBus.on("chat", function(chat) {
    self.chatClient.chat(chat);
  });
  self.viewEventBus.on("typing", function() {
    self.chatClient.updateTyping();
  });
  self.viewEventBus.on("joinRoom", function(roomName) {
    self.chatClient.joinRoom(roomName);
  });
  self.viewEventBus.on("addRoom", function(room) {
    self.chatClient.addRoom(room);
  });
  self.viewEventBus.on("removeRoom", function(roomData) {
    self.chatClient.removeRoom(roomData);
  });
  self.viewEventBus.on("createRoom", function(formData) {
    self.chatClient.createRoom(formData);
  });
  self.viewEventBus.on("updateRoom", function(formData) {
    self.chatClient.updateRoom(formData);
  });
  self.viewEventBus.on("destroyRoom", function(roomInfo) {
    self.chatClient.destroyRoom(roomInfo);
  });
  self.viewEventBus.on("getMoreChats", function(chatReq) {
    self.chatClient.getMoreChats(chatReq);
  });
  self.viewEventBus.on("initDirectMessage", function(recipient) {
    self.chatClient.initDirectMessage(recipient);
  });
  self.viewEventBus.on("directMessage", function(directMessage) {
    self.chatClient.directMessage(directMessage);
  });
  self.viewEventBus.on("getMoreDirectMessages", function(directMessageReq) {
    self.chatClient.getMoreDirectMessages(directMessageReq);
  });
  self.viewEventBus.on("inviteUser", function(invitationObj) {
    self.chatClient.inviteUser(invitationObj);
  });
  self.viewEventBus.on("deleteInvitation", function(roomId) {
    self.chatClient.deleteInvitation(roomId);
  });
  self.viewEventBus.on("acceptInvitation", function(roomId) {
    self.chatClient.acceptInvitation(roomId);
  });
  self.viewEventBus.on("updateUser", function(userObj) {
    self.chatClient.updateUser(userObj);
  });
  self.viewEventBus.on("logout", function() {
    self.chatClient.logout();
  });


// ERROR HANDLING
self.viewEventBus.on("doesChatroomExist", function(chatroomQuery) {
  self.chatClient.doesChatroomExist(chatroomQuery);
});
self.viewEventBus.on("doesHomeRoomExist", function(chatroomQuery) {
  self.chatClient.doesHomeRoomExist(chatroomQuery);
});
self.viewEventBus.on("doesSearchChatroomExist", function(chatroomQuery) {
  self.chatClient.doesSearchChatroomExist(chatroomQuery);
});







  //// appEventBus Listeners ////


// Navbar
self.appEventBus.on("initUser", function(user) {
  console.log('main.e.initUser: ', user);
  invitations = self.navbarView.model.get('invitations');
  newInvitations = _.map(user.invitations, function(invite) {
   var newInvitation = new app.InvitationModel(invite);
   return newInvitation;
 });
  invitations.reset(newInvitations);
  self.navbarView.model.set({ 'username': user.username, 'homeRoom': user.homeRoom, 'userImage': user.userImage });
});

self.appEventBus.on("refreshInvitations", function(invitations) {
  console.log('main.e.refreshInvitations');
  oldInvitations = self.navbarView.model.get('invitations');
  newInvitations = _.map(invitations, function(invite) {
   var newInvitation = new app.InvitationModel(invite);
   return newInvitation;
 });
  oldInvitations.reset(newInvitations);
});


// CHATROOM CONTAINER
self.appEventBus.on("ChatroomModel", function(model) {
  console.log('main.e.ChatroomModel');
  self.chatroomModel = new app.ChatroomModel();
  self.chatroomList = new app.ChatroomList();
  self.chatroomView  = new app.ChatroomView({vent: self.viewEventBus, model: self.chatroomModel, collection: self.chatroomList});
  self.containerModel.set('viewState', self.chatroomView);
  self.chatroomModel.loadModel(model);
});


// SET CHATROOM
self.appEventBus.on("setChatroomHeader", function(headerObj) {
  var newHeader = new app.ChatroomHeaderModel(headerObj);
  self.chatroomModel.set('chatroom', newHeader);
});
self.appEventBus.on("setChatlog", function(chatlog) {
  var oldChatlog = self.chatroomModel.get('chatlog');
  var updatedChatlog = _.map(chatlog, function(chat) {
    var newChatModel = new app.ChatModel({ room: chat.room, message: chat.message, sender: chat.sender, timestamp: chat.timestamp, url: chat.url });
    return newChatModel;
  });
  oldChatlog.reset(updatedChatlog);
  $('#message-input').removeClass('direct-message-input').addClass('message-input');
  $('#chatbox-content')[0].scrollTop = $('#chatbox-content')[0].scrollHeight;
});
self.appEventBus.on("setChatrooms", function(rooms) {
  var oldRooms = self.chatroomModel.get('chatrooms');
  var newRooms = _.map(rooms, function(room) {
    var newChatroomModel = new app.ChatroomModel({ id: room._id, name: room.name, owner: room.owner, roomImage: room.roomImage, privacy: room.privacy});
    return newChatroomModel;
  });
  oldRooms.reset(newRooms);
});
self.appEventBus.on("setPrivateRooms", function(rooms) {
  var oldRooms = self.chatroomModel.get('privateRooms');
  var newRooms = _.map(rooms, function(room) {
    var newChatroomModel = new app.ChatroomModel({ id: room._id, name: room.name, owner: room.owner, roomImage: room.roomImage, privacy: room.privacy, currentUser: room.currentUser});
    return newChatroomModel;
  });
  oldRooms.reset(newRooms);
});
self.appEventBus.on("setOnlineUsers", function(onlineUsers) {
  var oldOnlineUsers = self.chatroomModel.get('onlineUsers');
  var updatedOnlineUsers = _.map(onlineUsers, function(user) {
    var newUserModel = new app.UserModel({username: user.username, userImage: user.userImage});
    return newUserModel;
  });
  oldOnlineUsers.reset(updatedOnlineUsers);
});
self.appEventBus.on("setOfflineUsers", function(offlineUsers) {
  var oldOfflineUsers = self.chatroomModel.get('offlineUsers');
  var updatedOfflineUsers = _.map(offlineUsers, function(user) {
    var newUserModel = new app.UserModel({username: user.username, userImage: user.userImage});
    return newUserModel;
  });
  oldOfflineUsers.reset(updatedOfflineUsers);
});



// USER JOIN/LEAVE CHATROOM
  // adds new user to users collection, sends default joining message
  self.appEventBus.on("userJoined", function(user) {
    console.log('main.e.userJoined');
    self.chatroomModel.addUser(user);
    self.chatroomModel.addChat({sender: "Chatroom Pig", message: user.username + " joined room." });
  });
	// removes user from users collection, sends default leaving message
	self.appEventBus.on("userLeft", function(user) {
    console.log('main.e.userLeft');
    self.chatroomModel.removeUser(user);
    self.chatroomModel.addChat({sender: "Chatroom Pig", message: user.username + " left room." });
  });


// CHATROOM MESSAGING
	// chat passed from socketclient, adds a new chat message using chatroomModel method
	self.appEventBus.on("chatReceived", function(chat) {
    self.chatroomModel.addChat(chat);
    $('#chatbox-content')[0].scrollTop = $('#chatbox-content')[0].scrollHeight;
  });
  self.appEventBus.on("moreChats", function(chatlog) {
    var oldChatlog = self.chatroomModel.get('chatlog');
    var moreChatlog = _.map(chatlog, function(chat) {
      var newChatModel = new app.ChatModel({ room: chat.room, message: chat.message, sender: chat.sender, timestamp: chat.timestamp, url: chat.url });
      return newChatModel;
    });
    self.chatroomModel.trigger('moreChats', moreChatlog);
  });
  self.appEventBus.on("noMoreChats", function(chatlog) {
    self.chatroomModel.stopListening('moreChats');
  });


// SET DIRECT MESSAGE
self.appEventBus.on("setDMchatlog", function(chatlog) {
  var oldChatlog = self.chatroomModel.get('chatlog');
  var updatedChatlog = _.map(chatlog, function(chat) {
    var newChatModel = new app.ChatModel({ room: chat.room, message: chat.message, sender: chat.sender, timestamp: chat.timestamp, url: chat.url });
    return newChatModel;
  });
  oldChatlog.reset(updatedChatlog);
  $('#message-input').removeClass('message-input').addClass('direct-message-input');
  $('#chatImageUploadContainer').data('chat-type', 'message');
  $('#chatbox-content')[0].scrollTop = $('#chatbox-content')[0].scrollHeight;
});
self.appEventBus.on("setDMheader", function(header) {
  var newHeader = new app.ChatroomHeaderModel(header);
  self.chatroomModel.set('chatroom', newHeader);
});


// DIRECT MESSAGING
self.appEventBus.on("directMessageReceived", function(message) {
  self.chatroomModel.addChat(message);
  $('#chatbox-content')[0].scrollTop = $('#chatbox-content')[0].scrollHeight;
});



// CHATROOM AVAILABILITY
self.appEventBus.on("chatroomAvailability", function(availability) {
  self.chatroomModel.trigger('chatroomAvailability', availability);
});
self.appEventBus.on("homeRoomAvailability", function(availability) {
  self.navbarView.trigger('homeRoomAvailability', availability);
});
self.appEventBus.on("chatroomExists", function(availability) {
  self.chatroomModel.trigger('chatroomExists', availability);
});


// CHATROOM INVITATION
self.appEventBus.on("userInvited", function(user) {
  console.log('main.e.userInvited');
  self.chatroomModel.trigger('userInvited', user);
});


// REDIRECT
self.appEventBus.on("redirectToHomeRoom", function(data) {
  self.chatClient.connectToRoom(data.homeRoom);
});


// ERROR HANDLING
self.appEventBus.on("chatroomAlreadyExists", function() {
  swal({
    title: "OH NO OH NO OH NO",
    text: "Chatroom Already, It Already Exists! And. Don't Go In There. Don't. You. You Should Have. I Threw Up On The Server. Those Poor . . . They Were Just! OH NO WHY. WHY OH NO. OH NO.",
    type: "error",
    confirmButtonColor: "#749CA8"
  });
});
self.appEventBus.on("destroyRoomResponse", function(res) {
  if (res.error) {
    swal({
      title: "No Touchy!",
      text: "You Can't Delete Your Home Room, Nuh Uh. Who are you, Franz Reichelt?",
      type: "error",
      confirmButtonColor: "#749CA8",
    });
  }
  if (res.success) {
    swal({
      title: "Eviscerated!",
      text: "Your chatroom has been purged.",
      type: "success",
      confirmButtonColor: "#749CA8",
    });
  }
});









};

var app = app || {};

(function () {

  // $(window).bind('beforeunload', function(eventObject) {
  //   $.ajax({
  //      url: "/logout",
  //   });
  // });

  var ChatroomRouter = Backbone.Router.extend({
    
    routes: {
      '': 'start',
      'log': 'login',
      'reg': 'register',
      'out': 'out',
      'auth': 'authenticated',
      'facebook': 'facebook',
      'twitter': 'twitter'
    },

    start: function(callback) {
      window.location.href = '/#';
      this.initMainController();
      if (callback) {
        callback();
      } 
      // else {
      //   $.ajax({
      //     url: "/logout",
      //   });
      // }
    },


    login: function() {
      if (!app.mainController) {
        this.initMainController();
      }
      var loginModel = new app.LoginModel();
      var loginView = new app.LoginView({vent: app.mainController.viewEventBus, model: loginModel});
      app.mainController.containerModel.set("viewState", loginView);
    },

    register: function() {
      if (!app.mainController) {
        this.initMainController();
      }
      var registerView = new app.RegisterView({vent: app.mainController.viewEventBus });
      app.mainController.containerModel.set("viewState", registerView);
      registerView.helpers();
    },

    authenticated: function() {
      if (!app.mainController) {
        this.start();
      } else {
        app.mainController.authenticated();
      }
        
    },
    facebook: function() {
      this.start(this.authenticated);
    },
    twitter: function() {
      this.start(this.authenticated);
    },

    initMainController: function() {
      app.mainController = new app.MainController();
      app.mainController.init();
    },

  });

  app.ChatroomRouter = new ChatroomRouter();
  Backbone.history.start();

})();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNoYXQuanMiLCJjaGF0cm9vbS1oZWFkZXIuanMiLCJjb250YWluZXIuanMiLCJsb2dpbi5qcyIsInVzZXIuanMiLCJjaGF0cm9vbS5qcyIsImludml0YXRpb24uanMiLCJyb29tLmpzIiwicHJpdmF0ZVJvb20uanMiLCJjaGF0cm9vbVNldHRpbmdzLmpzIiwiY3JlYXRlQ2hhdHJvb20uanMiLCJjcmVhdGVDaGF0cm9vbUltYWdlLmpzIiwibmF2YmFyLmpzIiwicmVnaXN0ZXIuanMiLCJzb2NrZXRjbGllbnQuanMiLCJtYWluLmpzIiwicm91dGVyLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNQQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDUEE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ1BBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDWkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBSlBBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FJVEE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ1BBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUMzQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNUQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ1RBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBRlJBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FEVEE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUlsbEJBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FQN0xBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FRZkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDdElBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBUnRGQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QVNqRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDbFBBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUM3R0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUN0U0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDcFdBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EiLCJmaWxlIjoibWFpbi5qcyIsInNvdXJjZXNDb250ZW50IjpbIlxudmFyIGFwcCA9IGFwcCB8fCB7fTtcblxuKGZ1bmN0aW9uICgpIHtcblxuICBhcHAuQ2hhdENvbGxlY3Rpb24gPSBCYWNrYm9uZS5Db2xsZWN0aW9uLmV4dGVuZCh7XG4gICAgbW9kZWw6IGFwcC5DaGF0TW9kZWxcbiAgfSk7XG5cbn0pKCk7IiwiXG52YXIgYXBwID0gYXBwIHx8IHt9O1xuXG4oZnVuY3Rpb24gKCkge1xuXG4gIGFwcC5DaGF0cm9vbUhlYWRlck1vZGVsID0gQmFja2JvbmUuTW9kZWwuZXh0ZW5kKHt9KTtcblxufSkoKTsiLCJ2YXIgYXBwID0gYXBwIHx8IHt9O1xuXG4oZnVuY3Rpb24gKCQpIHtcblxuICBhcHAuQ29udGFpbmVyVmlldyA9IEJhY2tib25lLlZpZXcuZXh0ZW5kKHtcbiAgICBlbDogJyN2aWV3LWNvbnRhaW5lcicsXG4gICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24ob3B0aW9ucykge1xuICAgICAgdGhpcy5tb2RlbC5vbihcImNoYW5nZTp2aWV3U3RhdGVcIiwgdGhpcy5yZW5kZXIsIHRoaXMpO1xuICAgIH0sXG4gICAgcmVuZGVyOiBmdW5jdGlvbigpIHtcbiAgICAgIHZhciB2aWV3ID0gdGhpcy5tb2RlbC5nZXQoJ3ZpZXdTdGF0ZScpO1xuICAgICAgdGhpcy4kZWwuaHRtbCh2aWV3LnJlbmRlcigpLmVsKTtcbiAgICB9XG4gIH0pO1xuXG59KShqUXVlcnkpOyIsInZhciBhcHAgPSBhcHAgfHwge307XG5cbihmdW5jdGlvbiAoJCkge1xuXG4gIGFwcC5Mb2dpblZpZXcgPSBCYWNrYm9uZS5WaWV3LmV4dGVuZCh7XG4gICAgdGVtcGxhdGU6IF8udGVtcGxhdGUoJCgnI2xvZ2luJykuaHRtbCgpKSxcbiAgICBlcnJvclRlbXBsYXRlOiBfLnRlbXBsYXRlKCc8ZGl2IGNsYXNzPVwibG9naW4tZXJyb3JcIj48JT0gbWVzc2FnZSAlPjwvZGl2PicpLFxuICAgIGV2ZW50czoge1xuICAgICAgJ3N1Ym1pdCc6ICdzdWJtaXQnLFxuICAgICAgJ2tleXVwJzogJ29uSGl0RW50ZXInXG4gICAgfSxcbiAgICBpbml0aWFsaXplOiBmdW5jdGlvbihvcHRpb25zKSB7XG4gICAgLy8gTG9naW5WaWV3IGdldHMgcGFzc2VkIHRoZSB2aWV3RXZlbnRCdXMgd2hlbiB0aGUgTWFpbkNvbnRyb2xsZXIgaXMgaW5pdGlhbGl6ZWRcbiAgICAgIHRoaXMudmVudCA9IG9wdGlvbnMudmVudDtcblxuICAgIC8vIFRoaXMgdGVsbHMgdGhlIHZpZXcgdG8gbGlzdGVuIHRvIGFuIGV2ZW50IG9uIGl0cyBtb2RlbCxcbiAgICAvLyBpZiB0aGVyZSdzIGFuIGVycm9yLCB0aGUgY2FsbGJhY2sgKHRoaXMucmVuZGVyKSBpcyBjYWxsZWQgd2l0aCB0aGUgIFxuICAgIC8vIHZpZXcgYXMgY29udGV4dFxuICAgICAgdGhpcy5saXN0ZW5Ubyh0aGlzLm1vZGVsLCBcImNoYW5nZTplcnJvclwiLCB0aGlzLnJlbmRlciwgdGhpcyk7XG4gICAgfSxcbiAgICByZW5kZXI6IGZ1bmN0aW9uKCkge1xuICAgICAgdGhpcy4kZWwuaHRtbCh0aGlzLnRlbXBsYXRlKHRoaXMubW9kZWwudG9KU09OKCkpKTtcbiAgICAgIHJldHVybiB0aGlzO1xuICAgIH0sXG4gICAgc3VibWl0OiBmdW5jdGlvbihlKSB7XG4gICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICB0aGlzLm9uTG9naW4oKTtcbiAgICB9LFxuICAgIG9uSGl0RW50ZXI6IGZ1bmN0aW9uKGUpIHtcbiAgICAgIGlmKGUua2V5Q29kZSA9PSAxMykge1xuICAgICAgICB0aGlzLm9uTG9naW4oKTtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfVxuICAgIH0sXG4gICAgb25Mb2dpbjogZnVuY3Rpb24oKSB7XG4gICAgICAvLyB0cmlnZ2VycyB0aGUgbG9naW4gZXZlbnQgYW5kIHBhc3NpbmcgdGhlIHVzZXJuYW1lIGRhdGEgdG8ganMvbWFpbi5qc1xuICAgICAgdmFyIHRoaXNfID0gdGhpcztcbiAgICAgIHZhciBzZW5kRGF0YSA9IHt1c2VybmFtZTogdGhpcy4kKCcjZW1haWxPclVzZXJuYW1lJykudmFsKCksIHBhc3N3b3JkOiB0aGlzLiQoJyNwYXNzd29yZCcpLnZhbCgpfTtcbiAgICAgICQuYWpheCh7XG4gICAgICAgIHVybDogXCIvbG9naW5cIixcbiAgICAgICAgbWV0aG9kOiAnUE9TVCcsXG4gICAgICAgIGRhdGE6IHNlbmREYXRhLFxuICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbihkYXRhKSB7XG4gICAgICAgICAgY29uc29sZS5sb2coJ3N1Y2Nlc3MgZGF0YTogJywgZGF0YSk7XG4gICAgICAgICAgaWYgKGRhdGEubWVzc2FnZSkge1xuICAgICAgICAgICAgdGhpc18ucmVuZGVyVmFsaWRhdGlvbih0aGlzXy5lcnJvclRlbXBsYXRlKGRhdGEpKTtcbiAgICAgICAgICB9IGVsc2UgaWYgKGRhdGEuX2lkKSB7XG4gICAgICAgICAgICBhcHAuQ2hhdHJvb21Sb3V0ZXIubmF2aWdhdGUoJ2F1dGgnLCB7IHRyaWdnZXI6IHRydWUgfSk7XG4gICAgICAgICAgICB0aGlzXy52ZW50LnRyaWdnZXIoXCJsb2dpblwiLCBkYXRhKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY29uc29sZS5sb2coJ29vcHMsIHRoZSBlbHNlOiAnLCBkYXRhKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH0sXG4gICAgcmVuZGVyVmFsaWRhdGlvbjogZnVuY3Rpb24od2hhdCkge1xuICAgICAgJCgnLmxvZ2luLWVycm9yLWNvbnRhaW5lcicpLmVtcHR5KCk7XG4gICAgICAkKHdoYXQpLmFwcGVuZFRvKCQoJy5sb2dpbi1lcnJvci1jb250YWluZXInKSkuaGlkZSgpLmZhZGVJbigpO1xuICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHtcbiAgICAgICAgJCgnLmxvZ2luLWVycm9yLWNvbnRhaW5lcicpLmNoaWxkcmVuKCkuZmlyc3QoKS5mYWRlT3V0KCk7XG4gICAgICB9LCAyMDAwKTtcbiAgICB9LFxuICAgIFxuICB9KTtcbiAgXG59KShqUXVlcnkpOyIsIlxudmFyIGFwcCA9IGFwcCB8fCB7fTtcblxuKGZ1bmN0aW9uICgpIHtcblxuICBhcHAuVXNlckNvbGxlY3Rpb24gPSBCYWNrYm9uZS5Db2xsZWN0aW9uLmV4dGVuZCh7bW9kZWw6IGFwcC5Vc2VyTW9kZWx9KTtcblxufSkoKTsiLCJ2YXIgYXBwID0gYXBwIHx8IHt9O1xuXG4oZnVuY3Rpb24gKCQpIHtcblxuYXBwLkNoYXRyb29tVmlldyA9IEJhY2tib25lLlZpZXcuZXh0ZW5kKHtcbiAgdGVtcGxhdGU6IF8udGVtcGxhdGUoJCgnI2NoYXRyb29tLXRlbXBsYXRlJykuaHRtbCgpKSxcbiAgY2hhdFRlbXBsYXRlOiBfLnRlbXBsYXRlKCQoJyNjaGF0Ym94LW1lc3NhZ2UtdGVtcGxhdGUnKS5odG1sKCkpLFxuICByb29tVGVtcGxhdGU6IF8udGVtcGxhdGUoJChcIiNyb29tLWxpc3QtdGVtcGxhdGVcIikuaHRtbCgpKSxcbiAgaGVhZGVyVGVtcGxhdGU6IF8udGVtcGxhdGUoJCgnI2NoYXRyb29tLWhlYWRlci10ZW1wbGF0ZScpLmh0bWwoKSksXG4gIGRpcmVjdE1lc3NhZ2VIZWFkZXJUZW1wbGF0ZTogXy50ZW1wbGF0ZSgkKCcjZGlyZWN0LW1lc3NhZ2UtaGVhZGVyLXRlbXBsYXRlJykuaHRtbCgpKSxcbiAgb25saW5lVXNlclRlbXBsYXRlOiBfLnRlbXBsYXRlKCQoJyNvbmxpbmUtdXNlcnMtbGlzdC10ZW1wbGF0ZScpLmh0bWwoKSksXG4gIG9mZmxpbmVVc2VyVGVtcGxhdGU6IF8udGVtcGxhdGUoJCgnI29mZmxpbmUtdXNlcnMtbGlzdC10ZW1wbGF0ZScpLmh0bWwoKSksXG4gIGRhdGVUZW1wbGF0ZTogXy50ZW1wbGF0ZSgnPGRpdiBjbGFzcz1cImZvbGxvd1dyYXBcIj48ZGl2IGNsYXNzPVwiZm9sbG93TWVCYXJcIj48c3Bhbj4gPCU9IG1vbWVudCh0aW1lc3RhbXApLmZvcm1hdChcIk1NTU0gRG9cIikgJT4gPC9zcGFuPjwvZGl2PjwvZGl2PicpLFxuICBldmVudHM6IHtcbiAgICAna2V5cHJlc3MgLm1lc3NhZ2UtaW5wdXQnOiAnbWVzc2FnZUlucHV0UHJlc3NlZCcsXG4gICAgJ2tleXByZXNzIC5kaXJlY3QtbWVzc2FnZS1pbnB1dCc6ICdkaXJlY3RNZXNzYWdlSW5wdXRQcmVzc2VkJyxcbiAgICAnY2xpY2sgLmNoYXQtZGlyZWN0b3J5IC5yb29tJzogJ3NldFJvb20nLFxuICAgICdrZXl1cCAjY2hhdC1zZWFyY2gtaW5wdXQnOiAnc2VhcmNoVmFsaWRhdGlvbicsXG4gICAgJ2NsaWNrIC5yZW1vdmUtY2hhdHJvb20nOiAncmVtb3ZlUm9vbScsXG4gICAgJ2NsaWNrIC5kZXN0cm95LWNoYXRyb29tJzogJ2Rlc3Ryb3lSb29tJyxcbiAgICAnY2xpY2sgLmRlc3Ryb3ktdGhpcy1wYXJ0aWN1bGFyLWNoYXRyb29tJzogJ2Rlc3Ryb3lUaGlzUGFydGljdWxhclJvb20nLFxuICAgICdrZXl1cCAjY2hhdHJvb20tbmFtZS1pbnB1dCc6ICdkb2VzQ2hhdHJvb21FeGlzdCcsXG4gICAgJ2NsaWNrIC51c2VyJzogJ2luaXREaXJlY3RNZXNzYWdlJyxcbiAgfSxcblxuXG4gIGRvZXNDaGF0cm9vbUV4aXN0OiBmdW5jdGlvbihlKSB7XG4gICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgIHZhciB0aGlzXyA9IHRoaXM7XG4gICAgdmFyIGNoZWNrID0gZnVuY3Rpb24oKSB7XG4gICAgICBpZiAoJC50cmltKCQoJyNjaGF0cm9vbS1uYW1lLWlucHV0JykudmFsKCkpLmxlbmd0aCA+IDApIHtcbiAgICAgICAgdmFyIGNoYXRyb29tTmFtZSA9ICQoJyNjaGF0cm9vbS1uYW1lLWlucHV0JykudmFsKCk7XG4gICAgICAgICB0aGlzXy52ZW50LnRyaWdnZXIoJ2RvZXNDaGF0cm9vbUV4aXN0JywgY2hhdHJvb21OYW1lKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgICB0aGlzXy4kKCcjY2hhdHJvb20tbmFtZS12YWxpZGF0aW9uLWNvbnRhaW5lcicpLmNoaWxkcmVuKCkucmVtb3ZlKCk7XG4gICAgICAgICB0aGlzXy4kKCcjY2hhdHJvb20tbmFtZS1pbnB1dCcpLnJlbW92ZUNsYXNzKCdpbnB1dC12YWxpZCBpbnB1dC1pbnZhbGlkJyk7XG4gICAgICB9XG4gICAgfTtcbiAgICBfLmRlYm91bmNlKGNoZWNrKCksIDE1MCk7XG4gIH0sXG5cbiAgcmVuZGVyQ2hhdHJvb21BdmFpbGFiaWxpdHk6IGZ1bmN0aW9uKGF2YWlsYWJpbGl0eSkge1xuICAgIHRoaXMuY3JlYXRlQ2hhdHJvb21WaWV3LnRyaWdnZXIoJ2NoYXRyb29tQXZhaWxhYmlsaXR5JywgYXZhaWxhYmlsaXR5KTtcbiAgfSxcblxuXG5cbiAgaW5pdGlhbGl6ZTogZnVuY3Rpb24ob3B0aW9ucykge1xuICAgIGNvbnNvbGUubG9nKCdjaGF0cm9vbVZpZXcuZi5pbml0aWFsaXplOiAnLCBvcHRpb25zKTtcbiAgICAvLyBwYXNzZWQgdGhlIHZpZXdFdmVudEJ1c1xuICAgIHZhciBzZWxmID0gdGhpcztcbiAgICB0aGlzLnZlbnQgPSBvcHRpb25zLnZlbnQ7XG4gIH0sXG4gIHJlbmRlcjogZnVuY3Rpb24obW9kZWwpIHtcbiAgICBjb25zb2xlLmxvZygnY3J2LmYucmVuZGVyJyk7XG4gICAgdGhpcy5tb2RlbCA9IG1vZGVsIHx8IHRoaXMubW9kZWw7XG4gICAgdGhpcy4kZWwuaHRtbCh0aGlzLnRlbXBsYXRlKHRoaXMubW9kZWwudG9KU09OKCkpKTtcbiAgICB0aGlzLmFmdGVyUmVuZGVyKCk7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH0sXG4gIGFmdGVyUmVuZGVyOiBmdW5jdGlvbigpIHtcbiAgICB0aGlzLnNldFN1YlZpZXdzKCk7XG4gICAgdGhpcy5zZXRDaGF0TGlzdGVuZXJzKCk7XG4gICAgdGhpcy5jaGF0cm9vbVNlYXJjaFR5cGVhaGVhZCgpO1xuICB9LFxuICBzZXRTdWJWaWV3czogZnVuY3Rpb24oKSB7XG4gICAgdGhpcy5jaGF0SW1hZ2VVcGxvYWRWaWV3ID0gbmV3IGFwcC5DaGF0SW1hZ2VVcGxvYWRWaWV3KCk7XG4gICAgdGhpcy5jaGF0SW1hZ2VVcGxvYWRWaWV3LnNldEVsZW1lbnQodGhpcy4kKCcjY2hhdEltYWdlVXBsb2FkQ29udGFpbmVyJykpO1xuICAgIHRoaXMuY3JlYXRlQ2hhdHJvb21WaWV3ID0gbmV3IGFwcC5DcmVhdGVDaGF0cm9vbVZpZXcoe3ZlbnQ6IHRoaXMudmVudH0pO1xuICAgIHRoaXMuY3JlYXRlQ2hhdHJvb21WaWV3LnNldEVsZW1lbnQodGhpcy4kKCcjY3JlYXRlQ2hhdHJvb21Db250YWluZXInKSk7XG4gIH0sXG4gIHNldENoYXRMaXN0ZW5lcnM6IGZ1bmN0aW9uKCkge1xuXG4gICAgdmFyIG9ubGluZVVzZXJzID0gdGhpcy5tb2RlbC5nZXQoJ29ubGluZVVzZXJzJyk7XG4gICAgdGhpcy5saXN0ZW5UbyhvbmxpbmVVc2VycywgXCJhZGRcIiwgdGhpcy5yZW5kZXJVc2VyLCB0aGlzKTtcbiAgICB0aGlzLmxpc3RlblRvKG9ubGluZVVzZXJzLCBcInJlbW92ZVwiLCB0aGlzLnJlbmRlclVzZXJzLCB0aGlzKTtcbiAgICB0aGlzLmxpc3RlblRvKG9ubGluZVVzZXJzLCBcInJlc2V0XCIsIHRoaXMucmVuZGVyVXNlcnMsIHRoaXMpO1xuXG4gICAgdmFyIG9mZmxpbmVVc2VycyA9IHRoaXMubW9kZWwuZ2V0KCdvZmZsaW5lVXNlcnMnKTtcbiAgICB0aGlzLmxpc3RlblRvKG9mZmxpbmVVc2VycywgXCJhZGRcIiwgdGhpcy5yZW5kZXJPZmZsaW5lVXNlciwgdGhpcyk7XG4gICAgdGhpcy5saXN0ZW5UbyhvZmZsaW5lVXNlcnMsIFwicmVtb3ZlXCIsIHRoaXMucmVuZGVyT2ZmbGluZVVzZXJzLCB0aGlzKTtcbiAgICB0aGlzLmxpc3RlblRvKG9mZmxpbmVVc2VycywgXCJyZXNldFwiLCB0aGlzLnJlbmRlck9mZmxpbmVVc2VycywgdGhpcyk7XG5cbiAgICB2YXIgY2hhdGxvZyA9IHRoaXMubW9kZWwuZ2V0KCdjaGF0bG9nJyk7XG4gICAgdGhpcy5saXN0ZW5UbyhjaGF0bG9nLCBcImFkZFwiLCB0aGlzLnJlbmRlckNoYXQsIHRoaXMpO1xuICAgIHRoaXMubGlzdGVuVG8oY2hhdGxvZywgXCJyZW1vdmVcIiwgdGhpcy5yZW5kZXJDaGF0cywgdGhpcyk7XG4gICAgdGhpcy5saXN0ZW5UbyhjaGF0bG9nLCBcInJlc2V0XCIsIHRoaXMucmVuZGVyQ2hhdHMsIHRoaXMpO1xuXG4gICAgdmFyIGNoYXRyb29tcyA9IHRoaXMubW9kZWwuZ2V0KCdjaGF0cm9vbXMnKTtcbiAgICB0aGlzLmxpc3RlblRvKGNoYXRyb29tcywgXCJhZGRcIiwgdGhpcy5yZW5kZXJSb29tLCB0aGlzKTtcbiAgICB0aGlzLmxpc3RlblRvKGNoYXRyb29tcywgXCJyZW1vdmVcIiwgdGhpcy5yZW5kZXJSb29tcywgdGhpcyk7XG4gICAgdGhpcy5saXN0ZW5UbyhjaGF0cm9vbXMsIFwicmVzZXRcIiwgdGhpcy5yZW5kZXJSb29tcywgdGhpcyk7XG5cbiAgICB2YXIgcHJpdmF0ZVJvb21zID0gdGhpcy5tb2RlbC5nZXQoJ3ByaXZhdGVSb29tcycpO1xuICAgIHRoaXMubGlzdGVuVG8ocHJpdmF0ZVJvb21zLCBcImFkZFwiLCB0aGlzLnJlbmRlclByaXZhdGVSb29tLCB0aGlzKTtcbiAgICB0aGlzLmxpc3RlblRvKHByaXZhdGVSb29tcywgXCJyZW1vdmVcIiwgdGhpcy5yZW5kZXJQcml2YXRlUm9vbXMsIHRoaXMpO1xuICAgIHRoaXMubGlzdGVuVG8ocHJpdmF0ZVJvb21zLCBcInJlc2V0XCIsIHRoaXMucmVuZGVyUHJpdmF0ZVJvb21zLCB0aGlzKTtcblxuICAgIHRoaXMubGlzdGVuVG8odGhpcy5tb2RlbCwgXCJjaGFuZ2U6Y2hhdHJvb21cIiwgdGhpcy5yZW5kZXJIZWFkZXIsIHRoaXMpO1xuXG4gICAgdGhpcy5saXN0ZW5Ubyh0aGlzLmNoYXRJbWFnZVVwbG9hZFZpZXcsICdjaGF0LWltYWdlLXVwbG9hZGVkJywgdGhpcy5jaGF0VXBsb2FkSW1hZ2UpO1xuICAgIHRoaXMubGlzdGVuVG8odGhpcy5jaGF0SW1hZ2VVcGxvYWRWaWV3LCAnbWVzc2FnZS1pbWFnZS11cGxvYWRlZCcsIHRoaXMubWVzc2FnZVVwbG9hZEltYWdlKTtcblxuICAgIHRoaXMubGlzdGVuVG8odGhpcy5tb2RlbCwgXCJtb3JlQ2hhdHNcIiwgdGhpcy5yZW5kZXJNb3JlQ2hhdHMsIHRoaXMpO1xuXG4gICAgdGhpcy5saXN0ZW5Ubyh0aGlzLm1vZGVsLCBcInVzZXJJbnZpdGVkXCIsIHRoaXMudXNlckludml0ZWQsIHRoaXMpO1xuXG4gICAgdGhpcy5saXN0ZW5Ubyh0aGlzLm1vZGVsLCBcImNoYXRyb29tRXhpc3RzXCIsIHRoaXMuY2hhdHJvb21FeGlzdHMsIHRoaXMpO1xuICAgIHRoaXMubGlzdGVuVG8odGhpcy5tb2RlbCwgXCJjaGF0cm9vbUF2YWlsYWJpbGl0eVwiLCB0aGlzLnJlbmRlckNoYXRyb29tQXZhaWxhYmlsaXR5LCB0aGlzKTtcbiAgICB0aGlzLmxpc3RlblRvKHRoaXMubW9kZWwsIFwiaG9tZVJvb21BdmFpbGFiaWxpdHlcIiwgdGhpcy5yZW5kZXJIb21lUm9vbUF2YWlsYWJpbGl0eSwgdGhpcyk7XG5cbiAgICB2YXIgdGhpc18gPSB0aGlzO1xuICAgIHRoaXMuJCgnI2NoYXRib3gtY29udGVudCcpLnNjcm9sbChmdW5jdGlvbigpe1xuICAgICAgICAvLyBjaGVja3MgaWYgdGhlcmUncyBlbm91Z2ggY2hhdHMgdG8gd2FycmFudCBhIGdldE1vcmVDaGF0cyBjYWxsXG4gICAgICBpZiAoJCgnI2NoYXRib3gtY29udGVudCcpLnNjcm9sbFRvcCgpID09PSAwICYmIHRoaXNfLm1vZGVsLmdldCgnY2hhdGxvZycpLmxlbmd0aCA+PSAyNSkge1xuICAgICAgICBpZiAodGhpc18ubW9kZWwuZ2V0KCdjaGF0cm9vbScpLmdldCgnY2hhdFR5cGUnKSA9PT0gJ21lc3NhZ2UnKSB7XG4gICAgICAgICAgXy5kZWJvdW5jZSh0aGlzXy5nZXRNb3JlRGlyZWN0TWVzc2FnZXMoKSwgMzAwMCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgXy5kZWJvdW5jZSh0aGlzXy5nZXRNb3JlQ2hhdHMoKSwgMzAwMCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KTtcblxuICAgICQod2luZG93KS5yZXNpemUoZnVuY3Rpb24oKSB7XG4gICAgICB2YXIgd2luZG93SGVpZ2h0ID0gJCh3aW5kb3cpLmhlaWdodCgpO1xuICAgICAgaWYgKHdpbmRvd0hlaWdodCA+IDUwMCkge1xuICAgICAgICB2YXIgbmV3SGVpZ2h0ID0gd2luZG93SGVpZ2h0IC0gMjg1O1xuICAgICAgICAkKCcjY2hhdGJveC1jb250ZW50JykuaGVpZ2h0KG5ld0hlaWdodCk7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgfSxcblxuICB3ZWxjb21lOiBfLm9uY2UoZnVuY3Rpb24oKSB7XG4gICAgaWYgKHRoaXMubW9kZWwuZ2V0KCdjaGF0cm9vbXMnKS5sZW5ndGggPT09IDAgJiZcbiAgICAgIHRoaXMubW9kZWwuZ2V0KFwicHJpdmF0ZVJvb21zXCIpLmxlbmd0aCA9PT0gMCkge1xuICAgICAgLy8gdGhpcy4kKCcjcHVibGljLXJvb21zJykuYXBwZW5kKCc8ZGl2IGNsYXNzPVwibm8tcm9vbXNcIj5XZWxjb21lIHRvIHRoZSBQYXJsb3IuIFRvIHN0YXJ0LCBqb2luIHRoaXMgcm9vbSBieSBzZWFyY2hpbmcgYW5kIHByZXNzaW5nIGVudGVyLiBUaGUgcm9vbSB3aWxsIGJlIHNhdmVkIHRvIHlvdXIgbGlzdCBvZiByb29tcy48L2Rpdj48ZGl2IGNsYXNzPVwibm8tcm9vbXNcIj5TZWFyY2ggb3IgY3JlYXRlIGNoYXRyb29tcyB5b25kZXIgPGkgY2xhc3M9XCJmYSBmYS1sb25nLWFycm93LXVwXCI+PC9pPjwvZGl2PicpO1xuICAgICAgc3dhbCh7XG4gICAgICAgIHRpdGxlOiBcIldlbGNvbWUgdG8gQ2hqYXRcIixcbiAgICAgICAgdGV4dDogXCJUbyBzdGFydCwgam9pbiB0aGUgQ2hqYXQgcm9vbSBieSBzZWFyY2hpbmcgYW5kIHByZXNzaW5nIGVudGVyLiBUaGUgcm9vbSB3aWxsIGJlIHNhdmVkIHRvIHlvdXIgbGlzdCBvZiByb29tcy4gT3IsIGlmIHlvdSdyZSBmZWVsaW5nIGFkdmVudHVyb3VzLCBzZWFyY2ggZm9yIGEgcHVibGljIHJvb20sIGpvaW4gaXQsIGNyZWF0ZSB5b3VyIG93biwgaW52aXRlIHlvdXIgZnJpZW5kcywgZW5lbWllcywgYXdrd2FyZCBhY3F1YWludGluY2VzLCBtYWtlIHlvdXIgcm9vbSBwcml2YXRlLCBnZXQgZG93biBhbmQgZGlydHksIHlvdSBrbm93IHdoYXQgSSBtZWFuLCBkaXNjdXNzIGRpcnR5IHRoaW5ncywgeW91IGtub3c/IFJvb3QgdmVnZXRhYmxlcy5cIixcbiAgICAgICAgLy8gdHlwZTogXCJpbmZvXCIsXG4gICAgICAgIC8vIHNob3dDYW5jZWxCdXR0b246IHRydWUsXG4gICAgICAgIGNvbmZpcm1CdXR0b25Db2xvcjogXCIjNzQ5Q0E4XCIsXG4gICAgICAgIGNvbmZpcm1CdXR0b25UZXh0OiBcIkJvb3BcIixcbiAgICAgICAgLy8gY2xvc2VPbkNvbmZpcm06IGZhbHNlLFxuICAgICAgICAvLyBodG1sOiBmYWxzZVxuICAgICAgICBpbWFnZVVybDogXCIvaW1nL2ZseS1waWctc2VyaW91cy1pY29uLnBuZ1wiLFxuICAgICAgfSk7XG4gICAgfVxuICB9KSxcblxuICBjaGF0cm9vbVNlYXJjaFR5cGVhaGVhZDogZnVuY3Rpb24oKSB7XG4gICAgLy8gaW50ZXJlc3RpbmcgLSB0aGUgJ3RoaXMnIG1ha2VzIGEgZGlmZmVyZW5jZSwgY2FuJ3QgZmluZCAjY2hhdC1zZWFyY2gtaW5wdXQgb3RoZXJ3aXNlXG4gICAgICB2YXIgdGhpc18gPSB0aGlzO1xuICAgICAgdmFyIGJsb29kID0gbmV3IEJsb29kaG91bmQoe1xuICAgICAgICBkYXR1bVRva2VuaXplcjogQmxvb2Rob3VuZC50b2tlbml6ZXJzLm9iai53aGl0ZXNwYWNlKCduYW1lJyksXG4gICAgICAgIHF1ZXJ5VG9rZW5pemVyOiBCbG9vZGhvdW5kLnRva2VuaXplcnMud2hpdGVzcGFjZSxcbiAgICAgICAgcHJlZmV0Y2g6IHtcbiAgICAgICAgICB1cmw6ICcvYXBpL3B1YmxpY0NoYXRyb29tcycsXG4gICAgICAgICAgZmlsdGVyOiBmdW5jdGlvbihkYXRhKSB7XG4gICAgICAgICAgICAgcmV0dXJuIF8ubWFwKGRhdGEsIGZ1bmN0aW9uKGNoYXRyb29tKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHsgbmFtZTogY2hhdHJvb20gfTtcbiAgICAgICAgICAgICB9KTtcbiAgICAgICAgICB9LFxuICAgICAgICAgIHR0bDogMCxcbiAgICAgICAgfSxcbiAgICAgICAgcmVtb3RlOiB7XG4gICAgICAgICAgdXJsOiAnL2FwaS9zZWFyY2hDaGF0cm9vbXM/bmFtZT0lUVVFUlknLFxuICAgICAgICAgIHdpbGRjYXJkOiAnJVFVRVJZJyxcbiAgICAgICAgICByYXRlTGltaXRXYWl0OiAzMDAsXG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgICAgYmxvb2QuY2xlYXJQcmVmZXRjaENhY2hlKCk7XG4gICAgICBibG9vZC5pbml0aWFsaXplKCk7XG4gICAgICB2YXIgdHlwZSA9ICB0aGlzLiQoJyNjaGF0LXNlYXJjaC1pbnB1dCcpLnR5cGVhaGVhZCh7XG4gICAgICAgIG1pbkxlbmd0aDogMixcbiAgICAgICAgY2xhc3NOYW1lczoge1xuICAgICAgICAgIGlucHV0OiAndHlwZWFoZWFkLWlucHV0JyxcbiAgICAgICAgICBoaW50OiAndHlwZWFoZWFkLWhpbnQnLFxuICAgICAgICAgIHNlbGVjdGFibGU6ICd0eXBlYWhlYWQtc2VsZWN0YWJsZScsXG4gICAgICAgICAgbWVudTogJ3R5cGVhaGVhZC1tZW51JyxcbiAgICAgICAgICBoaWdobGlnaHQ6ICd0eXBlYWhlYWQtaGlnaGxpZ2h0JyxcbiAgICAgICAgICBkYXRhc2V0OiAndHlwZWFoZWFkLWRhdGFzZXQnLFxuICAgICAgICB9LFxuICAgICAgfSxcbiAgICAgIHtcbiAgICAgICAgbGltaXQ6IDUsXG4gICAgICAgIHNvdXJjZTogYmxvb2QsXG4gICAgICAgIG5hbWU6ICdjaGF0cm9vbS1zZWFyY2gnLFxuICAgICAgICBkaXNwbGF5OiAnbmFtZScsXG4gICAgICB9KS5vbigndHlwZWFoZWFkOnNlbGVjdCB0eXBlYWhlYWQ6YXV0b2NvbXBsZXRlJywgZnVuY3Rpb24ob2JqKSB7XG4gICAgICAgICB2YXIgY2hhdHJvb21OYW1lID0gJCgnI2NoYXQtc2VhcmNoLWlucHV0JykudmFsKCk7XG4gICAgICAgICB0aGlzXy52ZW50LnRyaWdnZXIoJ2RvZXNTZWFyY2hDaGF0cm9vbUV4aXN0JywgY2hhdHJvb21OYW1lKTtcbiAgICAgIH0pO1xuICB9LFxuXG5cblxuLy8gaGVhZGVyc1xuXG4gIHJlbmRlckhlYWRlcjogZnVuY3Rpb24oKSB7XG4gICAgdGhpcy4kKCcjY2hhdGJveC1oZWFkZXInKS5odG1sKHRoaXMuaGVhZGVyVGVtcGxhdGUodGhpcy5tb2RlbC5nZXQoJ2NoYXRyb29tJykudG9KU09OKCkpKTtcbiAgICB0aGlzLmNoYXRyb29tU2V0dGluZ3NWaWV3ID0gbmV3IGFwcC5DaGF0cm9vbVNldHRpbmdzVmlldyh7dmVudDogdGhpcy52ZW50LCBtb2RlbDogdGhpcy5tb2RlbC5nZXQoJ2NoYXRyb29tJyl9KTtcbiAgICB0aGlzLmNoYXRyb29tU2V0dGluZ3NWaWV3LnNldEVsZW1lbnQodGhpcy4kKCcjY2hhdHJvb20taGVhZGVyLWNvbnRhaW5lcicpKTtcbiAgICB0aGlzLmxpc3RlblRvKHRoaXMuY2hhdHJvb21TZXR0aW5nc1ZpZXcsICd1cGRhdGVSb29tJywgdGhpcy51cGRhdGVSb29tKTtcbiAgfSxcblxuICByZW5kZXJEaXJlY3RNZXNzYWdlSGVhZGVyOiBmdW5jdGlvbigpIHtcbiAgICB0aGlzLiQoJyNjaGF0Ym94LWhlYWRlcicpLmh0bWwodGhpcy5kaXJlY3RNZXNzYWdlSGVhZGVyVGVtcGxhdGUodGhpcy5tb2RlbC5nZXQoJ2NoYXRyb29tJykudG9KU09OKCkpKTtcbiAgfSxcblxuICB1c2VySW52aXRlZDogZnVuY3Rpb24oZGF0YSkge1xuICAgIHRoaXMuY2hhdHJvb21TZXR0aW5nc1ZpZXcudHJpZ2dlcigndXNlckludml0ZWQnLCBkYXRhKTtcbiAgfSxcblxuXG5cblxuLy8gdXNlcnNcblxuICByZW5kZXJVc2VyczogZnVuY3Rpb24oKSB7XG4gICAgY29uc29sZS5sb2coJ2Nydi5mLnJlbmRlclVzZXJzJyk7XG4gICAgb25saW5lVXNlcnMgPSB0aGlzLm1vZGVsLmdldChcIm9ubGluZVVzZXJzXCIpO1xuICAgIHRoaXMuJCgnLm9ubGluZS11c2VycycpLmVtcHR5KCk7XG4gICAgdGhpcy5tb2RlbC5nZXQoXCJvbmxpbmVVc2Vyc1wiKS5lYWNoKGZ1bmN0aW9uICh1c2VyKSB7XG4gICAgICB0aGlzLnJlbmRlclVzZXIodXNlcik7XG4gICAgfSwgdGhpcyk7XG4gIH0sXG4gIHJlbmRlclVzZXI6IGZ1bmN0aW9uKG1vZGVsKSB7XG4gICAgdGhpcy4kKCcub25saW5lLXVzZXJzJykuYXBwZW5kKHRoaXMub25saW5lVXNlclRlbXBsYXRlKG1vZGVsLnRvSlNPTigpKSk7XG4gIH0sXG4gIHJlbmRlck9mZmxpbmVVc2VyczogZnVuY3Rpb24oKSB7XG4gICAgY29uc29sZS5sb2coJ2Nydi5mLnJlbmRlck9mZmxpbmVVc2VycycpO1xuICAgIHRoaXMuJCgnLm9mZmxpbmUtdXNlcnMnKS5lbXB0eSgpO1xuICAgIHRoaXMubW9kZWwuZ2V0KFwib2ZmbGluZVVzZXJzXCIpLmVhY2goZnVuY3Rpb24gKHVzZXIpIHtcbiAgICAgIHRoaXMucmVuZGVyT2ZmbGluZVVzZXIodXNlcik7XG4gICAgfSwgdGhpcyk7XG4gIH0sXG4gIHJlbmRlck9mZmxpbmVVc2VyOiBmdW5jdGlvbihtb2RlbCkge1xuICAgIHRoaXMuJCgnLm9mZmxpbmUtdXNlcnMnKS5hcHBlbmQodGhpcy5vZmZsaW5lVXNlclRlbXBsYXRlKG1vZGVsLnRvSlNPTigpKSk7XG4gIH0sXG5cblxuXG5cblxuLy8gY2hhdGxvZ1xuXG4gIHJlbmRlckNoYXRzOiBmdW5jdGlvbigpIHtcbiAgICBjb25zb2xlLmxvZygnY3J2LmYucmVuZGVyQ2hhdHMnKTtcbiAgICB2YXIgY2hhdGxvZyA9IHRoaXMubW9kZWwuZ2V0KFwiY2hhdGxvZ1wiKTtcbiAgICB0aGlzLiQoJyNjaGF0Ym94LWNvbnRlbnQnKS5lbXB0eSgpO1xuICAgIGNoYXRsb2cuZWFjaChmdW5jdGlvbihjaGF0KSB7XG4gICAgICB0aGlzLnJlbmRlckNoYXQoY2hhdCk7XG4gICAgfSwgdGhpcyk7XG4gICAgaWYgKCBjaGF0bG9nLmxlbmd0aCA9PT0gMCkge1xuICAgICAgY2hhdGxvZy5wdXNoKG5ldyBhcHAuQ2hhdE1vZGVsKHsgc2VuZGVyOiAnQ2hqYXQnLCBtZXNzYWdlOiBcIsKvXFxcXF8o44OEKV8vwq9cIiwgdGltZXN0YW1wOiBfLm5vdygpLCB1cmw6ICcnfSkpO1xuICAgIH1cbiAgICB0aGlzLmFmdGVyQ2hhdHNSZW5kZXIoKTtcbiAgfSxcblxuICByZW5kZXJDaGF0OiBmdW5jdGlvbihtb2RlbCkge1xuICAgIHRoaXMucmVuZGVyRGF0ZURpdmlkZXJzKG1vZGVsKTtcbiAgICB2YXIgY2hhdFRlbXBsYXRlID0gJCh0aGlzLmNoYXRUZW1wbGF0ZShtb2RlbC50b0pTT04oKSkpO1xuICAgIGNoYXRUZW1wbGF0ZS5hcHBlbmRUbyh0aGlzLiQoJyNjaGF0Ym94LWNvbnRlbnQnKSkuaGlkZSgpLmZhZGVJbigpLnNsaWRlRG93bigpO1xuICAgICQoJyNjaGF0Ym94LWNvbnRlbnQnKVswXS5zY3JvbGxUb3AgPSAkKCcjY2hhdGJveC1jb250ZW50JylbMF0uc2Nyb2xsSGVpZ2h0O1xuICB9LFxuXG4gIHJlbmRlckRhdGVEaXZpZGVyczogZnVuY3Rpb24obW9kZWwpIHtcbiAgICB0aGlzLmN1cnJlbnREYXRlID0gbW9tZW50KG1vZGVsLmdldCgndGltZXN0YW1wJykpLmZvcm1hdCgnZGRkZCwgTU1NTSBEbyBZWVlZJyk7XG4gICAgaWYgKCB0aGlzLmN1cnJlbnREYXRlICE9PSB0aGlzLnByZXZpb3VzRGF0ZSApIHtcbiAgICAgIHZhciBjdXJyZW50RGF0ZSA9ICQodGhpcy5kYXRlVGVtcGxhdGUobW9kZWwudG9KU09OKCkpKTtcbiAgICAgIGN1cnJlbnREYXRlLmFwcGVuZFRvKHRoaXMuJCgnI2NoYXRib3gtY29udGVudCcpKS5oaWRlKCkuZmFkZUluKCkuc2xpZGVEb3duKCk7XG4gICAgICB0aGlzLnByZXZpb3VzRGF0ZSA9IHRoaXMuY3VycmVudERhdGU7XG4gICAgfVxuICB9LFxuXG4gIGdldE1vcmVDaGF0czogZnVuY3Rpb24oKSB7XG4gICAgY29uc29sZS5sb2coJ2Nydi5mLmdldE1vcmVDaGF0cycpO1xuICAgIHZhciBjaGF0cm9vbSA9IHRoaXMubW9kZWwuZ2V0KCdjaGF0cm9vbScpLFxuICAgIG5hbWUgPSBjaGF0cm9vbS5nZXQoJ25hbWUnKSxcbiAgICBtb2RlbHNMb2FkZWRTdW0gPSBjaGF0cm9vbS5nZXQoJ21vZGVsc0xvYWRlZFN1bScpO1xuICAgIHZhciBjaGF0bG9nTGVuZ3RoID0gY2hhdHJvb20uZ2V0KCdjaGF0bG9nTGVuZ3RoJyk7XG4gICAgdGhpcy52ZW50LnRyaWdnZXIoJ2dldE1vcmVDaGF0cycsIHsgbmFtZTogbmFtZSwgbW9kZWxzTG9hZGVkU3VtOiBtb2RlbHNMb2FkZWRTdW0sIGNoYXRsb2dMZW5ndGg6IGNoYXRsb2dMZW5ndGh9KTtcbiAgICBjaGF0cm9vbS5zZXQoJ21vZGVsc0xvYWRlZFN1bScsIChtb2RlbHNMb2FkZWRTdW0gLSAxKSk7XG4gIH0sXG5cbiAgZ2V0TW9yZURpcmVjdE1lc3NhZ2VzOiBmdW5jdGlvbigpIHtcbiAgICBjb25zb2xlLmxvZygnY3J2LmYuZ2V0TW9yZURyaWVjdE1lc3NhZ2VzJyk7XG4gICAgdmFyIGNoYXRyb29tID0gdGhpcy5tb2RlbC5nZXQoJ2NoYXRyb29tJyksXG4gICAgaWQgPSBjaGF0cm9vbS5nZXQoJ2lkJyksXG4gICAgbW9kZWxzTG9hZGVkU3VtID0gY2hhdHJvb20uZ2V0KCdtb2RlbHNMb2FkZWRTdW0nKTtcbiAgICB2YXIgY2hhdGxvZ0xlbmd0aCA9IGNoYXRyb29tLmdldCgnY2hhdGxvZ0xlbmd0aCcpO1xuICAgIHRoaXMudmVudC50cmlnZ2VyKCdnZXRNb3JlRGlyZWN0TWVzc2FnZXMnLCB7IGlkOiBpZCwgbW9kZWxzTG9hZGVkU3VtOiBtb2RlbHNMb2FkZWRTdW0sIGNoYXRsb2dMZW5ndGg6IGNoYXRsb2dMZW5ndGh9KTtcbiAgICBjaGF0cm9vbS5zZXQoJ21vZGVsc0xvYWRlZFN1bScsIChtb2RlbHNMb2FkZWRTdW0gLSAxKSk7XG4gIH0sXG5cbiAgcmVuZGVyTW9yZUNoYXRzOiBmdW5jdGlvbihjaGF0cykge1xuICAgIGNvbnNvbGUubG9nKCdjcnYuZi5yZW5kZXJNb3JlQ2hhdHMnKTtcbiAgICB2YXIgdGhpc18gPSB0aGlzO1xuICAgIHZhciBvcmlnaW5hbEhlaWdodCA9ICQoJyNjaGF0Ym94LWNvbnRlbnQnKVswXS5zY3JvbGxIZWlnaHQ7XG4gICAgdGhpcy5tb3JlQ2hhdENvbGxlY3Rpb24gPSBbXTtcbiAgICBfLmVhY2goY2hhdHMsIGZ1bmN0aW9uKG1vZGVsKSB7XG4gICAgICB0aGlzXy5yZW5kZXJNb3JlRGF0ZURpdmlkZXJzKG1vZGVsKTtcbiAgICAgIHZhciBjaGF0VGVtcGxhdGUgPSAkKHRoaXMuY2hhdFRlbXBsYXRlKG1vZGVsLnRvSlNPTigpKSk7XG4gICAgICB0aGlzXy5tb3JlQ2hhdENvbGxlY3Rpb24ucHVzaChjaGF0VGVtcGxhdGUpO1xuICAgIH0sIHRoaXMpO1xuICAgIF8uZWFjaCh0aGlzLm1vcmVDaGF0Q29sbGVjdGlvbi5yZXZlcnNlKCksIGZ1bmN0aW9uKHRlbXBsYXRlKSB7XG4gICAgICB0ZW1wbGF0ZS5wcmVwZW5kVG8odGhpcy4kKCcjY2hhdGJveC1jb250ZW50JykpO1xuICAgIH0pO1xuXG4gICAgdGhpcy5kYXRlRGl2aWRlci5sb2FkKCQoXCIuZm9sbG93TWVCYXJcIikpO1xuICAgICQoJyNjaGF0Ym94LWNvbnRlbnQnKVswXS5zY3JvbGxUb3AgPSAkKCcjY2hhdGJveC1jb250ZW50JylbMF0uc2Nyb2xsSGVpZ2h0IC0gb3JpZ2luYWxIZWlnaHQ7XG4gIH0sXG5cbiAgcmVuZGVyTW9yZURhdGVEaXZpZGVyczogZnVuY3Rpb24obW9kZWwpIHtcbiAgICB0aGlzLmN1cnJlbnREYXRlID0gbW9tZW50KG1vZGVsLmF0dHJpYnV0ZXMudGltZXN0YW1wKS5mb3JtYXQoJ2RkZGQsIE1NTU0gRG8gWVlZWScpO1xuICAgIGlmICggdGhpcy5jdXJyZW50RGF0ZSAhPT0gdGhpcy5wcmV2aW91c0RhdGUgKSB7XG4gICAgICB2YXIgY3VycmVudERhdGUgPSAkKHRoaXMuZGF0ZVRlbXBsYXRlKG1vZGVsLnRvSlNPTigpKSk7XG4gICAgICB0aGlzLm1vcmVDaGF0Q29sbGVjdGlvbi5wdXNoKGN1cnJlbnREYXRlKTtcbiAgICAgIHRoaXMucHJldmlvdXNEYXRlID0gdGhpcy5jdXJyZW50RGF0ZTtcbiAgICB9XG4gIH0sXG5cbiAgYXV0b3NpemVyOiBmdW5jdGlvbigpIHtcbiAgICBhdXRvc2l6ZSgkKCcjbWVzc2FnZS1pbnB1dCcpKTtcbiAgfSxcbiAgXG4gIHNjcm9sbEJvdHRvbUluc3VyYW5jZTogZnVuY3Rpb24oKXtcbiAgICB2YXIgdGhpc18gPSB0aGlzO1xuICAgIHZhciBpbnRlcnZhbCA9IHNldEludGVydmFsKGZ1bmN0aW9uKCl7XG4gICAgICB0aGlzLiQoJyNjaGF0Ym94LWNvbnRlbnQnKVswXS5zY3JvbGxUb3AgPSB0aGlzLiQoJyNjaGF0Ym94LWNvbnRlbnQnKVswXS5zY3JvbGxIZWlnaHQ7XG4gICAgfSwgNTApO1xuICAgIHJldHVybiBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7XG4gICAgICBjbGVhckludGVydmFsKGludGVydmFsKTtcbiAgICB9LCA4MDApO1xuICB9LFxuXG4gIGFmdGVyQ2hhdHNSZW5kZXI6IGZ1bmN0aW9uKCkge1xuICAgIHRoaXMuYXV0b3NpemVyKCk7XG4gICAgdGhpcy5kYXRlRGl2aWRlci5sb2FkKCQoXCIuZm9sbG93TWVCYXJcIikpO1xuICAgIHRoaXMuc2Nyb2xsQm90dG9tSW5zdXJhbmNlKCk7XG4gIH0sXG5cblxuXG5cblxuLy8gcm9vbXNcblxuICBzZWFyY2hSb29tOiBmdW5jdGlvbigpIHtcbiAgICAgIHZhciBuYW1lID0gJCgnI2NoYXQtc2VhcmNoLWlucHV0JykudmFsKCk7XG4gICAgICB0aGlzLmFkZENoYXRyb29tKG5hbWUpO1xuICAgICAgJCgnI2NoYXQtc2VhcmNoLWlucHV0JykudmFsKCcnKTtcbiAgfSxcbiAgc2VhcmNoVmFsaWRhdGlvbjogZnVuY3Rpb24oZSkge1xuICAgIGlmIChlLmtleUNvZGUgPT09IDEzICYmICQudHJpbSgkKCcjY2hhdC1zZWFyY2gtaW5wdXQnKS52YWwoKSkubGVuZ3RoID4gMCAmJiAkKCcjY2hhdC1zZWFyY2gtaW5wdXQnKS5oYXNDbGFzcygnaW5wdXQtdmFsaWQnKSkge1xuICAgICAgdGhpcy5zZWFyY2hSb29tKCk7XG4gICAgfSBlbHNlIGlmICgkKCcjY2hhdC1zZWFyY2gtaW5wdXQnKS52YWwoKSA9PT0gJycpIHtcbiAgICAgICQoJyNjaGF0LXNlYXJjaC1pbnB1dCcpLnJlbW92ZUNsYXNzKCdpbnB1dC12YWxpZCBpbnB1dC1pbnZhbGlkJyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMudmVudC50cmlnZ2VyKCdkb2VzU2VhcmNoQ2hhdHJvb21FeGlzdCcsICQoJyNjaGF0LXNlYXJjaC1pbnB1dCcpLnZhbCgpKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXM7XG4gIH0sXG4gIGNoYXRyb29tRXhpc3RzOiBmdW5jdGlvbihhdmFpbGFiaWxpdHkpIHtcbiAgICAkKCcjY2hhdC1zZWFyY2gtaW5wdXQnKS5yZW1vdmVDbGFzcygnaW5wdXQtdmFsaWQgaW5wdXQtaW52YWxpZCcpO1xuICAgIGlmIChhdmFpbGFiaWxpdHkgPT09IGZhbHNlKSB7XG4gICAgICAkKCcjY2hhdC1zZWFyY2gtaW5wdXQnKS5hZGRDbGFzcygnaW5wdXQtdmFsaWQnKTtcbiAgICB9IGVsc2Uge1xuICAgICAgJCgnI2NoYXQtc2VhcmNoLWlucHV0JykuYWRkQ2xhc3MoJ2lucHV0LWludmFsaWQnKTtcbiAgICB9XG4gIH0sXG4gIGNyZWF0ZVJvb206IGZ1bmN0aW9uKGZvcm0pIHtcbiAgICB0aGlzLnZlbnQudHJpZ2dlcignY3JlYXRlUm9vbScsIGZvcm0pO1xuICB9LFxuICB1cGRhdGVSb29tOiBmdW5jdGlvbihmb3JtKSB7XG4gICAgdmFyIGlkID0gdGhpcy5tb2RlbC5nZXQoJ2NoYXRyb29tJykuZ2V0KCdpZCcpO1xuICAgIGZvcm0uaWQgPSBpZDtcbiAgICB0aGlzLnZlbnQudHJpZ2dlcigndXBkYXRlUm9vbScsIGZvcm0pO1xuICB9LFxuICBkZXN0cm95Um9vbTogZnVuY3Rpb24oZSkge1xuICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICB2YXIgcm9vbU5hbWUgPSB0aGlzLm1vZGVsLmdldCgnY2hhdHJvb20nKS5nZXQoJ25hbWUnKTtcbiAgICB2YXIgdGhpc18gPSB0aGlzO1xuICAgIHZhciBjb25maXJtYXRpb24gPSBzd2FsKHtcbiAgICAgIHRpdGxlOiBcIkRvIHlvdSB3aXNoIHRvIGRlc3Ryb3kgXCIgKyByb29tTmFtZSArIFwiP1wiLFxuICAgICAgdGV4dDogXCJUaGlzIGtpbGxzIHRoZSByb29tLlwiLFxuICAgICAgdHlwZTogXCJ3YXJuaW5nXCIsXG4gICAgICBzaG93Q2FuY2VsQnV0dG9uOiB0cnVlLFxuICAgICAgY29uZmlybUJ1dHRvbkNvbG9yOiBcIiNERUIwQjBcIixcbiAgICAgIGNvbmZpcm1CdXR0b25UZXh0OiBcIk11YWhhaGEhXCIsXG4gICAgICBjbG9zZU9uQ29uZmlybTogZmFsc2UsXG4gICAgICBodG1sOiBmYWxzZVxuICAgIH0sIGZ1bmN0aW9uKCl7XG4gICAgICB2YXIgcm9vbUlkID0gdGhpc18ubW9kZWwuZ2V0KCdjaGF0cm9vbScpLmlkO1xuICAgICAgdmFyIHVzZXJJblJvb20gPSB0cnVlO1xuICAgICAgdGhpc18udmVudC50cmlnZ2VyKCdkZXN0cm95Um9vbScsIHsgaWQ6IHJvb21JZCwgcm9vbU5hbWU6IHJvb21OYW1lLCB1c2VySW5Sb29tOiB1c2VySW5Sb29tIH0pO1xuICAgIH0pO1xuICB9LFxuICBkZXN0cm95VGhpc1BhcnRpY3VsYXJSb29tOiBmdW5jdGlvbihlKSB7XG4gICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgIHZhciByb29tTmFtZSA9ICQoZS50YXJnZXQpLmRhdGEoXCJyb29tLW5hbWVcIik7XG4gICAgdmFyIHRoaXNfID0gdGhpcztcbiAgICB2YXIgY29uZmlybWF0aW9uID0gc3dhbCh7XG4gICAgICB0aXRsZTogXCJEbyB5b3Ugd2lzaCB0byBkZXN0cm95IFwiICsgcm9vbU5hbWUgKyBcIj9cIixcbiAgICAgIHRleHQ6IFwiVGhpcyBraWxscyB0aGUgcm9vbS5cIixcbiAgICAgIHR5cGU6IFwid2FybmluZ1wiLFxuICAgICAgc2hvd0NhbmNlbEJ1dHRvbjogdHJ1ZSxcbiAgICAgIGNvbmZpcm1CdXR0b25Db2xvcjogXCIjREVCMEIwXCIsXG4gICAgICBjb25maXJtQnV0dG9uVGV4dDogXCJNdWFoYWhhIVwiLFxuICAgICAgY2xvc2VPbkNvbmZpcm06IGZhbHNlLFxuICAgICAgaHRtbDogZmFsc2VcbiAgICB9LCBmdW5jdGlvbigpe1xuICAgICAgdmFyIGN1cnJlbnRSb29tSWQgPSB0aGlzXy5tb2RlbC5nZXQoJ2NoYXRyb29tJykuaWQ7XG4gICAgICB2YXIgcm9vbUlkID0gJChlLnRhcmdldCkuZGF0YShcInJvb20taWRcIik7XG4gICAgICB2YXIgdXNlckluUm9vbSA9IGN1cnJlbnRSb29tSWQgPT09IHJvb21JZDtcbiAgICAgIHRoaXNfLnZlbnQudHJpZ2dlcignZGVzdHJveVJvb20nLCB7IGlkOiByb29tSWQsIHJvb21OYW1lOiByb29tTmFtZSwgdXNlckluUm9vbTogdXNlckluUm9vbSB9KTtcbiAgICB9KTtcbiAgfSxcbiAgYWRkQ2hhdHJvb206IGZ1bmN0aW9uKG5hbWUpIHtcbiAgICBjb25zb2xlLmxvZygnY3J2LmYuYWRkQ2hhdHJvb20nKTtcbiAgICB0aGlzLnZlbnQudHJpZ2dlcignYWRkUm9vbScsIG5hbWUpO1xuICB9LFxuICByZW1vdmVSb29tOiBmdW5jdGlvbihlKSB7XG4gICAgdmFyIHRoaXNfID0gdGhpcztcbiAgICB2YXIgY29uZmlybWF0aW9uID0gc3dhbCh7XG4gICAgICB0aXRsZTogXCJSZW1vdmUgVGhpcyBSb29tP1wiLFxuICAgICAgdGV4dDogXCJBcmUgeW91IHN1cmU/IEFyZSB5b3Ugc3VyZSB5b3UncmUgc3VyZT8gSG93IHN1cmUgY2FuIHlvdSBiZT9cIixcbiAgICAgIHR5cGU6IFwid2FybmluZ1wiLFxuICAgICAgc2hvd0NhbmNlbEJ1dHRvbjogdHJ1ZSxcbiAgICAgIGNvbmZpcm1CdXR0b25Db2xvcjogXCIjREVCMEIwXCIsXG4gICAgICBjb25maXJtQnV0dG9uVGV4dDogXCJNdWFoYWhhIVwiLFxuICAgICAgY2xvc2VPbkNvbmZpcm06IGZhbHNlLFxuICAgICAgaHRtbDogZmFsc2VcbiAgICB9LCBmdW5jdGlvbigpe1xuICAgICAgc3dhbCh7XG4gICAgICAgIHRpdGxlOiBcIlJlbW92ZWQhXCIsXG4gICAgICAgIHRleHQ6IFwiWW91IGFyZSBmcmVlIG9mIHRoaXMgY2hhdHJvb20uIEdvIG9uLCB5b3UncmUgZnJlZSBub3cuXCIsXG4gICAgICAgIHR5cGU6IFwic3VjY2Vzc1wiLFxuICAgICAgICBjb25maXJtQnV0dG9uQ29sb3I6IFwiIzc0OUNBOFwiXG4gICAgICB9KTtcbiAgICAgIHZhciBjdXJyZW50Um9vbUlkID0gdGhpc18ubW9kZWwuZ2V0KCdjaGF0cm9vbScpLmlkO1xuICAgICAgdmFyIHJvb21JZCA9ICQoZS50YXJnZXQpLmRhdGEoXCJyb29tLWlkXCIpO1xuICAgICAgdmFyIHJvb21OYW1lID0gJChlLnRhcmdldCkuZGF0YShcInJvb20tbmFtZVwiKTtcbiAgICAgIHZhciB1c2VySW5Sb29tID0gY3VycmVudFJvb21JZCA9PT0gcm9vbUlkO1xuICAgICAgdGhpc18udmVudC50cmlnZ2VyKCdyZW1vdmVSb29tJywge2lkOiByb29tSWQsIHJvb21OYW1lOiByb29tTmFtZSwgdXNlckluUm9vbTogdXNlckluUm9vbX0pO1xuICAgIH0pO1xuICB9LFxuICByZW5kZXJSb29tczogZnVuY3Rpb24oKSB7XG4gICAgY29uc29sZS5sb2coJ2Nydi5mLnJlbmRlclJvb21zJyk7XG4gICAgdGhpcy4kKCcjcHVibGljLXJvb21zJykuZW1wdHkoKTtcbiAgICB0aGlzLm1vZGVsLmdldCgnY2hhdHJvb21zJykuZWFjaChmdW5jdGlvbiAocm9vbSkge1xuICAgICAgdGhpcy5yZW5kZXJSb29tKHJvb20pO1xuICAgIH0sIHRoaXMpO1xuICAgIHRoaXMud2VsY29tZSgpO1xuICB9LFxuICByZW5kZXJSb29tOiBmdW5jdGlvbihtb2RlbCkge1xuICAgIHZhciBuYW1lMSA9IG1vZGVsLmdldCgnbmFtZScpLFxuICAgIG5hbWUyID0gdGhpcy5tb2RlbC5nZXQoJ2NoYXRyb29tJykuZ2V0KCduYW1lJyk7XG4gICAgdGhpcy4kKCcjcHVibGljLXJvb21zJykuYXBwZW5kKHRoaXMucm9vbVRlbXBsYXRlKG1vZGVsLnRvSlNPTigpKSk7XG4gICAgaWYgKG5hbWUxID09PSBuYW1lMikge1xuICAgICAgdGhpcy4kKCcjcHVibGljLXJvb21zJykuZmluZCgnLnJvb20tbmFtZScpLmxhc3QoKS5hZGRDbGFzcygnYWN0aXZlJykuZmFkZUluKCk7XG4gICAgfVxuICB9LFxuICByZW5kZXJQcml2YXRlUm9vbXM6IGZ1bmN0aW9uKCkge1xuICAgIGNvbnNvbGUubG9nKCdjcnYuZi5yZW5kZXJQcml2YXRlUm9vbXMnKTtcbiAgICB0aGlzLiQoJyNwcml2YXRlLXJvb21zJykuZW1wdHkoKTtcbiAgICB0aGlzLm1vZGVsLmdldCgncHJpdmF0ZVJvb21zJykuZWFjaChmdW5jdGlvbiAocm9vbSkge1xuICAgICAgdGhpcy5yZW5kZXJQcml2YXRlUm9vbShyb29tKTtcbiAgICB9LCB0aGlzKTtcbiAgfSxcbiAgcmVuZGVyUHJpdmF0ZVJvb206IGZ1bmN0aW9uKG1vZGVsKSB7XG4gICAgdmFyIG5hbWUxID0gbW9kZWwuZ2V0KCduYW1lJyksXG4gICAgbmFtZTIgPSB0aGlzLm1vZGVsLmdldCgnY2hhdHJvb20nKS5nZXQoJ25hbWUnKTtcbiAgICB0aGlzLiQoJyNwcml2YXRlLXJvb21zJykuYXBwZW5kKHRoaXMucm9vbVRlbXBsYXRlKG1vZGVsLnRvSlNPTigpKSk7XG4gICAgaWYgKG5hbWUxID09PSBuYW1lMikge1xuICAgICAgdGhpcy4kKCcjcHJpdmF0ZS1yb29tcycpLmZpbmQoJy5yb29tLW5hbWUnKS5sYXN0KCkuYWRkQ2xhc3MoJ2FjdGl2ZScpLmZhZGVJbigpO1xuICAgIH1cbiAgfSxcbiAgam9pblJvb206IGZ1bmN0aW9uKG9iaikge1xuICAgIGNvbnNvbGUubG9nKCdjcnYuZi5qb2luUm9vbScpO1xuICAgIHRoaXMuY3VycmVudERhdGUgPSAnJztcbiAgICB0aGlzLnByZXZpb3VzRGF0ZSA9ICcnO1xuICAgIHRoaXMudmVudC50cmlnZ2VyKCdqb2luUm9vbScsIG9iai5uYW1lKTtcbiAgfSxcbi8vIGNoYW5nZSB0byAnam9pbkRpcmVjdE1lc3NhZ2UnXG4gIGluaXREaXJlY3RNZXNzYWdlOiBmdW5jdGlvbihlKSB7XG4gICAgdmFyIHJlY2lwaWVudCA9IHt9LFxuICAgICR0YXIgPSAkKGUuY3VycmVudFRhcmdldCk7XG4gICAgcmVjaXBpZW50LnVzZXJuYW1lID0gJHRhci50ZXh0KCkudHJpbSgpO1xuICAgIHJlY2lwaWVudC51c2VySW1hZ2UgPSAkdGFyLmZpbmQoJ2ltZycpLmF0dHIoJ3NyYycpO1xuICAgIHRoaXMuY3VycmVudERhdGUgPSAnJztcbiAgICB0aGlzLnByZXZpb3VzRGF0ZSA9ICcnO1xuICAgIGlmICh0aGlzLm1vZGVsLmdldCgnY2hhdHJvb20nKS5nZXQoJ2N1cnJlbnRVc2VyJykgIT09IHJlY2lwaWVudC51c2VybmFtZSkge1xuICAgICAgdGhpcy52ZW50LnRyaWdnZXIoJ2luaXREaXJlY3RNZXNzYWdlJywgcmVjaXBpZW50KTtcbiAgICB9XG4gIH0sXG5cblxuXG5cblxuLy8gaW1hZ2UgdXBsb2FkXG5cbiAgY2hhdFVwbG9hZEltYWdlOiBmdW5jdGlvbihyZXNwb25zZSkge1xuICAgIHRoaXMudmVudC50cmlnZ2VyKFwiY2hhdFwiLCByZXNwb25zZSk7XG4gICAgdGhpcy5zY3JvbGxCb3R0b21JbnN1cmFuY2UoKTtcbiAgfSxcbiAgbWVzc2FnZVVwbG9hZEltYWdlOiBmdW5jdGlvbihyZXNwb25zZSkge1xuICAgIHRoaXMudmVudC50cmlnZ2VyKFwiZGlyZWN0TWVzc2FnZVwiLCByZXNwb25zZSk7XG4gICAgdGhpcy5zY3JvbGxCb3R0b21JbnN1cmFuY2UoKTtcbiAgfSxcblxuXG5cblxuXG4gIC8vZXZlbnRzXG5cbiAgbWVzc2FnZUlucHV0UHJlc3NlZDogZnVuY3Rpb24oZSkge1xuICAgIGlmIChlLmtleUNvZGUgPT09IDEzICYmICQudHJpbSgkKCcubWVzc2FnZS1pbnB1dCcpLnZhbCgpKS5sZW5ndGggPiAwKSB7XG4gICAgICAvLyBmdW4gZmFjdDogc2VwYXJhdGUgZXZlbnRzIHdpdGggYSBzcGFjZSBpbiB0cmlnZ2VyJ3MgZmlyc3QgYXJnIGFuZCB5b3VcbiAgICAgIC8vIGNhbiB0cmlnZ2VyIG11bHRpcGxlIGV2ZW50cy5cbiAgICAgIGlmIChlLnNoaWZ0S2V5IHx8IGUuY3RybEtleSkge1xuICAgICAgICBjb25zb2xlLmxvZygnc2hpZnQnKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMudmVudC50cmlnZ2VyKFwiY2hhdFwiLCB7IG1lc3NhZ2U6IHRoaXMuJCgnLm1lc3NhZ2UtaW5wdXQnKS52YWwoKX0pO1xuICAgICAgICB0aGlzLiQoJy5tZXNzYWdlLWlucHV0JykudmFsKCcnKTtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnZlbnQudHJpZ2dlcihcInR5cGluZ1wiKTtcbiAgICAgIGNvbnNvbGUubG9nKCd3dXQnKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXM7XG4gIH0sXG4gIGRpcmVjdE1lc3NhZ2VJbnB1dFByZXNzZWQ6IGZ1bmN0aW9uKGUpIHtcbiAgICBpZiAoZS5rZXlDb2RlID09PSAxMyAmJiAkLnRyaW0oJCgnLmRpcmVjdC1tZXNzYWdlLWlucHV0JykudmFsKCkpLmxlbmd0aCA+IDApIHtcbiAgICAgIC8vIGZ1biBmYWN0OiBzZXBhcmF0ZSBldmVudHMgd2l0aCBhIHNwYWNlIGluIHRyaWdnZXIncyBmaXJzdCBhcmcgYW5kIHlvdVxuICAgICAgLy8gY2FuIHRyaWdnZXIgbXVsdGlwbGUgZXZlbnRzLlxuICAgICAgdGhpcy52ZW50LnRyaWdnZXIoXCJkaXJlY3RNZXNzYWdlXCIsIHsgbWVzc2FnZTogdGhpcy4kKCcuZGlyZWN0LW1lc3NhZ2UtaW5wdXQnKS52YWwoKX0pO1xuICAgICAgdGhpcy4kKCcuZGlyZWN0LW1lc3NhZ2UtaW5wdXQnKS52YWwoJycpO1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnZlbnQudHJpZ2dlcihcInR5cGluZ1wiKTtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXM7XG4gIH0sXG4gIHNldFJvb206IGZ1bmN0aW9uKGUpIHtcbiAgICBjb25zb2xlLmxvZygnY3J2LmYuc2V0Um9vbScpO1xuICAgIHZhciAkdGFyID0gJChlLnRhcmdldCk7XG4gICAgaWYgKCR0YXIuaXMoJy5yb29tLW5hbWUnKSkge1xuICAgICAgdGhpcy5qb2luUm9vbSh7aWQ6ICR0YXIuZGF0YSgncm9vbS1pZCcpLCBuYW1lOiAkdGFyLmRhdGEoJ3Jvb20nKX0pO1xuICAgIH1cbiAgfSxcblxuXG4gIGRhdGVEaXZpZGVyOiAoZnVuY3Rpb24oKSB7XG5cbiAgICB2YXIgJHdpbmRvdyA9ICQod2luZG93KSxcbiAgICAkc3RpY2tpZXM7XG5cbiAgICBsb2FkID0gZnVuY3Rpb24oc3RpY2tpZXMpIHtcbiAgICAgICRzdGlja2llcyA9IHN0aWNraWVzO1xuICAgICAgJCgnI2NoYXRib3gtY29udGVudCcpLnNjcm9sbChzY3JvbGxTdGlja2llc0luaXQpO1xuICAgIH07XG5cbiAgICBzY3JvbGxTdGlja2llc0luaXQgPSBmdW5jdGlvbigpIHtcbiAgICAgICQodGhpcykub2ZmKFwic2Nyb2xsLnN0aWNraWVzXCIpO1xuICAgICAgJCh0aGlzKS5vbihcInNjcm9sbC5zdGlja2llc1wiLCBfLmRlYm91bmNlKF93aGVuU2Nyb2xsaW5nLCAxNTApKTtcbiAgICB9O1xuXG4gICAgX3doZW5TY3JvbGxpbmcgPSBmdW5jdGlvbigpIHtcbiAgICAgICRzdGlja2llcy5yZW1vdmVDbGFzcygnZml4ZWQnKTtcbiAgICAgICRzdGlja2llcy5lYWNoKGZ1bmN0aW9uKGksIHN0aWNreSkge1xuICAgICAgICB2YXIgJHRoaXNTdGlja3kgPSAkKHN0aWNreSksXG4gICAgICAgICR0aGlzU3RpY2t5VG9wID0gJHRoaXNTdGlja3kub2Zmc2V0KCkudG9wO1xuICAgICAgICBpZiAoJHRoaXNTdGlja3lUb3AgPD0gMTYyKSB7XG4gICAgICAgICAgJHRoaXNTdGlja3kuYWRkQ2xhc3MoXCJmaXhlZFwiKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfTtcblxuICAgIHJldHVybiB7XG4gICAgICBsb2FkOiBsb2FkXG4gICAgfTtcbiAgfSkoKVxuXG5cblxuXG59KTtcblxufSkoalF1ZXJ5KTsiLCJcbnZhciBhcHAgPSBhcHAgfHwge307XG5cbihmdW5jdGlvbiAoKSB7XG5cbiAgYXBwLkludml0YXRpb25Db2xsZWN0aW9uID0gQmFja2JvbmUuQ29sbGVjdGlvbi5leHRlbmQoe1xuICAgIG1vZGVsOiBhcHAuSW52aXRhdGlvbk1vZGVsXG4gIH0pO1xuXG59KSgpOyIsIlxudmFyIGFwcCA9IGFwcCB8fCB7fTtcblxuKGZ1bmN0aW9uICgpIHtcblxuICBhcHAuQ2hhdHJvb21MaXN0ID0gQmFja2JvbmUuQ29sbGVjdGlvbi5leHRlbmQoe1xuICAgIG1vZGVsOiBhcHAuQ2hhdHJvb21Nb2RlbCxcbiAgfSk7XG5cbn0pKCk7IiwidmFyIGFwcCA9IGFwcCB8fCB7fTtcblxuKGZ1bmN0aW9uICgpIHtcblxuICBhcHAuUHJpdmF0ZVJvb21Db2xsZWN0aW9uID0gQmFja2JvbmUuQ29sbGVjdGlvbi5leHRlbmQoe1xuICAgIG1vZGVsOiBhcHAuQ2hhdHJvb21Nb2RlbCxcbiAgfSk7XG5cbn0pKCk7IiwidmFyIGFwcCA9IGFwcCB8fCB7fTtcblxuXG4oZnVuY3Rpb24oJCkge1xuXG4gIGFwcC5DaGF0cm9vbVNldHRpbmdzVmlldyA9IEJhY2tib25lLlZpZXcuZXh0ZW5kKHtcblxuICAgIGVsOiAkKCcjY2hhdHJvb20taGVhZGVyLWNvbnRhaW5lcicpLFxuICAgIHVzZXJJbnZpdGVkVGVtcGxhdGU6IF8udGVtcGxhdGUoJzxkaXYgY2xhc3M9XCJ1c2VyLWludml0ZWQtcmVzcG9uc2Ugc3VjY2Vzc1wiPjwlPSB1c2VybmFtZSAlPiBJbnZpdGVkITwvZGl2PicpLFxuICAgIGludml0YXRpb25FcnJvclRlbXBsYXRlOiBfLnRlbXBsYXRlKCc8ZGl2IGNsYXNzPVwidXNlci1pbnZpdGVkLXJlc3BvbnNlIGZhaWx1cmVcIj5GYWlsdXJlITwvZGl2PicpLFxuICAgIGV2ZW50czoge1xuICAgICAgJ2NoYW5nZSAjcHJlZmVyZW5jZXMtaW1hZ2UtdXBsb2FkJzogJ3JlbmRlclRodW1iJyxcbiAgICAgICdhdHRhY2hJbWFnZSAjcHJlZmVyZW5jZXMtZm9ybSc6ICd1cGxvYWQnLFxuICAgICAgJ2NsaWNrICNwcmVmZXJlbmNlcy1idG4nOiAnc3VibWl0JyxcbiAgICAgICdrZXl1cCAjaW52aXRlLXVzZXItaW5wdXQnOiAnaW52aXRlVXNlcicsXG4gICAgfSxcblxuICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uKG9wdGlvbnMpIHtcbiAgICAgIHRoaXMudmVudCA9IG9wdGlvbnMudmVudDtcbiAgICAgIHRoaXMudXNlclNlYXJjaFR5cGVhaGVhZCgpO1xuICAgICAgdmFyIHRoaXNfID0gdGhpcztcbiAgICAgICQoXCJmb3JtXCIpLnN1Ym1pdChmdW5jdGlvbihlKSB7XG4gICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgIH0pO1xuXG4gICAgICB0aGlzLmxpc3RlblRvKHRoaXMsIFwidXNlckludml0ZWRcIiwgdGhpcy51c2VySW52aXRlZCwgdGhpcyk7XG4gICAgfSxcblxuICAgIHJlbmRlcjogZnVuY3Rpb24oKSB7XG4gICAgICB0aGlzLnJlbmRlclRodW1iKCk7XG4gICAgfSxcblxuICAgIHJlbmRlclRodW1iOiBmdW5jdGlvbigpIHtcbiAgICAgIHZhciBpbnB1dCA9IHRoaXMuJCgnI3ByZWZlcmVuY2VzLWltYWdlLXVwbG9hZCcpO1xuICAgICAgdmFyIGltZyA9IHRoaXMuJCgnI3VwbG9hZGVkLXByZWZlcmVuY2VzLWltYWdlJylbMF07XG4gICAgICBpZihpbnB1dC52YWwoKSAhPT0gJycpIHtcbiAgICAgICAgdmFyIHNlbGVjdGVkX2ZpbGUgPSBpbnB1dFswXS5maWxlc1swXTtcbiAgICAgICAgdmFyIHJlYWRlciA9IG5ldyBGaWxlUmVhZGVyKCk7XG4gICAgICAgIHJlYWRlci5vbmxvYWQgPSAoZnVuY3Rpb24oYUltZykge1xuICAgICAgICAgIHJldHVybiBmdW5jdGlvbihlKSB7XG4gICAgICAgICAgICBhSW1nLnNyYyA9IGUudGFyZ2V0LnJlc3VsdDtcbiAgICAgICAgICB9O1xuICAgICAgICB9KShpbWcpO1xuICAgICAgICByZWFkZXIucmVhZEFzRGF0YVVSTCggc2VsZWN0ZWRfZmlsZSApO1xuICAgICAgfVxuXG4gICAgfSxcblxuICAgIHN1Ym1pdDogZnVuY3Rpb24oZSkge1xuICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuXG4gICAgICB0aGlzLiRmb3JtID0gdGhpcy4kKCcjcHJlZmVyZW5jZXMtZm9ybScpO1xuICAgICAgdGhpcy4kZm9ybS50cmlnZ2VyKCdhdHRhY2hJbWFnZScpO1xuICAgIH0sXG5cbiAgICB1cGxvYWQ6IGZ1bmN0aW9uKCkge1xuICAgICAgdmFyIF90aGlzID0gdGhpcztcbiAgICAgICAgdmFyIGZvcm1EYXRhID0gbmV3IEZvcm1EYXRhKHRoaXMuJGZvcm1bMF0pO1xuICAgICAgaWYgKHRoaXMuJCgnI3ByZWZlcmVuY2VzLWltYWdlLXVwbG9hZCcpWzBdLmZpbGVzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgJC5hamF4KHtcbiAgICAgICAgICB0eXBlOiAnUE9TVCcsXG4gICAgICAgICAgdXJsOiAnL2FwaS91cGxvYWRDaGF0cm9vbUltYWdlJyxcbiAgICAgICAgICBkYXRhOiBmb3JtRGF0YSxcbiAgICAgICAgICBjYWNoZTogZmFsc2UsXG4gICAgICAgICAgZGF0YVR5cGU6ICdqc29uJyxcbiAgICAgICAgICBwcm9jZXNzRGF0YTogZmFsc2UsXG4gICAgICAgICAgY29udGVudFR5cGU6IGZhbHNlLFxuICAgICAgICAgIGVycm9yOiBmdW5jdGlvbiggeGhyICkge1xuICAgICAgICAgICAgc3dhbCh7XG4gICAgICAgICAgICAgIHRpdGxlOiBcIk9IIE5PIE9IIE5PIE9IIE5PXCIsXG4gICAgICAgICAgICAgIHRleHQ6IFwiWW91ciBpbWFnZS4gSXQgdWgsIHdvbid0IGZpdC4gJ1RvbyBiaWcuIEl0IG5lZWRzIHRvIGJlIGxlc3MgdGhhbiA1MDAgS2IsJyB0aGUgY29tcHV0ZXIgbW9ua2V5cyBzYXkuICdBbmQgLmpwZWcsIC5wbmcsIG9yIC5naWYgZmlsZScuXCIsXG4gICAgICAgICAgICAgIGltYWdlVXJsOiAnL2ltZy9zY3ViYS1waWcucG5nJyxcbiAgICAgICAgICAgICAgY29uZmlybUJ1dHRvbkNvbG9yOiBcIiM3NDlDQThcIlxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfSxcbiAgICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiggcmVzcG9uc2UgKSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZygnaW1nVXBsb2FkIHJlc3BvbnNlOiAnLCByZXNwb25zZSk7XG4gICAgICAgICAgICB2YXIgZm9ybSA9IF90aGlzLmNyZWF0ZVJvb21Gb3JtRGF0YSgpO1xuICAgICAgICAgICAgZm9ybS5yb29tSW1hZ2UgPSByZXNwb25zZS5yb29tSW1hZ2U7XG4gICAgICAgICAgICBfdGhpcy50cmlnZ2VyKCd1cGRhdGVSb29tJywgZm9ybSk7XG4gICAgICAgICAgICAkKCcjcHJlZmVyZW5jZXMtbW9kYWwnKS5tb2RhbCgnaGlkZScpO1xuICAgICAgICAgICAgX3RoaXMuY2xlYXJGaWVsZCgpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB2YXIgZm9ybSA9IHRoaXMuY3JlYXRlUm9vbUZvcm1EYXRhKCk7XG4gICAgICAgIHRoaXMudHJpZ2dlcigndXBkYXRlUm9vbScsIGZvcm0pO1xuICAgICAgfVxuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH0sXG5cblxuICAgIGNyZWF0ZVJvb21Gb3JtRGF0YTogZnVuY3Rpb24oKSB7XG4gICAgICB2YXIgZm9ybURhdGEgPSB7fTtcbiAgICAgIHRoaXMuJCgnI3ByZWZlcmVuY2VzLWZvcm0nKS5maW5kKCAnaW5wdXQnICkuZWFjaChmdW5jdGlvbihpLCBlbCkge1xuICAgICAgICBpZiAoJChlbCkuZGF0YSgnY3JlYXRlJykgPT09ICdwcml2YWN5Jykge1xuICAgICAgICAgIHZhciB2YWwgPSAkKGVsKS5wcm9wKCdjaGVja2VkJyk7XG4gICAgICAgICAgZm9ybURhdGFbJ3ByaXZhY3knXSA9IHZhbDtcbiAgICAgICAgfSBlbHNlIGlmICgkKGVsKS52YWwoKSAhPT0gJycgJiYgJChlbCkudmFsKCkgIT09ICdvbicpIHtcbiAgICAgICAgICBmb3JtRGF0YVskKGVsKS5kYXRhKCdjcmVhdGUnKV0gPSAkKGVsKS52YWwoKTtcbiAgICAgICAgICAkKGVsKS52YWwoJycpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICAgIGRlbGV0ZSBmb3JtRGF0YS51bmRlZmluZWQ7XG4gICAgICByZXR1cm4gZm9ybURhdGE7XG4gICAgfSxcblxuXG4gICAgY2xlYXJGaWVsZDogZnVuY3Rpb24oKSB7XG4gICAgICB0aGlzLiQoJyN1cGxvYWRlZC1wcmVmZXJlbmNlcy1pbWFnZScpWzBdLnNyYyA9ICcnO1xuICAgICAgdGhpcy4kKCcjcHJlZmVyZW5jZXMtaW1hZ2UtdXBsb2FkJykudmFsKCcnKTtcbiAgICB9LFxuXG4gICAgaW52aXRlVXNlcjogZnVuY3Rpb24oZSkge1xuICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgdmFyIHJlY2lwaWVudCA9ICQudHJpbSgkKCcjaW52aXRlLXVzZXItaW5wdXQnKS52YWwoKSk7XG4gICAgICBpZiAoZS5rZXlDb2RlID09PSAxMyAmJiByZWNpcGllbnQubGVuZ3RoID4gMCkge1xuICAgICAgICAvLyBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgIHZhciBzZW5kZXIgPSB0aGlzLm1vZGVsLmdldCgnY3VycmVudFVzZXInKSxcbiAgICAgICAgICAgIHJvb21JZCA9IHRoaXMubW9kZWwuZ2V0KCdpZCcpLFxuICAgICAgICAgICAgcm9vbU5hbWUgPSB0aGlzLm1vZGVsLmdldCgnbmFtZScpLFxuICAgICAgICAgICAgaW52aXRhdGlvbk9iaiA9IHtzZW5kZXI6IHNlbmRlciwgcm9vbUlkOiByb29tSWQsIHJvb21OYW1lOiByb29tTmFtZSwgcmVjaXBpZW50OiByZWNpcGllbnR9O1xuICAgICAgICB0aGlzLnZlbnQudHJpZ2dlcignaW52aXRlVXNlcicsIGludml0YXRpb25PYmopO1xuICAgICAgICAkKCcjaW52aXRlLXVzZXItaW5wdXQnKS52YWwoJycpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfSxcblxuICAgIHVzZXJTZWFyY2hUeXBlYWhlYWQ6IGZ1bmN0aW9uKCkge1xuICAgICAgdmFyIHRoaXNfID0gdGhpcztcbiAgICAgIHZhciBibG9vZCA9IG5ldyBCbG9vZGhvdW5kKHtcbiAgICAgICAgZGF0dW1Ub2tlbml6ZXI6IEJsb29kaG91bmQudG9rZW5pemVycy5vYmoud2hpdGVzcGFjZSgndXNlcm5hbWUnKSxcbiAgICAgICAgcXVlcnlUb2tlbml6ZXI6IEJsb29kaG91bmQudG9rZW5pemVycy53aGl0ZXNwYWNlLFxuICAgICAgICBwcmVmZXRjaDoge1xuICAgICAgICAgIHVybDogJy9hbGxVc2VycycsXG4gICAgICAgICAgZmlsdGVyOiBmdW5jdGlvbihkYXRhKSB7XG4gICAgICAgICAgICAgcmV0dXJuIF8ubWFwKGRhdGEsIGZ1bmN0aW9uKHVzZXIpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4geyB1c2VybmFtZTogdXNlciB9O1xuICAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH0sXG4gICAgICAgICAgdHRsOiAwLFxuICAgICAgICB9LFxuICAgICAgICByZW1vdGU6IHtcbiAgICAgICAgICB1cmw6ICcvc2VhcmNoVXNlcnM/dXNlcm5hbWU9JVFVRVJZJyxcbiAgICAgICAgICB3aWxkY2FyZDogJyVRVUVSWScsXG4gICAgICAgICAgcmF0ZUxpbWl0V2FpdDogMzAwLFxuICAgICAgICB9XG4gICAgICB9KTtcbiAgICAgIGJsb29kLmNsZWFyUHJlZmV0Y2hDYWNoZSgpO1xuICAgICAgYmxvb2QuaW5pdGlhbGl6ZSgpO1xuICAgICAgJCgnI2ludml0ZS11c2VyLWlucHV0JykudHlwZWFoZWFkKHtcbiAgICAgICAgbWluTGVuZ3RoOiAyLFxuICAgICAgICBjbGFzc05hbWVzOiB7XG4gICAgICAgICAgaW5wdXQ6ICd0eXBlYWhlYWQtaW5wdXQnLFxuICAgICAgICAgIGhpbnQ6ICd0eXBlYWhlYWQtaGludCcsXG4gICAgICAgICAgc2VsZWN0YWJsZTogJ3R5cGVhaGVhZC1zZWxlY3RhYmxlJyxcbiAgICAgICAgICBtZW51OiAndHlwZWFoZWFkLW1lbnUnLFxuICAgICAgICAgIGhpZ2hsaWdodDogJ3R5cGVhaGVhZC1oaWdobGlnaHQnLFxuICAgICAgICAgIGRhdGFzZXQ6ICd0eXBlYWhlYWQtZGF0YXNldCcsXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgICAge1xuICAgICAgICBsaW1pdDogNSxcbiAgICAgICAgc291cmNlOiBibG9vZCxcbiAgICAgICAgbmFtZTogJ3VzZXItc2VhcmNoJyxcbiAgICAgICAgZGlzcGxheTogJ3VzZXJuYW1lJyxcbiAgICAgIH0pLm9uKCd0eXBlYWhlYWQ6c2VsZWN0IHR5cGVhaGVhZDphdXRvY29tcGxldGUnLCBmdW5jdGlvbihvYmopIHtcblxuICAgICAgfSk7XG4gICAgfSxcblxuICAgIHVzZXJJbnZpdGVkOiBmdW5jdGlvbih1c2VybmFtZSkge1xuICAgICAgaWYgKHVzZXJuYW1lLmVycm9yID09PSAnZXJyb3InKSB7XG4gICAgICAgICQoJy5pbnZpdGUtdXNlci1jb250YWluZXInKS5hcHBlbmQodGhpcy5pbnZpdGF0aW9uRXJyb3JUZW1wbGF0ZSgpKTtcbiAgICAgIH1cbiAgICAgICQoJy5pbnZpdGUtdXNlci1jb250YWluZXInKS5hcHBlbmQodGhpcy51c2VySW52aXRlZFRlbXBsYXRlKHt1c2VybmFtZTogdXNlcm5hbWV9KSk7XG4gICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkge1xuICAgICAgICAkKCcuaW52aXRlLXVzZXItY29udGFpbmVyIC5zdWNjZXNzJykuZmFkZU91dCgzMDAsIGZ1bmN0aW9uKCkge1xuICAgICAgICAgICQodGhpcykucmVtb3ZlKCk7XG4gICAgICAgIH0pO1xuICAgICAgICAkKCcuaW52aXRlLXVzZXItY29udGFpbmVyIC5mYWlsdXJlJykuZmFkZU91dCgzMDAsIGZ1bmN0aW9uKCkge1xuICAgICAgICAgICQodGhpcykucmVtb3ZlKCk7XG4gICAgICAgIH0pO1xuICAgICAgfSwgMTAwMCk7XG4gICAgfSxcblxuXG4gIH0pO1xuXG59KShqUXVlcnkpOyIsInZhciBhcHAgPSBhcHAgfHwge307XG5cblxuKGZ1bmN0aW9uKCQpIHtcblxuICBhcHAuQ3JlYXRlQ2hhdHJvb21WaWV3ID0gQmFja2JvbmUuVmlldy5leHRlbmQoe1xuXG4gICAgZWw6ICQoJyNjcmVhdGVDaGF0cm9vbUNvbnRhaW5lcicpLFxuICAgIGV2ZW50czoge1xuICAgICAgJ2NoYW5nZSAjY2hhdHJvb21JbWFnZVVwbG9hZCc6ICdyZW5kZXJUaHVtYicsXG4gICAgICAnYXR0YWNoSW1hZ2UgI2NyZWF0ZUNoYXRyb29tRm9ybSc6ICd1cGxvYWQnLFxuICAgICAgJ2NsaWNrICNjcmVhdGVDaGF0cm9vbUJ0bic6ICdzdWJtaXQnLFxuICAgIH0sXG5cbiAgICBpbml0aWFsaXplOiBmdW5jdGlvbihvcHRpb25zKSB7XG4gICAgICB0aGlzLnZlbnQgPSBvcHRpb25zLnZlbnQ7XG4gICAgICB0aGlzLmxpc3RlblRvKHRoaXMsIFwiY2hhdHJvb21BdmFpbGFiaWxpdHlcIiwgdGhpcy5yZW5kZXJDaGF0cm9vbUF2YWlsYWJpbGl0eSwgdGhpcyk7XG4gICAgfSxcblxuICAgIHJlbmRlcjogZnVuY3Rpb24oKSB7XG4gICAgICB0aGlzLnJlbmRlclRodW1iKCk7XG4gICAgfSxcblxuICAgIHJlbmRlclRodW1iOiBmdW5jdGlvbigpIHtcbiAgICAgIHZhciBpbnB1dCA9IHRoaXMuJCgnI2NoYXRyb29tSW1hZ2VVcGxvYWQnKTtcbiAgICAgIHZhciBpbWcgPSB0aGlzLiQoJyN1cGxvYWRlZENoYXRyb29tSW1hZ2UnKVswXTtcbiAgICAgIGlmKGlucHV0LnZhbCgpICE9PSAnJykge1xuICAgICAgICB2YXIgc2VsZWN0ZWRfZmlsZSA9IGlucHV0WzBdLmZpbGVzWzBdO1xuICAgICAgICB2YXIgcmVhZGVyID0gbmV3IEZpbGVSZWFkZXIoKTtcbiAgICAgICAgcmVhZGVyLm9ubG9hZCA9IChmdW5jdGlvbihhSW1nKSB7XG4gICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKGUpIHtcbiAgICAgICAgICAgIGFJbWcuc3JjID0gZS50YXJnZXQucmVzdWx0O1xuICAgICAgICAgIH07XG4gICAgICAgIH0pKGltZyk7XG4gICAgICAgIHJlYWRlci5yZWFkQXNEYXRhVVJMKCBzZWxlY3RlZF9maWxlICk7XG4gICAgICB9XG5cbiAgICB9LFxuXG4gICAgc3VibWl0OiBmdW5jdGlvbihlKSB7XG4gICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICBpZiAoIXRoaXMuJCgnI2NoYXRyb29tLW5hbWUtaW5wdXQnKS5oYXNDbGFzcygnaW5wdXQtdmFsaWQnKSkge1xuICAgICAgICBzd2FsKHtcbiAgICAgICAgICB0aXRsZTogXCJPSCBOTyBPSCBOTyBPSCBOT1wiLFxuICAgICAgICAgIHRleHQ6IFwiQ2hhdHJvb20gQWxyZWFkeSwgSXQgQWxyZWFkeSBFeGlzdHMhIEFuZC4gRG9uJ3QgR28gSW4gVGhlcmUuIERvbid0LiBZb3UuIFRob3NlIFBvb3IgLiAuIC4gSSBUaHJldyBVcCBJbiBNeSBIYXQhIE9IIE5PLiBXSFkuIE9IIE5PLiBPSCBOTy5cIixcbiAgICAgICAgICBpbWFnZVVybDogJy9pbWcvc2N1YmEtcGlnLnBuZycsXG4gICAgICAgICAgY29uZmlybUJ1dHRvbkNvbG9yOiBcIiM3NDlDQThcIlxuICAgICAgICB9KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMuJGZvcm0gPSB0aGlzLiQoJyNjcmVhdGVDaGF0cm9vbUZvcm0nKTtcbiAgICAgICAgdGhpcy4kZm9ybS50cmlnZ2VyKCdhdHRhY2hJbWFnZScpO1xuICAgICAgfVxuICAgIH0sXG5cbiAgICB1cGxvYWQ6IGZ1bmN0aW9uKCkge1xuICAgICAgdmFyIF90aGlzID0gdGhpcztcbiAgICAgIHZhciBmb3JtRGF0YSA9IG5ldyBGb3JtRGF0YSh0aGlzLiRmb3JtWzBdKTtcbiAgICAgIGlmICh0aGlzLiQoJyNjaGF0cm9vbUltYWdlVXBsb2FkJylbMF0uZmlsZXMubGVuZ3RoID4gMCkge1xuICAgICAgICAkLmFqYXgoe1xuICAgICAgICAgIHR5cGU6ICdQT1NUJyxcbiAgICAgICAgICB1cmw6ICcvYXBpL3VwbG9hZENoYXRyb29tSW1hZ2UnLFxuICAgICAgICAgIGRhdGE6IGZvcm1EYXRhLFxuICAgICAgICAgIGNhY2hlOiBmYWxzZSxcbiAgICAgICAgICBkYXRhVHlwZTogJ2pzb24nLFxuICAgICAgICAgIHByb2Nlc3NEYXRhOiBmYWxzZSxcbiAgICAgICAgICBjb250ZW50VHlwZTogZmFsc2UsXG4gICAgICAgICAgZXJyb3I6IGZ1bmN0aW9uKCB4aHIgKSB7XG4gICAgICAgICAgICBzd2FsKHtcbiAgICAgICAgICAgICAgdGl0bGU6IFwiT0ggTk8gT0ggTk8gT0ggTk9cIixcbiAgICAgICAgICAgICAgdGV4dDogXCJZb3VyIGltYWdlLiBJdCB1aCwgd29uJ3QgZml0LiAnVG9vIGJpZy4gSXQgbmVlZHMgdG8gYmUgbGVzcyB0aGFuIDUwMCBLYiwnIHRoZSBjb21wdXRlciBtb25rZXlzIHNheS4gJ0FuZCAuanBlZywgLnBuZywgb3IgLmdpZiBmaWxlJy5cIixcbiAgICAgICAgICAgICAgaW1hZ2VVcmw6ICcvaW1nL3NjdWJhLXBpZy5wbmcnLFxuICAgICAgICAgICAgICBjb25maXJtQnV0dG9uQ29sb3I6IFwiIzc0OUNBOFwiXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9LFxuICAgICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uKCByZXNwb25zZSApIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdpbWdVcGxvYWQgcmVzcG9uc2U6ICcsIHJlc3BvbnNlKTtcbiAgICAgICAgICAgIHZhciBmb3JtID0gX3RoaXMuY3JlYXRlUm9vbUZvcm1EYXRhKCk7XG4gICAgICAgICAgICByZXNwb25zZS5uYW1lID0gZm9ybS5uYW1lO1xuICAgICAgICAgICAgcmVzcG9uc2UucHJpdmFjeSA9IGZvcm0ucHJpdmFjeTtcbiAgICAgICAgICAgICAgX3RoaXMudmVudC50cmlnZ2VyKCdjcmVhdGVSb29tJywgcmVzcG9uc2UpO1xuICAgICAgICAgICAgJCgnI2NyZWF0ZUNoYXRyb29tTW9kYWwnKS5tb2RhbCgnaGlkZScpO1xuICAgICAgICAgICAgX3RoaXMuY2xlYXJGaWVsZCgpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB2YXIgZm9ybSA9IF90aGlzLmNyZWF0ZVJvb21Gb3JtRGF0YSgpO1xuICAgICAgIHRoaXMudmVudC50cmlnZ2VyKCdjcmVhdGVSb29tJywgZm9ybSk7XG4gICAgICB9XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfSxcblxuXG4gICAgY3JlYXRlUm9vbUZvcm1EYXRhOiBmdW5jdGlvbigpIHtcbiAgICAgIHZhciBmb3JtRGF0YSA9IHt9O1xuICAgICAgZm9ybURhdGEucm9vbUltYWdlID0gJy9pbWcvY2hqYXQtaWNvbjEucG5nJztcbiAgICAgIHRoaXMuJCgnI2NyZWF0ZUNoYXRyb29tRm9ybScpLmZpbmQoICdpbnB1dCcgKS5lYWNoKGZ1bmN0aW9uKGksIGVsKSB7XG4gICAgICAgIGlmICgkKGVsKS5wcm9wKCd0eXBlJykgPT09IFwiYnV0dG9uXCIpIHtcblxuICAgICAgICB9IGVsc2UgaWYgKCQoZWwpLmRhdGEoJ2NyZWF0ZScpID09PSAncHJpdmFjeScpIHtcbiAgICAgICAgICB2YXIgdmFsID0gJChlbCkucHJvcCgnY2hlY2tlZCcpO1xuICAgICAgICAgIGZvcm1EYXRhWydwcml2YWN5J10gPSB2YWw7XG4gICAgICAgIH0gZWxzZSBpZiAoJChlbCkudmFsKCkgIT09ICcnKSB7XG4gICAgICAgICAgZm9ybURhdGFbJChlbCkuZGF0YSgnY3JlYXRlJyldID0gJChlbCkudmFsKCk7XG4gICAgICAgICAgJChlbCkudmFsKCcnKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgICByZXR1cm4gZm9ybURhdGE7XG5cbiAgICB9LFxuXG4gICAgY2xlYXJGaWVsZDogZnVuY3Rpb24oKSB7XG4gICAgICB0aGlzLiQoJyN1cGxvYWRlZENoYXRyb29tSW1hZ2UnKVswXS5zcmMgPSAnJztcbiAgICAgIHRoaXMuJCgnI2NoYXRyb29tSW1hZ2VVcGxvYWQnKS52YWwoJycpO1xuICAgIH0sXG5cbiAgICByZW5kZXJDaGF0cm9vbUF2YWlsYWJpbGl0eTogZnVuY3Rpb24oYXZhaWxhYmlsaXR5KSB7XG4gICAgICB0aGlzLiQoJy5yb29tLW5hbWUtdmFsaWRhdGlvbicpLnJlbW92ZUNsYXNzKCdpbnB1dC12YWxpZCBpbnB1dC1pbnZhbGlkJyk7XG4gICAgICB0aGlzLiQoJy5yb29tLW5hbWUtdmFsaWRhdGlvbi1tZXNzYWdlJykuY2hpbGRyZW4oKS5yZW1vdmUoKTtcbiAgICAgIGlmIChhdmFpbGFiaWxpdHkgPT09IHRydWUpIHtcbiAgICAgICAgdGhpcy4kKCcucm9vbS1uYW1lLXZhbGlkYXRpb24nKS5hZGRDbGFzcygnaW5wdXQtdmFsaWQnKTtcbiAgICAgICAgdGhpcy4kKCcucm9vbS1uYW1lLXZhbGlkYXRpb24tbWVzc2FnZScpLmFwcGVuZCgnPGRpdiBpZD1cIiNjaGF0cm9vbS1uYW1lLXZhbGlkYXRpb25cIiBjbGFzcz1cImZhIGZhLWNoZWNrXCI+TmFtZSBBdmFpbGFibGU8L2Rpdj4nKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMuJCgnLnJvb20tbmFtZS12YWxpZGF0aW9uJykuYWRkQ2xhc3MoJ2lucHV0LWludmFsaWQgZmEgZmEtdGltZXMnKTtcbiAgICAgICAgdGhpcy4kKCcucm9vbS1uYW1lLXZhbGlkYXRpb24tbWVzc2FnZScpLmFwcGVuZCgnPGRpdiBpZD1cIiNjaGF0cm9vbS1uYW1lLXZhbGlkYXRpb25cIiBjbGFzcz1cImZhIGZhLXRpbWVzXCI+TmFtZSBVbmF2YWlsYWJsZTwvZGl2PicpO1xuICAgICAgfVxuICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHtcbiAgICAgICAgdGhpcy4kKCcucm9vbS1uYW1lLXZhbGlkYXRpb24tbWVzc2FnZScpLmNoaWxkcmVuKCkuZmFkZU91dCg2MDAsIGZ1bmN0aW9uKCl7XG4gICAgICAgICAgJCh0aGlzKS5jaGlsZHJlbigpLnJlbW92ZSgpO1xuICAgICAgICB9KTtcbiAgICAgIH0sIDIwMDApO1xuICAgIH1cblxuICB9KTtcblxufSkoalF1ZXJ5KTsiLCJ2YXIgYXBwID0gYXBwIHx8IHt9O1xuXG5cbihmdW5jdGlvbigkKSB7XG5cbiAgYXBwLkNoYXRJbWFnZVVwbG9hZFZpZXcgPSBCYWNrYm9uZS5WaWV3LmV4dGVuZCh7XG5cbiAgICBlbDogJCgnI2NoYXRJbWFnZVVwbG9hZENvbnRhaW5lcicpLFxuICBcbiAgICBldmVudHM6IHtcbiAgICAgICdjaGFuZ2UgI2NoYXRJbWFnZVVwbG9hZCc6ICdyZW5kZXJUaHVtYicsXG4gICAgICAnYXR0YWNoSW1hZ2UgI2NoYXRJbWFnZVVwbG9hZEZvcm0nOiAndXBsb2FkJyxcbiAgICAgICdjbGljayAjYWRkQ2hhdEltYWdlQnRuJzogJ3N1Ym1pdCcsXG4gICAgfSxcblxuXG4gICAgcmVuZGVyOiBmdW5jdGlvbigpIHtcbiAgICAgIHRoaXMucmVuZGVyVGh1bWIoKTtcbiAgICB9LFxuXG4gICAgcmVuZGVyVGh1bWI6IGZ1bmN0aW9uKCkge1xuICAgICAgdmFyIGlucHV0ID0gdGhpcy4kKCcjY2hhdEltYWdlVXBsb2FkJyk7XG4gICAgICB2YXIgaW1nID0gdGhpcy4kKCcjdXBsb2FkZWRDaGF0SW1hZ2UnKVswXTtcbiAgICAgIGlmKGlucHV0LnZhbCgpICE9PSAnJykge1xuICAgICAgICB2YXIgc2VsZWN0ZWRfZmlsZSA9IGlucHV0WzBdLmZpbGVzWzBdO1xuICAgICAgICB2YXIgcmVhZGVyID0gbmV3IEZpbGVSZWFkZXIoKTtcbiAgICAgICAgcmVhZGVyLm9ubG9hZCA9IChmdW5jdGlvbihhSW1nKSB7XG4gICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uKGUpIHtcbiAgICAgICAgICAgIGFJbWcuc3JjID0gZS50YXJnZXQucmVzdWx0O1xuICAgICAgICAgIH07XG4gICAgICAgIH0pKGltZyk7XG4gICAgICAgIHJlYWRlci5yZWFkQXNEYXRhVVJMKCBzZWxlY3RlZF9maWxlICk7XG4gICAgICB9XG4gICAgfSxcblxuICAgIHN1Ym1pdDogZnVuY3Rpb24oZSkge1xuICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgdGhpcy4kZm9ybSA9IHRoaXMuJCgnI2NoYXRJbWFnZVVwbG9hZEZvcm0nKTtcbiAgICAgIHRoaXMuJGZvcm0udHJpZ2dlcignYXR0YWNoSW1hZ2UnKTtcbiAgICB9LFxuXG4gICAgdXBsb2FkOiBmdW5jdGlvbigpIHtcbiAgICAgIHZhciBfdGhpcyA9IHRoaXM7XG4gICAgICAgIHZhciBmb3JtRGF0YSA9IG5ldyBGb3JtRGF0YSh0aGlzLiRmb3JtWzBdKTtcbiAgICAgIGlmICh0aGlzLiQoJyNjaGF0SW1hZ2VVcGxvYWQnKVswXS5maWxlcy5sZW5ndGggPiAwKSB7XG4gICAgICAgICQuYWpheCh7XG4gICAgICAgICAgdHlwZTogJ1BPU1QnLFxuICAgICAgICAgIHVybDogJy9hcGkvdXBsb2FkQ2hhdEltYWdlJyxcbiAgICAgICAgICBkYXRhOiBmb3JtRGF0YSxcbiAgICAgICAgICBjYWNoZTogZmFsc2UsXG4gICAgICAgICAgZGF0YVR5cGU6ICdqc29uJyxcbiAgICAgICAgICBwcm9jZXNzRGF0YTogZmFsc2UsXG4gICAgICAgICAgY29udGVudFR5cGU6IGZhbHNlLFxuICAgICAgICAgIGVycm9yOiBmdW5jdGlvbiggeGhyICkge1xuICAgICAgICAgICAgc3dhbCh7XG4gICAgICAgICAgICAgIHRpdGxlOiBcIk9IIE5PIE9IIE5PIE9IIE5PXCIsXG4gICAgICAgICAgICAgIHRleHQ6IFwiWW91ciBpbWFnZS4gSXQgdWgsIHdvbid0IGZpdC4gJ1RvbyBiaWcuIEl0IG5lZWRzIHRvIGJlIGxlc3MgdGhhbiA1MDAgS2IsJyB0aGUgY29tcHV0ZXIgbW9ua2V5cyBzYXkuICdBbmQgLmpwZWcsIC5wbmcsIG9yIC5naWYgZmlsZScuXCIsXG4gICAgICAgICAgICAgIHR5cGU6IFwiZXJyb3JcIixcbiAgICAgICAgICAgICAgaW1hZ2VVcmw6ICcvaW1nL3NjdWJhLXBpZy5wbmcnLFxuICAgICAgICAgICAgICBjb25maXJtQnV0dG9uQ29sb3I6IFwiIzc0OUNBOFwiLFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfSxcbiAgICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiggcmVzcG9uc2UgKSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZygnaW1nVXBsb2FkIHJlc3BvbnNlOiAnLCByZXNwb25zZSk7XG4gICAgICAgICAgICBfdGhpcy4kZWwuZGF0YSgnY2hhdC10eXBlJykgPT09ICdjaGF0JyA/XG4gICAgICAgICAgICAgIF90aGlzLnRyaWdnZXIoJ2NoYXQtaW1hZ2UtdXBsb2FkZWQnLCByZXNwb25zZSkgOlxuICAgICAgICAgICAgICBfdGhpcy50cmlnZ2VyKCdtZXNzYWdlLWltYWdlLXVwbG9hZGVkJywgcmVzcG9uc2UpO1xuICAgICAgICAgICAgY29uc29sZS5sb2coJ2ltZ1VwbG9hZCBwYXRoICcsIHJlc3BvbnNlLnBhdGgpO1xuICAgICAgICAgICAgJCgnI2NoYXRJbWFnZVVwbG9hZE1vZGFsJykubW9kYWwoJ2hpZGUnKTtcbiAgICAgICAgICAgIF90aGlzLmNsZWFyRmllbGQoKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICB0aGlzLnRyaWdnZXIoJ2ltYWdlLXVwbG9hZGVkJyk7XG4gICAgICB9XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfSxcblxuXG4gICAgY2xlYXJGaWVsZDogZnVuY3Rpb24oKSB7XG4gICAgICB0aGlzLiQoJyN1cGxvYWRlZENoYXRJbWFnZScpWzBdLnNyYyA9ICcnO1xuICAgICAgdGhpcy4kKCcjY2hhdEltYWdlVXBsb2FkJykudmFsKCcnKTtcbiAgICB9XG5cbiAgfSk7XG5cbn0pKGpRdWVyeSk7IiwidmFyIGFwcCA9IGFwcCB8fCB7fTtcblxuKGZ1bmN0aW9uICgkKSB7XG5cbiAgYXBwLk5hdmJhclZpZXcgPSBCYWNrYm9uZS5WaWV3LmV4dGVuZCh7XG4gICAgZWw6ICcubG9naW4tbWVudScsXG4gICAgdGVtcGxhdGU6IF8udGVtcGxhdGUoJCgnI25hdmJhci10ZW1wbGF0ZScpLmh0bWwoKSksXG4gICAgaW52aXRhdGlvblRlbXBsYXRlOiBfLnRlbXBsYXRlKCQoJyNpbnZpdGF0aW9uLXRlbXBsYXRlJykuaHRtbCgpKSxcbiAgICBldmVudHM6IHtcbiAgICAgICdjbGljayAuZGVsZXRlLWludml0YXRpb24nOiAnZGVsZXRlSW52aXRhdGlvbicsXG4gICAgICAnY2xpY2sgLmFjY2VwdC1pbnZpdGF0aW9uJzogJ2FjY2VwdEludml0YXRpb24nLFxuICAgICAgJ2NoYW5nZSAjdXNlci1wcmVmZXJlbmNlcy1pbWFnZS11cGxvYWQnOiAncmVuZGVyVGh1bWInLFxuICAgICAgJ2F0dGFjaEltYWdlICN1c2VyLXByZWZlcmVuY2VzLWZvcm0nOiAndXBsb2FkJyxcbiAgICAgICdjbGljayAjdXNlci1wcmVmZXJlbmNlcy1idG4nOiAnc3VibWl0JyxcbiAgICAgICdrZXl1cCAjdXNlci1wcmVmZXJlbmNlcy1ob21lLXJvb20taW5wdXQnOiAnZG9lc0hvbWVSb29tRXhpc3QnLFxuICAgICAgJ2NsaWNrIC5sb2dvdXQnOiAnbG9nb3V0JyxcbiAgICB9LFxuXG4gICAgbG9nb3V0OiBmdW5jdGlvbigpIHtcbiAgICAgICAkLmFqYXgoe1xuICAgICAgICAgIHR5cGU6ICdQT1NUJyxcbiAgICAgICAgICB1cmw6ICcvbG9nb3V0JyxcbiAgICAgICAgICBwcm9jZXNzRGF0YTogZmFsc2UsXG4gICAgICAgICAgY29udGVudFR5cGU6IGZhbHNlLFxuICAgICAgICAgIGVycm9yOiBmdW5jdGlvbiggeGhyICkge1xuICAgICAgICAgICAgY29uc29sZS5sb2coJ2Vycm9yOiAnLCB4aHIgKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH0sXG5cbiAgICBpbml0aWFsaXplOiBmdW5jdGlvbihvcHRpb25zKSB7XG4gICAgICB0aGlzLnZlbnQgPSBvcHRpb25zLnZlbnQ7XG4gICAgICB0aGlzLm1vZGVsID0gbmV3IGFwcC5Vc2VyTW9kZWwoeyB1c2VybmFtZTogJycsIHVzZXJJbWFnZTogJycsIGhvbWVSb29tOiAnJywgaW52aXRhdGlvbnM6IG5ldyBhcHAuSW52aXRhdGlvbkNvbGxlY3Rpb24oKSB9KTtcbiAgICAgIHRoaXMubGlzdGVuVG8odGhpcy5tb2RlbCwgXCJjaGFuZ2VcIiwgdGhpcy5yZW5kZXIsIHRoaXMpO1xuXG4gICAgICB2YXIgaW52aXRhdGlvbnMgPSB0aGlzLm1vZGVsLmdldCgnaW52aXRhdGlvbnMnKTtcblxuICAgICAgdGhpcy5saXN0ZW5UbyhpbnZpdGF0aW9ucywgXCJyZXNldFwiLCB0aGlzLnJlbmRlckludml0YXRpb25zLCB0aGlzKTtcbiAgICAgIHRoaXMubGlzdGVuVG8odGhpcywgXCJob21lUm9vbUF2YWlsYWJpbGl0eVwiLCB0aGlzLnJlbmRlckhvbWVSb29tQXZhaWxhYmlsaXR5LCB0aGlzKTtcblxuICAgICAgdGhpcy5yZW5kZXIoKTtcbiAgICB9LFxuICAgIHJlbmRlcjogZnVuY3Rpb24oKSB7XG4gICAgICB0aGlzLiRlbC5odG1sKHRoaXMudGVtcGxhdGUodGhpcy5tb2RlbC50b0pTT04oKSkpO1xuXG4gICAgICB0aGlzLnJlbmRlckludml0YXRpb25zKCk7XG4gICAgICB0aGlzLnNldEhvbWVSb29tVHllcGFoZWFkKCk7XG5cblxuICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfSxcbiAgICByZW5kZXJJbnZpdGF0aW9uczogZnVuY3Rpb24oKSB7XG4gICAgICB0aGlzLiQoJyNpbnZpdGF0aW9ucycpLmVtcHR5KCk7XG4gICAgICB2YXIgaW52aXRhdGlvbnMgPSB0aGlzLm1vZGVsLmdldCgnaW52aXRhdGlvbnMnKTtcbiAgICAgIHZhciB0aGlzXyA9IHRoaXM7XG4gICAgICBpbnZpdGF0aW9ucy5lYWNoKGZ1bmN0aW9uKGludml0ZSkge1xuICAgICAgICB0aGlzXy5yZW5kZXJJbnZpdGF0aW9uKGludml0ZSk7XG4gICAgICB9LCB0aGlzKTtcbiAgICAgIGlmIChpbnZpdGF0aW9ucy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgdGhpcy4kKCcucGluay1mdXp6JykuaGlkZSgpO1xuICAgICAgICB0aGlzLiQoJyNpbnZpdGF0aW9ucycpLmFwcGVuZChcIjxkaXY+WW91J3ZlIGdvdCBubyBpbnZpdGF0aW9ucywgbGlrZSBkYW5nPC9kaXY+XCIpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy4kKCcucGluay1mdXp6Jykuc2hvdygpO1xuICAgICAgfVxuICAgIH0sXG4gICAgcmVuZGVySW52aXRhdGlvbjogZnVuY3Rpb24obW9kZWwpIHtcbiAgICAgIHRoaXMuJCgnI2ludml0YXRpb25zJykuYXBwZW5kKHRoaXMuaW52aXRhdGlvblRlbXBsYXRlKG1vZGVsLnRvSlNPTigpKSk7XG4gICAgfSxcbiAgICBkZWxldGVJbnZpdGF0aW9uOiBmdW5jdGlvbihlKSB7XG4gICAgICB2YXIgcm9vbUlkID0gJChlLnRhcmdldCkuZGF0YSgncm9vbWlkJyk7XG4gICAgICB0aGlzLnZlbnQudHJpZ2dlcignZGVsZXRlSW52aXRhdGlvbicsIHJvb21JZCk7XG4gICAgfSxcbiAgICBhY2NlcHRJbnZpdGF0aW9uOiBmdW5jdGlvbihlKSB7XG4gICAgICB2YXIgcm9vbUlkID0gJChlLnRhcmdldCkuZGF0YSgncm9vbWlkJyk7XG4gICAgICB0aGlzLnZlbnQudHJpZ2dlcignYWNjZXB0SW52aXRhdGlvbicsIHJvb21JZCk7XG4gICAgfSxcblxuXG4gICAgcmVuZGVyVGh1bWI6IGZ1bmN0aW9uKCkge1xuICAgICAgdmFyIGlucHV0ID0gdGhpcy4kKCcjdXNlci1wcmVmZXJlbmNlcy1pbWFnZS11cGxvYWQnKTtcbiAgICAgIHZhciBpbWcgPSB0aGlzLiQoJyN1cGxvYWRlZC11c2VyLXByZWZlcmVuY2VzLWltYWdlJylbMF07XG4gICAgICBpZihpbnB1dC52YWwoKSAhPT0gJycpIHtcbiAgICAgICAgdmFyIHNlbGVjdGVkX2ZpbGUgPSBpbnB1dFswXS5maWxlc1swXTtcbiAgICAgICAgdmFyIHJlYWRlciA9IG5ldyBGaWxlUmVhZGVyKCk7XG4gICAgICAgIHJlYWRlci5vbmxvYWQgPSAoZnVuY3Rpb24oYUltZykge1xuICAgICAgICAgIHJldHVybiBmdW5jdGlvbihlKSB7XG4gICAgICAgICAgICBhSW1nLnNyYyA9IGUudGFyZ2V0LnJlc3VsdDtcbiAgICAgICAgICB9O1xuICAgICAgICB9KShpbWcpO1xuICAgICAgICByZWFkZXIucmVhZEFzRGF0YVVSTCggc2VsZWN0ZWRfZmlsZSApO1xuICAgICAgfVxuICAgIH0sXG5cbiAgICBzdWJtaXQ6IGZ1bmN0aW9uKGUpIHtcbiAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgIGlmICh0aGlzLiQoJyN1c2VyLXByZWZlcmVuY2VzLWhvbWUtcm9vbS1pbnB1dCcpLmhhc0NsYXNzKCdpbnB1dC1pbnZhbGlkJykpIHtcbiAgICAgICAgc3dhbCh7XG4gICAgICAgICAgdGl0bGU6IFwiT0ggTk8gT0ggTk8gT0ggTk9cIixcbiAgICAgICAgICB0ZXh0OiBcIkNoYXRyb29tIENhbid0LCBJdCBEb2Vzbid0IEV4aXN0ISBBbmQuIEkgRG9uJ3QgS25vdy4gU2hvdWxkLiBZb3U/IEkgTWVhbiBIb3cgRE8gd2UuIEhvdyBkbz8gSG93IGRvIG5vdz9cIixcbiAgICAgICAgICBpbWFnZVVybDogJy9pbWcvc2N1YmEtcGlnLnBuZycsXG4gICAgICAgICAgY29uZmlybUJ1dHRvbkNvbG9yOiBcIiM3NDlDQThcIlxuICAgICAgICB9KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMuJGZvcm0gPSB0aGlzLiQoJyN1c2VyLXByZWZlcmVuY2VzLWZvcm0nKTtcbiAgICAgICAgdGhpcy4kZm9ybS50cmlnZ2VyKCdhdHRhY2hJbWFnZScpO1xuICAgICAgfVxuICAgIH0sXG5cbiAgICB1cGxvYWQ6IGZ1bmN0aW9uKCkge1xuICAgICAgdmFyIHRoaXNfID0gdGhpcztcbiAgICAgIHZhciBmb3JtRGF0YSA9IG5ldyBGb3JtRGF0YSh0aGlzLiRmb3JtWzBdKTtcbiAgICAgIGlmICh0aGlzLiQoJyN1c2VyLXByZWZlcmVuY2VzLWltYWdlLXVwbG9hZCcpWzBdLmZpbGVzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgJC5hamF4KHtcbiAgICAgICAgICB0eXBlOiAnUE9TVCcsXG4gICAgICAgICAgdXJsOiAnL3VwZGF0ZVVzZXJJbWFnZScsXG4gICAgICAgICAgZGF0YTogZm9ybURhdGEsXG4gICAgICAgICAgY2FjaGU6IGZhbHNlLFxuICAgICAgICAgIGRhdGFUeXBlOiAnanNvbicsXG4gICAgICAgICAgcHJvY2Vzc0RhdGE6IGZhbHNlLFxuICAgICAgICAgIGNvbnRlbnRUeXBlOiBmYWxzZSxcbiAgICAgICAgICBlcnJvcjogZnVuY3Rpb24oIHhociApIHtcbiAgICAgICAgICAgIHN3YWwoe1xuICAgICAgICAgICAgICB0aXRsZTogXCJPSCBOTyBPSCBOTyBPSCBOT1wiLFxuICAgICAgICAgICAgICB0ZXh0OiBcIllvdXIgaW1hZ2UuIEl0IHVoLCB3b24ndCBmaXQuICdUb28gYmlnJyB0aGUgY29tcHV0ZXIgbW9ua2V5cyBzYXkuIEVpdGhlciB0aGF0LCBvciBpdCdzIG5vdCBhIC5qcGVnLCAucG5nLCBvciAuZ2lmLiBCdXQgd2hhdCBkbyBJIGtub3csIEknbSBqdXN0IHRoZSBndXkgc3RhcmluZyBhdCB0aGUgY29tcHV0ZXIgc2NyZWVuIGJlaGluZCB5b3UuXCIsXG4gICAgICAgICAgICAgIGltYWdlVXJsOiAnL2ltZy9zY3ViYS1waWcucG5nJyxcbiAgICAgICAgICAgICAgY29uZmlybUJ1dHRvbkNvbG9yOiBcIiM3NDlDQThcIlxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfSxcbiAgICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbiggcmVzcG9uc2UgKSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZygnaW1nVXBsb2FkIHJlc3BvbnNlOiAnLCByZXNwb25zZSk7XG4gICAgICAgICAgICB2YXIgZm9ybSA9IHRoaXNfLmNyZWF0ZVVzZXJGb3JtRGF0YSgpO1xuICAgICAgICAgICAgZm9ybS51c2VySW1hZ2UgPSByZXNwb25zZS51c2VySW1hZ2U7XG4gICAgICAgICAgICB0aGlzXy52ZW50LnRyaWdnZXIoJ3VwZGF0ZVVzZXInLCBmb3JtKTtcbiAgICAgICAgICAgICQoJyN1c2VyLXByZWZlcmVuY2VzLW1vZGFsJykubW9kYWwoJ2hpZGUnKTtcbiAgICAgICAgICAgIHRoaXNfLmNsZWFyRmllbGQoKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdmFyIGZvcm0gPSB0aGlzLmNyZWF0ZVVzZXJGb3JtRGF0YSgpO1xuICAgICAgICB0aGlzLnZlbnQudHJpZ2dlcigndXBkYXRlVXNlcicsIGZvcm0pO1xuICAgICAgfVxuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH0sXG5cbiAgICBjcmVhdGVVc2VyRm9ybURhdGE6IGZ1bmN0aW9uKCkge1xuICAgICAgdmFyIGZvcm1EYXRhID0ge307XG4gICAgICB0aGlzLiQoJyN1c2VyLXByZWZlcmVuY2VzLWZvcm0nKS5maW5kKCAnaW5wdXQnICkuZWFjaChmdW5jdGlvbihpLCBlbCkge1xuICAgICAgICBpZiAoJChlbCkuZGF0YSgnY3JlYXRlJykgPT09ICdwcml2YWN5Jykge1xuICAgICAgICAgIHZhciB2YWwgPSAkKGVsKS5wcm9wKCdjaGVja2VkJyk7XG4gICAgICAgICAgZm9ybURhdGFbJ3ByaXZhY3knXSA9IHZhbDtcbiAgICAgICAgfSBlbHNlIGlmICgkKGVsKS52YWwoKSAhPT0gJycgJiYgJChlbCkudmFsKCkgIT09ICdvbicpIHtcbiAgICAgICAgICBmb3JtRGF0YVskKGVsKS5kYXRhKCdjcmVhdGUnKV0gPSAkKGVsKS52YWwoKTtcbiAgICAgICAgICAkKGVsKS52YWwoJycpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICAgIGRlbGV0ZSBmb3JtRGF0YS51bmRlZmluZWQ7XG4gICAgICByZXR1cm4gZm9ybURhdGE7XG4gICAgfSxcblxuICAgIGNsZWFyRmllbGQ6IGZ1bmN0aW9uKCkge1xuICAgICAgdGhpcy4kKCcjdXBsb2FkZWQtdXNlci1wcmVmZXJlbmNlcy1pbWFnZScpWzBdLnNyYyA9ICcnO1xuICAgICAgdGhpcy4kKCcjdXNlci1wcmVmZXJlbmNlcy1pbWFnZS11cGxvYWQnKS52YWwoJycpO1xuICAgIH0sXG5cbiAgICBzZXRIb21lUm9vbVR5ZXBhaGVhZDogZnVuY3Rpb24oKSB7XG4gICAgICB2YXIgdGhpc18gPSB0aGlzO1xuICAgICAgdmFyIGJsb29kID0gbmV3IEJsb29kaG91bmQoe1xuICAgICAgICBkYXR1bVRva2VuaXplcjogQmxvb2Rob3VuZC50b2tlbml6ZXJzLm9iai53aGl0ZXNwYWNlKCduYW1lJyksXG4gICAgICAgIHF1ZXJ5VG9rZW5pemVyOiBCbG9vZGhvdW5kLnRva2VuaXplcnMud2hpdGVzcGFjZSxcbiAgICAgICAgcHJlZmV0Y2g6IHtcbiAgICAgICAgICB1cmw6ICcvYXBpL3B1YmxpY0NoYXRyb29tcycsXG4gICAgICAgICAgZmlsdGVyOiBmdW5jdGlvbihkYXRhKSB7XG4gICAgICAgICAgICAgcmV0dXJuIF8ubWFwKGRhdGEsIGZ1bmN0aW9uKGNoYXRyb29tKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHsgbmFtZTogY2hhdHJvb20gfTtcbiAgICAgICAgICAgICB9KTtcbiAgICAgICAgICB9LFxuICAgICAgICAgIHR0bF9tczogMCxcbiAgICAgICAgfSxcbiAgICAgICAgcmVtb3RlOiB7XG4gICAgICAgICAgdXJsOiAnL2FwaS9zZWFyY2hDaGF0cm9vbXM/bmFtZT0lUVVFUlknLFxuICAgICAgICAgIHdpbGRjYXJkOiAnJVFVRVJZJyxcbiAgICAgICAgICByYXRlTGltaXRXYWl0OiAzMDAsXG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgICAgYmxvb2QuY2xlYXJQcmVmZXRjaENhY2hlKCk7XG4gICAgICBibG9vZC5pbml0aWFsaXplKCk7XG4gICAgICB2YXIgdHlwZSA9IHRoaXMuJCgnI3VzZXItcHJlZmVyZW5jZXMtaG9tZS1yb29tLWlucHV0JykudHlwZWFoZWFkKHtcbiAgICAgICAgbWluTGVuZ3RoOiAyLFxuICAgICAgICBjbGFzc05hbWVzOiB7XG4gICAgICAgICAgaW5wdXQ6ICd0eXBlYWhlYWQtaW5wdXQnLFxuICAgICAgICAgIGhpbnQ6ICd0eXBlYWhlYWQtaGludCcsXG4gICAgICAgICAgc2VsZWN0YWJsZTogJ3R5cGVhaGVhZC1zZWxlY3RhYmxlJyxcbiAgICAgICAgICBtZW51OiAndHlwZWFoZWFkLW1lbnUnLFxuICAgICAgICAgIGhpZ2hsaWdodDogJ3R5cGVhaGVhZC1oaWdobGlnaHQnLFxuICAgICAgICAgIGRhdGFzZXQ6ICd0eXBlYWhlYWQtZGF0YXNldCcsXG4gICAgICAgIH0sXG4gICAgICB9LFxuICAgICAge1xuICAgICAgICBsaW1pdDogNSxcbiAgICAgICAgc291cmNlOiBibG9vZCxcbiAgICAgICAgbmFtZTogJ2hvbWUtcm9vbS1zZWFyY2gnLFxuICAgICAgICBkaXNwbGF5OiAnbmFtZScsXG4gICAgICB9KS5vbigndHlwZWFoZWFkOnNlbGVjdCB0eXBlYWhlYWQ6YXV0b2NvbXBsZXRlJywgZnVuY3Rpb24ob2JqKSB7XG4gICAgICAgIHRoaXNfLmRvZXNIb21lUm9vbUV4aXN0KCk7XG4gICAgICB9KTtcbiAgICB9LFxuXG4gICAgZG9lc0hvbWVSb29tRXhpc3Q6IGZ1bmN0aW9uKCkge1xuICAgICAgdGhpcy4kKCcucm9vbS1uYW1lLXZhbGlkYXRpb24nKS5yZW1vdmVDbGFzcygnaW5wdXQtdmFsaWQgaW5wdXQtaW52YWxpZCcpO1xuICAgICAgdmFyIHRoaXNfID0gdGhpcztcbiAgICAgIHZhciBjaGVjayA9IGZ1bmN0aW9uKCkge1xuICAgICAgICBpZiAoJC50cmltKCQoJyN1c2VyLXByZWZlcmVuY2VzLWhvbWUtcm9vbS1pbnB1dCcpLnZhbCgpKS5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgdmFyIGNoYXRyb29tTmFtZSA9ICQoJyN1c2VyLXByZWZlcmVuY2VzLWhvbWUtcm9vbS1pbnB1dCcpLnZhbCgpO1xuICAgICAgICAgIHRoaXNfLnZlbnQudHJpZ2dlcignZG9lc0hvbWVSb29tRXhpc3QnLCBjaGF0cm9vbU5hbWUpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgdGhpc18uJCgnI3VzZXItcHJlZmVyZW5jZXMtaG9tZS1yb29tLWlucHV0JykuY2hpbGRyZW4oKS5yZW1vdmUoKTtcbiAgICAgICAgIHRoaXNfLiQoJyN1c2VyLXByZWZlcmVuY2VzLWhvbWUtcm9vbS1pbnB1dCcpLnJlbW92ZUNsYXNzKCdpbnB1dC12YWxpZCBpbnB1dC1pbnZhbGlkJyk7XG4gICAgICAgfVxuICAgICB9O1xuICAgICBfLmRlYm91bmNlKGNoZWNrKCksIDMwKTtcbiAgIH0sXG5cbiAgIHJlbmRlckhvbWVSb29tQXZhaWxhYmlsaXR5OiBmdW5jdGlvbihhdmFpbGFiaWxpdHkpIHtcblxuICAgIHRoaXMuJCgnLnJvb20tbmFtZS12YWxpZGF0aW9uJykucmVtb3ZlQ2xhc3MoJ2lucHV0LXZhbGlkIGlucHV0LWludmFsaWQnKTtcbiAgICB0aGlzLiQoJy5yb29tLW5hbWUtdmFsaWRhdGlvbi1tZXNzYWdlJykuY2hpbGRyZW4oKS5yZW1vdmUoKTtcbiAgICBpZiAoYXZhaWxhYmlsaXR5ID09PSBmYWxzZSkge1xuICAgICAgdGhpcy4kKCcucm9vbS1uYW1lLXZhbGlkYXRpb24nKS5hZGRDbGFzcygnaW5wdXQtdmFsaWQnKTtcbiAgICAgIHRoaXMuJCgnLnJvb20tbmFtZS12YWxpZGF0aW9uLW1lc3NhZ2UnKS5hcHBlbmQoJzxkaXYgaWQ9XCIjY2hhdHJvb20tbmFtZS12YWxpZGF0aW9uXCIgY2xhc3M9XCJmYSBmYS1jaGVja1wiPjwvZGl2PicpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLiQoJy5yb29tLW5hbWUtdmFsaWRhdGlvbicpLmFkZENsYXNzKCdpbnB1dC1pbnZhbGlkIGZhIGZhLXRpbWVzJyk7XG4gICAgICB0aGlzLiQoJy5yb29tLW5hbWUtdmFsaWRhdGlvbi1tZXNzYWdlJykuYXBwZW5kKCc8ZGl2IGlkPVwiI2NoYXRyb29tLW5hbWUtdmFsaWRhdGlvblwiIGNsYXNzPVwiZmEgZmEtdGltZXNcIj5DaGF0cm9vbSBEb2VzIE5vdCBFeGlzdDwvZGl2PicpO1xuICAgIH1cbiAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkge1xuICAgICAgdGhpcy4kKCcucm9vbS1uYW1lLXZhbGlkYXRpb24tbWVzc2FnZScpLmNoaWxkcmVuKCkuZmFkZU91dCg2MDAsIGZ1bmN0aW9uKCl7XG4gICAgICAgICQodGhpcykuY2hpbGRyZW4oKS5yZW1vdmUoKTtcbiAgICAgIH0pO1xuICAgIH0sIDIwMDApO1xuICB9LFxuXG4gIH0pO1xuXG59KShqUXVlcnkpOyIsInZhciBhcHAgPSBhcHAgfHwge307XG5cbihmdW5jdGlvbiAoJCkge1xuXG4gIGFwcC5SZWdpc3RlclZpZXcgPSBCYWNrYm9uZS5WaWV3LmV4dGVuZCh7XG4gICAgdGVtcGxhdGU6IF8udGVtcGxhdGUoJCgnI3JlZ2lzdGVyJykuaHRtbCgpKSxcbiAgICBpbnZhbGlkVGVtcGxhdGU6IF8udGVtcGxhdGUoJzxkaXYgY2xhc3M9XCJ1c2VyLWluZm8taW52YWxpZCBmYSBmYS10aW1lc1wiPjwlPSBtZXNzYWdlICU+PC9kaXY+JyksXG4gICAgdmFsaWRUZW1wbGF0ZTogXy50ZW1wbGF0ZSgnPGRpdiBjbGFzcz1cInVzZXItaW5mby12YWxpZCBmYSBmYS1jaGVja1wiPjwlPSBtZXNzYWdlICU+PC9kaXY+JyksXG4gICAgZXZlbnRzOiB7XG4gICAgICBcInN1Ym1pdFwiOiBcInN1Ym1pdFwiLFxuICAgICAgXCJrZXl1cCAjdXNlcm5hbWVcIjogXCJ2YWxpZGF0ZVVzZXJuYW1lXCIsXG4gICAgICBcImtleXVwICNlbWFpbFwiOiBcInZhbGlkYXRlRW1haWxcIixcbiAgICAgIFwia2V5dXAgI3JldHlwZVBhc3N3b3JkXCI6IFwidmFsaWRhdGVQYXNzd29yZFwiLFxuICAgIH0sXG4gICAgaW5pdGlhbGl6ZTogZnVuY3Rpb24ob3B0aW9ucykge1xuICAgICAgdGhpcy5yZW5kZXIoKTtcbiAgICAgIHRoaXMudmVudCA9IG9wdGlvbnMudmVudDtcbiAgICB9LFxuICAgIHN1Ym1pdDogZnVuY3Rpb24oZSkge1xuICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgdmFyIHBhc3N3b3JkVmFsaWRhdGlvbiA9IHRoaXMudmFsaWRhdGVQYXNzd29yZCgpO1xuICAgICAgaWYgKHBhc3N3b3JkVmFsaWRhdGlvbikge1xuICAgICAgICB0aGlzLnNpZ25VcCgpO1xuICAgICAgfSBlbHNlIHtcblxuICAgICAgfVxuICAgIH0sXG4gICAgaGVscGVyczogZnVuY3Rpb24oKSB7XG4gICAgICB0aGlzLmluc3RydWN0aW9ucygpO1xuICAgIH0sXG4gICAgaW5zdHJ1Y3Rpb25zOiBmdW5jdGlvbigpIHtcbiAgICAgICQoJ2lucHV0Jykub24oJ2ZvY3VzJywgZnVuY3Rpb24oZSkge1xuICAgICAgICAgJCh0aGlzKS5wYXJlbnQoKS5maW5kKFwibGFiZWxbZm9yPVwiK2UudGFyZ2V0Lm5hbWUrXCJdXCIpLmZhZGVJbig0MDApO1xuICAgICAgfSk7XG4gICAgICAkKCdpbnB1dCcpLm9uKCdibHVyJywgZnVuY3Rpb24oZSkge1xuICAgICAgICAgJCh0aGlzKS5wYXJlbnQoKS5maW5kKFwibGFiZWxbZm9yPVwiK2UudGFyZ2V0Lm5hbWUrXCJdXCIpLmZhZGVPdXQoNDAwKTtcbiAgICAgIH0pO1xuICAgIH0sXG4gICAgcmVuZGVyOiBmdW5jdGlvbigpIHtcbiAgICAgIHRoaXMuJGVsLmh0bWwodGhpcy50ZW1wbGF0ZSgpKTtcbiAgICAgIHJldHVybiB0aGlzO1xuICAgIH0sXG4gICAgc2lnblVwOiBmdW5jdGlvbigpIHtcbiAgICAgIHZhciB0aGlzXyA9IHRoaXM7XG4gICAgICB2YXIgc2VuZERhdGEgPSB7XG4gICAgICAgIHVzZXJuYW1lOiB0aGlzLiQoJyN1c2VybmFtZScpLnZhbCgpLFxuICAgICAgICBwYXNzd29yZDogdGhpcy4kKCcjcGFzc3dvcmQnKS52YWwoKSxcbiAgICAgICAgbmFtZTogdGhpcy4kKCcjbmFtZScpLnZhbCgpLFxuICAgICAgICBlbWFpbDogdGhpcy4kKCcjZW1haWwnKS52YWwoKVxuICAgICAgfTtcbiAgICAgICQuYWpheCh7XG4gICAgICAgIHVybDogXCIvcmVnaXN0ZXJcIixcbiAgICAgICAgbWV0aG9kOiAnUE9TVCcsXG4gICAgICAgIGRhdGE6IHNlbmREYXRhLFxuICAgICAgICBzdWNjZXNzOiBmdW5jdGlvbihkYXRhKSB7XG4gICAgICAgICAgaWYgKGRhdGEubWVzc2FnZSkge1xuICAgICAgICAgICAgdGhpc18ucmVuZGVyVmFsaWRhdGlvbih0aGlzXy5lcnJvclRlbXBsYXRlKGRhdGEpKTtcbiAgICAgICAgICB9IGVsc2UgaWYgKGRhdGEudXNlcikge1xuICAgICAgICAgICAgYXBwLkNoYXRyb29tUm91dGVyLm5hdmlnYXRlKCdhdXRoJywgeyB0cmlnZ2VyOiB0cnVlIH0pO1xuICAgICAgICAgICAgdGhpc18udmVudC50cmlnZ2VyKFwibG9naW5cIiwgZGF0YS51c2VyKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY29uc29sZS5sb2coJ29vcHMsIHRoZSBlbHNlOiAnLCBkYXRhKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH0sXG4gICAgdmFsaWRhdGVVc2VybmFtZTogZnVuY3Rpb24oKSB7XG4gICAgICBpZiAoJCgnI3VzZXJuYW1lJykudmFsKCkubGVuZ3RoIDwgNSkgeyByZXR1cm47IH1cbiAgICAgIHZhciB0aGlzXyA9IHRoaXM7XG4gICAgICBfLmRlYm91bmNlKCQucG9zdCgnL3VzZXJuYW1lVmFsaWRhdGlvbicsIHsgdXNlcm5hbWU6ICQoJyN1c2VybmFtZScpLnZhbCgpIH0sZnVuY3Rpb24oZGF0YSkge1xuICAgICAgICAgZGF0YS51c2VybmFtZUF2YWlsYWJsZSA/XG4gICAgICAgICAgIHRoaXNfLnJlbmRlclZhbGlkYXRpb24odGhpc18udmFsaWRUZW1wbGF0ZSh7bWVzc2FnZTogJyB1c2VybmFtZSBhdmFpbGFibGUnfSkpXG4gICAgICAgICA6XG4gICAgICAgICAgIHRoaXNfLnJlbmRlclZhbGlkYXRpb24odGhpc18uaW52YWxpZFRlbXBsYXRlKHttZXNzYWdlOiAnIHVzZXJuYW1lIHRha2VuJ30pKTtcbiAgICAgIH0pLCAxNTApO1xuICAgIH0sXG4gICAgdmFsaWRhdGVFbWFpbDogZnVuY3Rpb24oKSB7XG4gICAgICBpZiAoISQoJyNlbWFpbCcpLnZhbCgpLm1hdGNoKC9eXFxTK0BcXFMrXFwuXFxTKyQvKSkgeyByZXR1cm47IH1cbiAgICAgIHZhciB0aGlzXyA9IHRoaXM7XG4gICAgICBfLmRlYm91bmNlKCQucG9zdCgnL2VtYWlsVmFsaWRhdGlvbicsIHsgZW1haWw6ICQoJyNlbWFpbCcpLnZhbCgpIH0sZnVuY3Rpb24oZGF0YSkge1xuICAgICAgICAgZGF0YS5lbWFpbEF2YWlsYWJsZSA/XG4gICAgICAgICAgIHRoaXNfLnJlbmRlclZhbGlkYXRpb24odGhpc18udmFsaWRUZW1wbGF0ZSh7bWVzc2FnZTogJyBlbWFpbCBhdmFpbGFibGUnfSkpXG4gICAgICAgICA6XG4gICAgICAgICAgIHRoaXNfLnJlbmRlclZhbGlkYXRpb24odGhpc18uaW52YWxpZFRlbXBsYXRlKHttZXNzYWdlOiAnIGVtYWlsIHRha2VuJ30pKTtcbiAgICAgIH0pLCAxNTApO1xuICAgIH0sXG4gICAgcmVuZGVyVmFsaWRhdGlvbjogZnVuY3Rpb24od2hhdCkge1xuICAgICAgJCgnLnJlZ2lzdGVyLWVycm9yLWNvbnRhaW5lcicpLmVtcHR5KCk7XG4gICAgICAkKHdoYXQpLmFwcGVuZFRvKCQoJy5yZWdpc3Rlci1lcnJvci1jb250YWluZXInKSkuaGlkZSgpLmZhZGVJbigpO1xuICAgICAgdGhpcy52YWxpZGF0aW9udGltb3V0ID0gbnVsbDtcbiAgICAgIGNsZWFyVGltZW91dCh0aGlzLnZhbGlkYXRpb25UaW1lb3V0KTtcbiAgICAgIHRoaXMudmFsaWRhdGlvblRpbWVvdXQgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkge1xuICAgICAgICAkKCcucmVnaXN0ZXItZXJyb3ItY29udGFpbmVyJykuY2hpbGRyZW4oKS5maXJzdCgpLmZhZGVPdXQoKTtcbiAgICAgIH0sIDIwMDApO1xuICAgIH0sXG4gICAgdmFsaWRhdGVQYXNzd29yZDogZnVuY3Rpb24oKSB7XG4gICAgICBpZiAoJCgnI3JldHlwZVBhc3N3b3JkJykudmFsKCkubGVuZ3RoID4gNSkge1xuICAgICAgICBpZiAoJCgnI3Bhc3N3b3JkJykudmFsKCkgIT09ICQoJyNyZXR5cGVQYXNzd29yZCcpLnZhbCgpKSB7XG4gICAgICAgICAgdGhpcy5yZW5kZXJWYWxpZGF0aW9uKHRoaXMuaW52YWxpZFRlbXBsYXRlKHttZXNzYWdlOiAnIHBhc3N3b3JkIGRvZXMgbm90IG1hdGNoJ30pKTtcbiAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhpcy5yZW5kZXJWYWxpZGF0aW9uKHRoaXMudmFsaWRUZW1wbGF0ZSh7bWVzc2FnZTogJyBwYXNzd29yZCBtYXRjaCd9KSk7XG4gICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9LFxuXG4gIH0pO1xuXG59KShqUXVlcnkpOyIsIlxuLy8gVGhlIENoYXRDbGllbnQgaXMgaW1wbGVtZW50ZWQgb24gbWFpbi5qcy5cbi8vIFRoZSBjaGF0Y2xpZW50IGlzIGEgY29uc3RydWN0b3IgZnVuY3Rpb24gb24gdGhlIE1haW5Db250cm9sbGVyLlxuLy8gSXQgYm90aCBsaXN0ZW5zIHRvIGFuZCBlbWl0cyBldmVudHMgb24gdGhlIHNvY2tldCwgZWc6XG4vLyBJdCBoYXMgaXRzIG93biBtZXRob2RzIHRoYXQsIHdoZW4gY2FsbGVkLCBlbWl0IHRvIHRoZSBzb2NrZXQgdy8gZGF0YS5cbi8vIEl0IGFsc28gc2V0cyByZXNwb25zZSBsaXN0ZW5lcnMgb24gY29ubmVjdGlvbiwgdGhlc2UgcmVzcG9uc2UgbGlzdGVuZXJzXG4vLyBsaXN0ZW4gdG8gdGhlIHNvY2tldCBhbmQgdHJpZ2dlciBldmVudHMgb24gdGhlIGFwcEV2ZW50QnVzIG9uIHRoZSBcbi8vIE1haW5Db250cm9sbGVyXG52YXIgQ2hhdENsaWVudCA9IGZ1bmN0aW9uKG9wdGlvbnMpIHtcblxuXHR2YXIgc2VsZiA9IHRoaXM7XG5cblx0Ly8gaXMtdHlwaW5nIGhlbHBlciB2YXJpYWJsZXNcblx0dmFyIFRZUElOR19USU1FUl9MRU5HVEggPSA0MDA7IC8vIG1zXG4gIHZhciB0eXBpbmcgPSBmYWxzZTtcbiAgdmFyIGxhc3RUeXBpbmdUaW1lO1xuICBcbiAgLy8gdGhpcyB2ZW50IGhvbGRzIHRoZSBhcHBFdmVudEJ1c1xuXHRzZWxmLnZlbnQgPSBvcHRpb25zLnZlbnQ7XG5cblx0c2VsZi5ob3N0bmFtZSA9ICdodHRwOi8vJyArIHdpbmRvdy5sb2NhdGlvbi5ob3N0O1xuXG4gIC8vIGNvbm5lY3RzIHRvIHNvY2tldCwgc2V0cyByZXNwb25zZSBsaXN0ZW5lcnNcblx0c2VsZi5jb25uZWN0ID0gZnVuY3Rpb24oKSB7XG4gICAgY29uc29sZS5sb2coJ3NjLmYuY29ubmVjdCcpO1xuXHRcdC8vIHRoaXMgaW8gbWlnaHQgYmUgYSBsaXR0bGUgY29uZnVzaW5nLi4uIHdoZXJlIGlzIGl0IGNvbWluZyBmcm9tP1xuXHRcdC8vIGl0J3MgY29taW5nIGZyb20gdGhlIHN0YXRpYyBtaWRkbGV3YXJlIG9uIHNlcnZlci5qcyBiYyBldmVyeXRoaW5nXG5cdFx0Ly8gaW4gdGhlIC9wdWJsaWMgZm9sZGVyIGhhcyBiZWVuIGF0dGFjaGVkIHRvIHRoZSBzZXJ2ZXIsIGFuZCB2aXNhXG5cdFx0Ly8gdmVyc2EuXG5cbiAgICAvLyBsb2NhbFxuICAgICAgLy8gc2VsZi5zb2NrZXQgPSBpby5jb25uZWN0KHNlbGYuaG9zdG5hbWUpO1xuXG4gICAgLy8gaGVyb2t1XG4gICAgICBzZWxmLnNvY2tldCA9IGlvLmNvbm5lY3QoJ2h0dHA6Ly93d3cuY2hqYXQuY29tLycsIHsgdHJhbnNwb3J0czogWyd3ZWJzb2NrZXQnXSB9ICk7XG5cbiAgICBzZWxmLnNldFJlc3BvbnNlTGlzdGVuZXJzKHNlbGYuc29ja2V0KTtcbiAgfTtcblxuXG5cbi8vLy8vIFZpZXdFdmVudEJ1cyBtZXRob2RzIC8vLy9cbiAgICAvLyBtZXRob2RzIHRoYXQgZW1pdCB0byB0aGUgY2hhdHNlcnZlclxuXG4vLyBMT0dJTlxuICBzZWxmLmxvZ2luID0gZnVuY3Rpb24odXNlcikge1xuICAgIGNvbnNvbGUubG9nKCdzYy5mLmxvZ2luOiAnLCB1c2VyKTtcbiAgICBzZWxmLnNvY2tldC5lbWl0KFwibG9naW5cIiwgdXNlcik7XG4gIH07XG4gIHNlbGYubG9nb3V0ID0gZnVuY3Rpb24oKSB7XG4gICAgY29uc29sZS5sb2coJ3NjLmYubG9nb3V0OiAnKTtcbiAgICBzZWxmLnNvY2tldC5lbWl0KFwibG9nb3V0XCIpO1xuICB9O1xuXG5cbi8vIFJPT01cbiAgc2VsZi5jb25uZWN0VG9Sb29tID0gZnVuY3Rpb24ocm9vbU5hbWUpIHtcbiAgICBjb25zb2xlLmxvZygnc2MuZi5jb25uZWN0VG9Sb29tJyk7XG4gICAgc2VsZi5zb2NrZXQuZW1pdChcImNvbm5lY3RUb1Jvb21cIiwgcm9vbU5hbWUpO1xuICB9O1xuICBzZWxmLmpvaW5Sb29tID0gZnVuY3Rpb24ocm9vbU5hbWUpIHtcbiAgICBzZWxmLnNvY2tldC5lbWl0KCdqb2luUm9vbScsIHJvb21OYW1lKTtcbiAgfTtcbiAgc2VsZi5hZGRSb29tID0gZnVuY3Rpb24ocm9vbU5hbWUpIHtcbiAgICBjb25zb2xlLmxvZygnc2MuZi5hZGRSb29tJyk7XG4gICAgc2VsZi5zb2NrZXQuZW1pdChcImFkZFJvb21cIiwgcm9vbU5hbWUpO1xuICB9O1xuICBzZWxmLnJlbW92ZVJvb20gPSBmdW5jdGlvbihyb29tRGF0YSkge1xuICAgIGNvbnNvbGUubG9nKCdzYy5mLnJlbW92ZVJvb20nKTtcbiAgICBzZWxmLnNvY2tldC5lbWl0KFwicmVtb3ZlUm9vbVwiLCByb29tRGF0YSk7XG4gIH07XG4gIHNlbGYuY3JlYXRlUm9vbSA9IGZ1bmN0aW9uKGZvcm1EYXRhKSB7XG4gICAgY29uc29sZS5sb2coJ3NjLmYuY3JlYXRlUm9vbScpO1xuICAgIHNlbGYuc29ja2V0LmVtaXQoXCJjcmVhdGVSb29tXCIsIGZvcm1EYXRhKTtcbiAgfTtcbiAgc2VsZi51cGRhdGVSb29tID0gZnVuY3Rpb24oZm9ybURhdGEpIHtcbiAgICBjb25zb2xlLmxvZygnc2MuZi51cGRhdGVSb29tJyk7XG4gICAgc2VsZi5zb2NrZXQuZW1pdChcInVwZGF0ZVJvb21cIiwgZm9ybURhdGEpO1xuICB9O1xuICBzZWxmLmRlc3Ryb3lSb29tID0gZnVuY3Rpb24ocm9vbUluZm8pIHtcbiAgICBjb25zb2xlLmxvZygnc2MuZi5kZXN0cm95Um9vbScpO1xuICAgIHNlbGYuc29ja2V0LmVtaXQoXCJkZXN0cm95Um9vbVwiLCByb29tSW5mbyk7XG4gIH07XG5cblxuLy8gQ0hBVFxuICBzZWxmLmNoYXQgPSBmdW5jdGlvbihjaGF0KSB7XG4gICAgY29uc29sZS5sb2coJ3NjLmYuY2hhdDogJywgY2hhdCk7XG5cdFx0c2VsZi5zb2NrZXQuZW1pdChcImNoYXRcIiwgY2hhdCk7XG5cdH07XG4gIHNlbGYuZ2V0TW9yZUNoYXRzID0gZnVuY3Rpb24oY2hhdFJlcSkge1xuICAgIHNlbGYuc29ja2V0LmVtaXQoJ2dldE1vcmVDaGF0cycsIGNoYXRSZXEpO1xuICB9O1xuXG5cbi8vIERJUkVDVCBNRVNTQUdFXG4gIHNlbGYuaW5pdERpcmVjdE1lc3NhZ2UgPSBmdW5jdGlvbihyZWNpcGllbnQpIHtcbiAgICBzZWxmLnNvY2tldC5lbWl0KCdpbml0RGlyZWN0TWVzc2FnZScsIHJlY2lwaWVudCk7XG4gIH07XG4gIHNlbGYuZGlyZWN0TWVzc2FnZSA9IGZ1bmN0aW9uKGRpcmVjdE1lc3NhZ2UpIHtcbiAgICBzZWxmLnNvY2tldC5lbWl0KCdkaXJlY3RNZXNzYWdlJywgZGlyZWN0TWVzc2FnZSk7XG4gIH07XG4gIHNlbGYuZ2V0TW9yZURpcmVjdE1lc3NhZ2VzID0gZnVuY3Rpb24oZGlyZWN0TWVzc2FnZVJlcSkge1xuICAgIHNlbGYuc29ja2V0LmVtaXQoJ2dldE1vcmVEaXJlY3RNZXNzYWdlcycsIGRpcmVjdE1lc3NhZ2VSZXEpO1xuICB9O1xuICBcblxuLy8gVFlQSU5HXG5cdHNlbGYuYWRkQ2hhdFR5cGluZyA9IGZ1bmN0aW9uKGRhdGEpIHtcbiAgICB2YXIgbWVzc2FnZSA9IGRhdGEudXNlcm5hbWUgKyAnIGlzIHR5cGluZyc7XG4gICAgJCgnLnR5cGV0eXBldHlwZScpLnRleHQobWVzc2FnZSk7XG5cdH07XG5cdHNlbGYucmVtb3ZlQ2hhdFR5cGluZyA9IGZ1bmN0aW9uKCkge1xuICAgICQoJy50eXBldHlwZXR5cGUnKS5lbXB0eSgpO1xuXHR9O1xuICBzZWxmLnVwZGF0ZVR5cGluZyA9IGZ1bmN0aW9uKCkge1xuICAgIGlmIChzZWxmLnNvY2tldCkge1xuICAgICAgaWYgKCF0eXBpbmcpIHtcbiAgICAgICAgdHlwaW5nID0gdHJ1ZTtcbiAgICAgICAgc2VsZi5zb2NrZXQuZW1pdCgndHlwaW5nJyk7XG4gICAgICB9XG4gICAgICBsYXN0VHlwaW5nVGltZSA9IChuZXcgRGF0ZSgpKS5nZXRUaW1lKCk7XG4gICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkge1xuICAgICAgICB2YXIgdHlwaW5nVGltZXIgPSAobmV3IERhdGUoKSkuZ2V0VGltZSgpO1xuICAgICAgICB2YXIgdGltZURpZmYgPSB0eXBpbmdUaW1lciAtIGxhc3RUeXBpbmdUaW1lO1xuICAgICAgICBpZiAodGltZURpZmYgPj0gVFlQSU5HX1RJTUVSX0xFTkdUSCAmJiB0eXBpbmcpIHtcbiAgICAgICAgICAgc2VsZi5zb2NrZXQuZW1pdCgnc3RvcCB0eXBpbmcnKTtcbiAgICAgICAgICAgdHlwaW5nID0gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgIH0sIFRZUElOR19USU1FUl9MRU5HVEgpO1xuICAgIH1cbiAgfTtcblxuXG4vLyBJTlZJVEFUSU9OU1xuICBzZWxmLmludml0ZVVzZXIgPSBmdW5jdGlvbihpbnZpdGF0aW9uT2JqKSB7XG4gICAgc2VsZi5zb2NrZXQuZW1pdChcImludml0ZVVzZXJcIiwgaW52aXRhdGlvbk9iaik7XG4gIH07XG4gIHNlbGYuZGVsZXRlSW52aXRhdGlvbiA9IGZ1bmN0aW9uKHJvb21JZCkge1xuICAgIHNlbGYuc29ja2V0LmVtaXQoXCJkZWxldGVJbnZpdGF0aW9uXCIsIHJvb21JZCk7XG4gIH07XG4gIHNlbGYuYWNjZXB0SW52aXRhdGlvbiA9IGZ1bmN0aW9uKHJvb21JZCkge1xuICAgIHNlbGYuc29ja2V0LmVtaXQoXCJhY2NlcHRJbnZpdGF0aW9uXCIsIHJvb21JZCk7XG4gIH07XG5cbi8vIFVQREFURSBVU0VSXG4gIHNlbGYudXBkYXRlVXNlciA9IGZ1bmN0aW9uKHVzZXJPYmopIHtcbiAgICBzZWxmLnNvY2tldC5lbWl0KFwidXBkYXRlVXNlclwiLCB1c2VyT2JqKTtcbiAgfTtcblxuXG4vLyBFUlJPUiBIQU5ETElOR1xuICBzZWxmLmRvZXNDaGF0cm9vbUV4aXN0ID0gZnVuY3Rpb24oY2hhdHJvb21RdWVyeSkge1xuICAgIHNlbGYuc29ja2V0LmVtaXQoJ2RvZXNDaGF0cm9vbUV4aXN0JywgY2hhdHJvb21RdWVyeSk7XG4gIH07XG4gIHNlbGYuZG9lc0hvbWVSb29tRXhpc3QgPSBmdW5jdGlvbihob21lUm9vbVF1ZXJ5KSB7XG4gICAgc2VsZi5zb2NrZXQuZW1pdCgnZG9lc0hvbWVSb29tRXhpc3QnLCBob21lUm9vbVF1ZXJ5KTtcbiAgfTtcbiAgc2VsZi5kb2VzU2VhcmNoQ2hhdHJvb21FeGlzdCA9IGZ1bmN0aW9uKGhvbWVSb29tUXVlcnkpIHtcbiAgICBzZWxmLnNvY2tldC5lbWl0KCdkb2VzU2VhcmNoQ2hhdHJvb21FeGlzdCcsIGhvbWVSb29tUXVlcnkpO1xuICB9O1xuXG5cbiAgXG5cblxuXG5cbiAgLy8vLy8vLy8vLy8vLy8gY2hhdHNlcnZlciBsaXN0ZW5lcnMvLy8vLy8vLy8vLy8vXG5cbiAgLy8gdGhlc2UgZ3V5cyBsaXN0ZW4gdG8gdGhlIGNoYXRzZXJ2ZXIvc29ja2V0IGFuZCBlbWl0IGRhdGEgdG8gbWFpbi5qcyxcbiAgLy8gc3BlY2lmaWNhbGx5IHRvIHRoZSBhcHBFdmVudEJ1cy5cblx0c2VsZi5zZXRSZXNwb25zZUxpc3RlbmVycyA9IGZ1bmN0aW9uKHNvY2tldCkge1xuXG5cbi8vIExPR0lOXG4gICAgc29ja2V0Lm9uKCdpbml0VXNlcicsIGZ1bmN0aW9uKHVzZXIpIHtcbiAgICAgIGNvbnNvbGUubG9nKCdzYy5lLmluaXRVc2VyJyk7XG4gICAgICBzZWxmLnZlbnQudHJpZ2dlcignaW5pdFVzZXInLCB1c2VyKTtcbiAgICAgIHNlbGYuY29ubmVjdFRvUm9vbSh1c2VyLmhvbWVSb29tKTtcbiAgICB9KTtcblxuXG4vLyBDSEFUXG5cdFx0c29ja2V0Lm9uKCd1c2VySm9pbmVkJywgZnVuY3Rpb24odXNlcikge1xuXHRcdFx0Y29uc29sZS5sb2coJ3NjLmUudXNlckpvaW5lZCcpO1xuXHRcdFx0c2VsZi52ZW50LnRyaWdnZXIoXCJ1c2VySm9pbmVkXCIsIHVzZXIpO1xuXHRcdH0pO1xuXHRcdHNvY2tldC5vbigndXNlckxlZnQnLCBmdW5jdGlvbih1c2VyKSB7XG5cdFx0XHRjb25zb2xlLmxvZygnc2MuZS51c2VyTGVmdCcpO1xuXHRcdFx0c2VsZi52ZW50LnRyaWdnZXIoXCJ1c2VyTGVmdFwiLCB1c2VyKTtcblx0XHR9KTtcblx0XHRzb2NrZXQub24oJ2NoYXQnLCBmdW5jdGlvbihjaGF0KSB7XG5cdFx0XHRjb25zb2xlLmxvZygnc2MuZS5jaGF0Jyk7XG5cdFx0XHRzZWxmLnZlbnQudHJpZ2dlcihcImNoYXRSZWNlaXZlZFwiLCBjaGF0KTtcblx0XHR9KTtcbiAgICBzb2NrZXQub24oJ21vcmVDaGF0cycsIGZ1bmN0aW9uKGNoYXRzKSB7XG4gICAgICBzZWxmLnZlbnQudHJpZ2dlcihcIm1vcmVDaGF0c1wiLCBjaGF0cyk7XG4gICAgfSk7XG4gICAgc29ja2V0Lm9uKCdub01vcmVDaGF0cycsIGZ1bmN0aW9uKCkge1xuICAgICAgc2VsZi52ZW50LnRyaWdnZXIoXCJub01vcmVDaGF0c1wiKTtcbiAgICB9KTtcblxuXG4vLyBESVJFQ1QgTUVTU0FHRVxuICAgIHNvY2tldC5vbignc2V0RGlyZWN0TWVzc2FnZUNoYXRsb2cnLCBmdW5jdGlvbihjaGF0bG9nKSB7XG4gICAgICBzZWxmLnZlbnQudHJpZ2dlcihcInNldERNY2hhdGxvZ1wiLCBjaGF0bG9nKTtcbiAgICB9KTtcbiAgICBzb2NrZXQub24oJ3NldERpcmVjdE1lc3NhZ2VIZWFkZXInLCBmdW5jdGlvbihoZWFkZXIpIHtcbiAgICAgIHNlbGYudmVudC50cmlnZ2VyKFwic2V0RE1oZWFkZXJcIiwgaGVhZGVyKTtcbiAgICB9KTtcbiAgICBzb2NrZXQub24oJ2RpcmVjdE1lc3NhZ2UnLCBmdW5jdGlvbihtZXNzYWdlKSB7XG4gICAgICBzZWxmLnZlbnQudHJpZ2dlcihcImRpcmVjdE1lc3NhZ2VSZWNlaXZlZFwiLCBtZXNzYWdlKTtcbiAgICB9KTtcblxuXG5cbi8vIFRZUElOR1xuICAgIHNvY2tldC5vbigndHlwaW5nJywgZnVuY3Rpb24oZGF0YSkge1xuICAgICAgc2VsZi5hZGRDaGF0VHlwaW5nKGRhdGEpO1xuICAgIH0pO1xuICAgIHNvY2tldC5vbignc3RvcCB0eXBpbmcnLCBmdW5jdGlvbigpIHtcbiAgICAgIHNlbGYucmVtb3ZlQ2hhdFR5cGluZygpO1xuICAgIH0pO1xuXG5cbi8vIFNFVCBST09NXG4gICAgc29ja2V0Lm9uKCdjaGF0bG9nJywgZnVuY3Rpb24oY2hhdGxvZykge1xuICAgICAgY29uc29sZS5sb2coJ3NjLmUuY2hhdGxvZycpO1xuICAgICAgc2VsZi52ZW50LnRyaWdnZXIoXCJzZXRDaGF0bG9nXCIsIGNoYXRsb2cpO1xuICAgIH0pO1xuICAgIHNvY2tldC5vbignY2hhdHJvb21zJywgZnVuY3Rpb24oY2hhdHJvb21zKSB7XG4gICAgICBjb25zb2xlLmxvZygnc2MuZS5jaGF0cm9vbXMnKTtcbiAgICAgIHNlbGYudmVudC50cmlnZ2VyKFwic2V0Q2hhdHJvb21zXCIsIGNoYXRyb29tcyk7XG4gICAgfSk7XG4gICAgc29ja2V0Lm9uKCdwcml2YXRlUm9vbXMnLCBmdW5jdGlvbihyb29tcykge1xuICAgICAgY29uc29sZS5sb2coJ3NjLmUucHJpdmF0ZVJvb21zJyk7XG4gICAgICBzZWxmLnZlbnQudHJpZ2dlcihcInNldFByaXZhdGVSb29tc1wiLCByb29tcyk7XG4gICAgfSk7XG4gICAgc29ja2V0Lm9uKCdvbmxpbmVVc2VycycsIGZ1bmN0aW9uKG9ubGluZVVzZXJzKSB7XG4gICAgICBjb25zb2xlLmxvZygnc2MuZS5vbmxpbmVVc2VycycpO1xuICAgICAgc2VsZi52ZW50LnRyaWdnZXIoXCJzZXRPbmxpbmVVc2Vyc1wiLCBvbmxpbmVVc2Vycyk7XG4gICAgfSk7XG4gICAgc29ja2V0Lm9uKCdvZmZsaW5lVXNlcnMnLCBmdW5jdGlvbihvZmZsaW5lVXNlcnMpIHtcbiAgICAgIGNvbnNvbGUubG9nKCdzYy5lLm9mZmxpbmVVc2VycycpO1xuICAgICAgc2VsZi52ZW50LnRyaWdnZXIoXCJzZXRPZmZsaW5lVXNlcnNcIiwgb2ZmbGluZVVzZXJzKTtcbiAgICB9KTtcbiAgICBzb2NrZXQub24oJ2NoYXRyb29tSGVhZGVyJywgZnVuY3Rpb24oaGVhZGVyT2JqKSB7XG4gICAgICBjb25zb2xlLmxvZygnc2MuZS5jaGF0cm9vbUhlYWRlcicpO1xuICAgICAgc2VsZi52ZW50LnRyaWdnZXIoXCJzZXRDaGF0cm9vbUhlYWRlclwiLCBoZWFkZXJPYmopO1xuICAgIH0pO1xuXG5cbi8vIFJFRElSRUNUIFRPIEhPTUUgUk9PTVxuICAgIHNvY2tldC5vbigncmVkaXJlY3RUb0hvbWVSb29tJywgZnVuY3Rpb24oZGF0YSkge1xuICAgICAgY29uc29sZS5sb2coJ3NjLmUucmVkaXJlY3RUb0hvbWVSb29tJyk7XG4gICAgICBzZWxmLnZlbnQudHJpZ2dlcihcInJlZGlyZWN0VG9Ib21lUm9vbVwiLCBkYXRhKTtcbiAgICB9KTtcblxuLy8gUk9PTSBBVkFJTEFCSUxJVFlcbiAgICBzb2NrZXQub24oJ2NoYXRyb29tQXZhaWxhYmlsaXR5JywgZnVuY3Rpb24oYXZhaWxhYmlsdHkpIHtcbiAgICAgIHNlbGYudmVudC50cmlnZ2VyKCdjaGF0cm9vbUF2YWlsYWJpbGl0eScsIGF2YWlsYWJpbHR5KTtcbiAgICB9KTtcbiAgICBzb2NrZXQub24oJ2hvbWVSb29tQXZhaWxhYmlsaXR5JywgZnVuY3Rpb24oYXZhaWxhYmlsdHkpIHtcbiAgICAgIHNlbGYudmVudC50cmlnZ2VyKCdob21lUm9vbUF2YWlsYWJpbGl0eScsIGF2YWlsYWJpbHR5KTtcbiAgICB9KTtcbiAgICBzb2NrZXQub24oJ2NoYXRyb29tRXhpc3RzJywgZnVuY3Rpb24oYXZhaWxhYmlsdHkpIHtcbiAgICAgIHNlbGYudmVudC50cmlnZ2VyKCdjaGF0cm9vbUV4aXN0cycsIGF2YWlsYWJpbHR5KTtcbiAgICB9KTtcblxuLy8gRVJST1IgSEFORExJTkdcbiAgICBzb2NrZXQub24oJ2NoYXRyb29tQWxyZWFkeUV4aXN0cycsIGZ1bmN0aW9uKCkge1xuICAgICAgc2VsZi52ZW50LnRyaWdnZXIoXCJjaGF0cm9vbUFscmVhZHlFeGlzdHNcIik7XG4gICAgfSk7XG5cbiAgICBzb2NrZXQub24oJ2Rlc3Ryb3lSb29tUmVzcG9uc2UnLCBmdW5jdGlvbihyZXMpIHtcbiAgICAgIHNlbGYudmVudC50cmlnZ2VyKFwiZGVzdHJveVJvb21SZXNwb25zZVwiLCByZXMpO1xuICAgIH0pO1xuXG4vLyBJTlZJVEFUSU9OU1xuICAgIHNvY2tldC5vbigncmVmcmVzaEludml0YXRpb25zJywgZnVuY3Rpb24oaW52aXRhdGlvbnMpIHtcbiAgICAgIHNlbGYudmVudC50cmlnZ2VyKFwicmVmcmVzaEludml0YXRpb25zXCIsIGludml0YXRpb25zKTtcbiAgICB9KTtcbiAgICBzb2NrZXQub24oJ3VzZXJJbnZpdGVkJywgZnVuY3Rpb24odXNlcikge1xuICAgICAgc2VsZi52ZW50LnRyaWdnZXIoXCJ1c2VySW52aXRlZFwiLCB1c2VyKTtcbiAgICB9KTtcblxuLy8gTE9HT1VUXG4gICAgc29ja2V0Lm9uKCdsb2dvdXQnLCBmdW5jdGlvbigpIHtcbiAgICAgIHNlbGYubG9nb3V0KCk7XG4gICAgfSk7XG5cblxuXHR9O1xufTsiLCJcblxuYXBwLk1haW5Db250cm9sbGVyID0gZnVuY3Rpb24oKSB7XG5cblx0dmFyIHNlbGYgPSB0aGlzO1xuXG5cbiAgLy9UaGVzZSBhbGxvd3MgdXMgdG8gYmluZCBhbmQgdHJpZ2dlciBvbiB0aGUgb2JqZWN0IGZyb20gYW55d2hlcmUgaW4gdGhlIGFwcC5cbiAgc2VsZi5hcHBFdmVudEJ1cyA9IF8uZXh0ZW5kKHt9LCBCYWNrYm9uZS5FdmVudHMpO1xuICBzZWxmLnZpZXdFdmVudEJ1cyA9IF8uZXh0ZW5kKHt9LCBCYWNrYm9uZS5FdmVudHMpO1xuXG4gIHNlbGYuaW5pdCA9IGZ1bmN0aW9uKCkge1xuXG4gICAgLy8gbG9naW5Nb2RlbFxuICAgIHNlbGYubG9naW5Nb2RlbCA9IG5ldyBhcHAuTG9naW5Nb2RlbCgpO1xuICAgIHNlbGYubG9naW5WaWV3ID0gbmV3IGFwcC5Mb2dpblZpZXcoe3ZlbnQ6IHNlbGYudmlld0V2ZW50QnVzLCBtb2RlbDogc2VsZi5sb2dpbk1vZGVsfSk7XG4gICAgc2VsZi5yZWdpc3RlclZpZXcgPSBuZXcgYXBwLlJlZ2lzdGVyVmlldyh7dmVudDogc2VsZi52aWV3RXZlbnRCdXMgfSk7XG4gICAgc2VsZi5uYXZiYXJWaWV3ID0gbmV3IGFwcC5OYXZiYXJWaWV3KHt2ZW50OiBzZWxmLnZpZXdFdmVudEJ1c30pO1xuXG4gICAgLy8gVGhlIENvbnRhaW5lck1vZGVsIGdldHMgcGFzc2VkIGEgdmlld1N0YXRlLCBMb2dpblZpZXcsIHdoaWNoXG4gICAgLy8gaXMgdGhlIGxvZ2luIHBhZ2UuIFRoYXQgTG9naW5WaWV3IGdldHMgcGFzc2VkIHRoZSB2aWV3RXZlbnRCdXNcbiAgICAvLyBhbmQgdGhlIExvZ2luTW9kZWwuXG4gICAgc2VsZi5jb250YWluZXJNb2RlbCA9IG5ldyBhcHAuQ29udGFpbmVyTW9kZWwoeyB2aWV3U3RhdGU6IHNlbGYubG9naW5WaWV3fSk7XG5cbiAgICAvLyBuZXh0LCBhIG5ldyBDb250YWluZXJWaWV3IGlzIGludGlhbGl6ZWQgd2l0aCB0aGUgbmV3bHkgY3JlYXRlZCBjb250YWluZXJNb2RlbFxuICAgIC8vIHRoZSBsb2dpbiBwYWdlIGlzIHRoZW4gcmVuZGVyZWQuXG4gICAgc2VsZi5jb250YWluZXJWaWV3ID0gbmV3IGFwcC5Db250YWluZXJWaWV3KHsgbW9kZWw6IHNlbGYuY29udGFpbmVyTW9kZWwgfSk7XG4gICAgc2VsZi5jb250YWluZXJWaWV3LnJlbmRlcigpO1xuXG4gICAgJCgnZm9ybScpLmtleXByZXNzKGZ1bmN0aW9uKGUpIHtcbiAgICAgIHJldHVybiBlLmtleUNvZGUgIT0gMTM7XG4gICAgfSk7XG5cblxuICB9O1xuXG5cbiAgc2VsZi5hdXRoZW50aWNhdGVkID0gZnVuY3Rpb24oKSB7XG4gICAgY29uc29sZS5sb2coJ2YubWFpbi5hdXRoZW50aWNhdGVkJyk7XG4gICAgXG4gICAgJChcImJvZHlcIikuY3NzKFwib3ZlcmZsb3dcIiwgXCJoaWRkZW5cIik7XG4gICAgJCgnZm9ybScpLmtleXByZXNzKGZ1bmN0aW9uKGUpIHtcbiAgICAgIHJldHVybiBlLmtleUNvZGUgIT0gMTM7XG4gICAgfSk7XG5cbiAgICBzZWxmLmNoYXRDbGllbnQgPSBuZXcgQ2hhdENsaWVudCh7IHZlbnQ6IHNlbGYuYXBwRXZlbnRCdXMgfSk7XG4gICAgc2VsZi5jaGF0Q2xpZW50LmNvbm5lY3QoKTtcblxuICAgIC8vIG5ldyBtb2RlbCBhbmQgdmlldyBjcmVhdGVkIGZvciBjaGF0cm9vbVxuICAgIHNlbGYuY2hhdHJvb21Nb2RlbCA9IG5ldyBhcHAuQ2hhdHJvb21Nb2RlbCh7IG5hbWU6ICdDaGphdCcgfSk7XG4gICAgc2VsZi5jaGF0cm9vbUxpc3QgPSBuZXcgYXBwLkNoYXRyb29tTGlzdCgpO1xuICAgIHNlbGYucHJpdmF0ZVJvb21Db2xsZWN0aW9uID0gbmV3IGFwcC5Qcml2YXRlUm9vbUNvbGxlY3Rpb24oKTtcbiAgICBzZWxmLmNoYXRyb29tTW9kZWwuc2V0KCdjaGF0cm9vbXMnLCBzZWxmLmNoYXRyb29tTGlzdCk7XG4gICAgc2VsZi5jaGF0cm9vbU1vZGVsLnNldCgncHJpdmF0ZVJvb21zJywgc2VsZi5wcml2YXRlUm9vbUNvbGxlY3Rpb24pO1xuICAgIHNlbGYuY2hhdHJvb21WaWV3ICA9IG5ldyBhcHAuQ2hhdHJvb21WaWV3KHt2ZW50OiBzZWxmLnZpZXdFdmVudEJ1cywgbW9kZWw6IHNlbGYuY2hhdHJvb21Nb2RlbCB9KTtcbiAgICBzZWxmLmNvbnRhaW5lck1vZGVsLnNldCgndmlld1N0YXRlJywgc2VsZi5jaGF0cm9vbVZpZXcpO1xuICAgICQoJ2JvZHknKS5vbignaGlkZGVuLmJzLm1vZGFsJywgJy5tb2RhbCcsIGZ1bmN0aW9uICgpIHtcbiAgICAgICQodGhpcykucmVtb3ZlRGF0YSgnYnMubW9kYWwnKTtcbiAgICB9KTtcbiAgfTtcblxuXG5cblxuXG5cbiAgLy8vLy8vLy8vLy8vICBCdXNzZXMgLy8vLy8vLy8vLy8vXG4gICAgLy8gVGhlc2UgQnVzc2VzIGxpc3RlbiB0byB0aGUgc29ja2V0Y2xpZW50XG4gICAvLyAgICAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cblxuXG5cbiAgLy8vLyB2aWV3RXZlbnRCdXMgTGlzdGVuZXJzIC8vLy8vXG4gIFxuICBzZWxmLnZpZXdFdmVudEJ1cy5vbihcImxvZ2luXCIsIGZ1bmN0aW9uKHVzZXIpIHtcbiAgICBzZWxmLmNoYXRDbGllbnQubG9naW4odXNlcik7XG4gIH0pO1xuICBzZWxmLnZpZXdFdmVudEJ1cy5vbihcImNoYXRcIiwgZnVuY3Rpb24oY2hhdCkge1xuICAgIHNlbGYuY2hhdENsaWVudC5jaGF0KGNoYXQpO1xuICB9KTtcbiAgc2VsZi52aWV3RXZlbnRCdXMub24oXCJ0eXBpbmdcIiwgZnVuY3Rpb24oKSB7XG4gICAgc2VsZi5jaGF0Q2xpZW50LnVwZGF0ZVR5cGluZygpO1xuICB9KTtcbiAgc2VsZi52aWV3RXZlbnRCdXMub24oXCJqb2luUm9vbVwiLCBmdW5jdGlvbihyb29tTmFtZSkge1xuICAgIHNlbGYuY2hhdENsaWVudC5qb2luUm9vbShyb29tTmFtZSk7XG4gIH0pO1xuICBzZWxmLnZpZXdFdmVudEJ1cy5vbihcImFkZFJvb21cIiwgZnVuY3Rpb24ocm9vbSkge1xuICAgIHNlbGYuY2hhdENsaWVudC5hZGRSb29tKHJvb20pO1xuICB9KTtcbiAgc2VsZi52aWV3RXZlbnRCdXMub24oXCJyZW1vdmVSb29tXCIsIGZ1bmN0aW9uKHJvb21EYXRhKSB7XG4gICAgc2VsZi5jaGF0Q2xpZW50LnJlbW92ZVJvb20ocm9vbURhdGEpO1xuICB9KTtcbiAgc2VsZi52aWV3RXZlbnRCdXMub24oXCJjcmVhdGVSb29tXCIsIGZ1bmN0aW9uKGZvcm1EYXRhKSB7XG4gICAgc2VsZi5jaGF0Q2xpZW50LmNyZWF0ZVJvb20oZm9ybURhdGEpO1xuICB9KTtcbiAgc2VsZi52aWV3RXZlbnRCdXMub24oXCJ1cGRhdGVSb29tXCIsIGZ1bmN0aW9uKGZvcm1EYXRhKSB7XG4gICAgc2VsZi5jaGF0Q2xpZW50LnVwZGF0ZVJvb20oZm9ybURhdGEpO1xuICB9KTtcbiAgc2VsZi52aWV3RXZlbnRCdXMub24oXCJkZXN0cm95Um9vbVwiLCBmdW5jdGlvbihyb29tSW5mbykge1xuICAgIHNlbGYuY2hhdENsaWVudC5kZXN0cm95Um9vbShyb29tSW5mbyk7XG4gIH0pO1xuICBzZWxmLnZpZXdFdmVudEJ1cy5vbihcImdldE1vcmVDaGF0c1wiLCBmdW5jdGlvbihjaGF0UmVxKSB7XG4gICAgc2VsZi5jaGF0Q2xpZW50LmdldE1vcmVDaGF0cyhjaGF0UmVxKTtcbiAgfSk7XG4gIHNlbGYudmlld0V2ZW50QnVzLm9uKFwiaW5pdERpcmVjdE1lc3NhZ2VcIiwgZnVuY3Rpb24ocmVjaXBpZW50KSB7XG4gICAgc2VsZi5jaGF0Q2xpZW50LmluaXREaXJlY3RNZXNzYWdlKHJlY2lwaWVudCk7XG4gIH0pO1xuICBzZWxmLnZpZXdFdmVudEJ1cy5vbihcImRpcmVjdE1lc3NhZ2VcIiwgZnVuY3Rpb24oZGlyZWN0TWVzc2FnZSkge1xuICAgIHNlbGYuY2hhdENsaWVudC5kaXJlY3RNZXNzYWdlKGRpcmVjdE1lc3NhZ2UpO1xuICB9KTtcbiAgc2VsZi52aWV3RXZlbnRCdXMub24oXCJnZXRNb3JlRGlyZWN0TWVzc2FnZXNcIiwgZnVuY3Rpb24oZGlyZWN0TWVzc2FnZVJlcSkge1xuICAgIHNlbGYuY2hhdENsaWVudC5nZXRNb3JlRGlyZWN0TWVzc2FnZXMoZGlyZWN0TWVzc2FnZVJlcSk7XG4gIH0pO1xuICBzZWxmLnZpZXdFdmVudEJ1cy5vbihcImludml0ZVVzZXJcIiwgZnVuY3Rpb24oaW52aXRhdGlvbk9iaikge1xuICAgIHNlbGYuY2hhdENsaWVudC5pbnZpdGVVc2VyKGludml0YXRpb25PYmopO1xuICB9KTtcbiAgc2VsZi52aWV3RXZlbnRCdXMub24oXCJkZWxldGVJbnZpdGF0aW9uXCIsIGZ1bmN0aW9uKHJvb21JZCkge1xuICAgIHNlbGYuY2hhdENsaWVudC5kZWxldGVJbnZpdGF0aW9uKHJvb21JZCk7XG4gIH0pO1xuICBzZWxmLnZpZXdFdmVudEJ1cy5vbihcImFjY2VwdEludml0YXRpb25cIiwgZnVuY3Rpb24ocm9vbUlkKSB7XG4gICAgc2VsZi5jaGF0Q2xpZW50LmFjY2VwdEludml0YXRpb24ocm9vbUlkKTtcbiAgfSk7XG4gIHNlbGYudmlld0V2ZW50QnVzLm9uKFwidXBkYXRlVXNlclwiLCBmdW5jdGlvbih1c2VyT2JqKSB7XG4gICAgc2VsZi5jaGF0Q2xpZW50LnVwZGF0ZVVzZXIodXNlck9iaik7XG4gIH0pO1xuICBzZWxmLnZpZXdFdmVudEJ1cy5vbihcImxvZ291dFwiLCBmdW5jdGlvbigpIHtcbiAgICBzZWxmLmNoYXRDbGllbnQubG9nb3V0KCk7XG4gIH0pO1xuXG5cbi8vIEVSUk9SIEhBTkRMSU5HXG5zZWxmLnZpZXdFdmVudEJ1cy5vbihcImRvZXNDaGF0cm9vbUV4aXN0XCIsIGZ1bmN0aW9uKGNoYXRyb29tUXVlcnkpIHtcbiAgc2VsZi5jaGF0Q2xpZW50LmRvZXNDaGF0cm9vbUV4aXN0KGNoYXRyb29tUXVlcnkpO1xufSk7XG5zZWxmLnZpZXdFdmVudEJ1cy5vbihcImRvZXNIb21lUm9vbUV4aXN0XCIsIGZ1bmN0aW9uKGNoYXRyb29tUXVlcnkpIHtcbiAgc2VsZi5jaGF0Q2xpZW50LmRvZXNIb21lUm9vbUV4aXN0KGNoYXRyb29tUXVlcnkpO1xufSk7XG5zZWxmLnZpZXdFdmVudEJ1cy5vbihcImRvZXNTZWFyY2hDaGF0cm9vbUV4aXN0XCIsIGZ1bmN0aW9uKGNoYXRyb29tUXVlcnkpIHtcbiAgc2VsZi5jaGF0Q2xpZW50LmRvZXNTZWFyY2hDaGF0cm9vbUV4aXN0KGNoYXRyb29tUXVlcnkpO1xufSk7XG5cblxuXG5cblxuXG5cbiAgLy8vLyBhcHBFdmVudEJ1cyBMaXN0ZW5lcnMgLy8vL1xuXG5cbi8vIE5hdmJhclxuc2VsZi5hcHBFdmVudEJ1cy5vbihcImluaXRVc2VyXCIsIGZ1bmN0aW9uKHVzZXIpIHtcbiAgY29uc29sZS5sb2coJ21haW4uZS5pbml0VXNlcjogJywgdXNlcik7XG4gIGludml0YXRpb25zID0gc2VsZi5uYXZiYXJWaWV3Lm1vZGVsLmdldCgnaW52aXRhdGlvbnMnKTtcbiAgbmV3SW52aXRhdGlvbnMgPSBfLm1hcCh1c2VyLmludml0YXRpb25zLCBmdW5jdGlvbihpbnZpdGUpIHtcbiAgIHZhciBuZXdJbnZpdGF0aW9uID0gbmV3IGFwcC5JbnZpdGF0aW9uTW9kZWwoaW52aXRlKTtcbiAgIHJldHVybiBuZXdJbnZpdGF0aW9uO1xuIH0pO1xuICBpbnZpdGF0aW9ucy5yZXNldChuZXdJbnZpdGF0aW9ucyk7XG4gIHNlbGYubmF2YmFyVmlldy5tb2RlbC5zZXQoeyAndXNlcm5hbWUnOiB1c2VyLnVzZXJuYW1lLCAnaG9tZVJvb20nOiB1c2VyLmhvbWVSb29tLCAndXNlckltYWdlJzogdXNlci51c2VySW1hZ2UgfSk7XG59KTtcblxuc2VsZi5hcHBFdmVudEJ1cy5vbihcInJlZnJlc2hJbnZpdGF0aW9uc1wiLCBmdW5jdGlvbihpbnZpdGF0aW9ucykge1xuICBjb25zb2xlLmxvZygnbWFpbi5lLnJlZnJlc2hJbnZpdGF0aW9ucycpO1xuICBvbGRJbnZpdGF0aW9ucyA9IHNlbGYubmF2YmFyVmlldy5tb2RlbC5nZXQoJ2ludml0YXRpb25zJyk7XG4gIG5ld0ludml0YXRpb25zID0gXy5tYXAoaW52aXRhdGlvbnMsIGZ1bmN0aW9uKGludml0ZSkge1xuICAgdmFyIG5ld0ludml0YXRpb24gPSBuZXcgYXBwLkludml0YXRpb25Nb2RlbChpbnZpdGUpO1xuICAgcmV0dXJuIG5ld0ludml0YXRpb247XG4gfSk7XG4gIG9sZEludml0YXRpb25zLnJlc2V0KG5ld0ludml0YXRpb25zKTtcbn0pO1xuXG5cbi8vIENIQVRST09NIENPTlRBSU5FUlxuc2VsZi5hcHBFdmVudEJ1cy5vbihcIkNoYXRyb29tTW9kZWxcIiwgZnVuY3Rpb24obW9kZWwpIHtcbiAgY29uc29sZS5sb2coJ21haW4uZS5DaGF0cm9vbU1vZGVsJyk7XG4gIHNlbGYuY2hhdHJvb21Nb2RlbCA9IG5ldyBhcHAuQ2hhdHJvb21Nb2RlbCgpO1xuICBzZWxmLmNoYXRyb29tTGlzdCA9IG5ldyBhcHAuQ2hhdHJvb21MaXN0KCk7XG4gIHNlbGYuY2hhdHJvb21WaWV3ICA9IG5ldyBhcHAuQ2hhdHJvb21WaWV3KHt2ZW50OiBzZWxmLnZpZXdFdmVudEJ1cywgbW9kZWw6IHNlbGYuY2hhdHJvb21Nb2RlbCwgY29sbGVjdGlvbjogc2VsZi5jaGF0cm9vbUxpc3R9KTtcbiAgc2VsZi5jb250YWluZXJNb2RlbC5zZXQoJ3ZpZXdTdGF0ZScsIHNlbGYuY2hhdHJvb21WaWV3KTtcbiAgc2VsZi5jaGF0cm9vbU1vZGVsLmxvYWRNb2RlbChtb2RlbCk7XG59KTtcblxuXG4vLyBTRVQgQ0hBVFJPT01cbnNlbGYuYXBwRXZlbnRCdXMub24oXCJzZXRDaGF0cm9vbUhlYWRlclwiLCBmdW5jdGlvbihoZWFkZXJPYmopIHtcbiAgdmFyIG5ld0hlYWRlciA9IG5ldyBhcHAuQ2hhdHJvb21IZWFkZXJNb2RlbChoZWFkZXJPYmopO1xuICBzZWxmLmNoYXRyb29tTW9kZWwuc2V0KCdjaGF0cm9vbScsIG5ld0hlYWRlcik7XG59KTtcbnNlbGYuYXBwRXZlbnRCdXMub24oXCJzZXRDaGF0bG9nXCIsIGZ1bmN0aW9uKGNoYXRsb2cpIHtcbiAgdmFyIG9sZENoYXRsb2cgPSBzZWxmLmNoYXRyb29tTW9kZWwuZ2V0KCdjaGF0bG9nJyk7XG4gIHZhciB1cGRhdGVkQ2hhdGxvZyA9IF8ubWFwKGNoYXRsb2csIGZ1bmN0aW9uKGNoYXQpIHtcbiAgICB2YXIgbmV3Q2hhdE1vZGVsID0gbmV3IGFwcC5DaGF0TW9kZWwoeyByb29tOiBjaGF0LnJvb20sIG1lc3NhZ2U6IGNoYXQubWVzc2FnZSwgc2VuZGVyOiBjaGF0LnNlbmRlciwgdGltZXN0YW1wOiBjaGF0LnRpbWVzdGFtcCwgdXJsOiBjaGF0LnVybCB9KTtcbiAgICByZXR1cm4gbmV3Q2hhdE1vZGVsO1xuICB9KTtcbiAgb2xkQ2hhdGxvZy5yZXNldCh1cGRhdGVkQ2hhdGxvZyk7XG4gICQoJyNtZXNzYWdlLWlucHV0JykucmVtb3ZlQ2xhc3MoJ2RpcmVjdC1tZXNzYWdlLWlucHV0JykuYWRkQ2xhc3MoJ21lc3NhZ2UtaW5wdXQnKTtcbiAgJCgnI2NoYXRib3gtY29udGVudCcpWzBdLnNjcm9sbFRvcCA9ICQoJyNjaGF0Ym94LWNvbnRlbnQnKVswXS5zY3JvbGxIZWlnaHQ7XG59KTtcbnNlbGYuYXBwRXZlbnRCdXMub24oXCJzZXRDaGF0cm9vbXNcIiwgZnVuY3Rpb24ocm9vbXMpIHtcbiAgdmFyIG9sZFJvb21zID0gc2VsZi5jaGF0cm9vbU1vZGVsLmdldCgnY2hhdHJvb21zJyk7XG4gIHZhciBuZXdSb29tcyA9IF8ubWFwKHJvb21zLCBmdW5jdGlvbihyb29tKSB7XG4gICAgdmFyIG5ld0NoYXRyb29tTW9kZWwgPSBuZXcgYXBwLkNoYXRyb29tTW9kZWwoeyBpZDogcm9vbS5faWQsIG5hbWU6IHJvb20ubmFtZSwgb3duZXI6IHJvb20ub3duZXIsIHJvb21JbWFnZTogcm9vbS5yb29tSW1hZ2UsIHByaXZhY3k6IHJvb20ucHJpdmFjeX0pO1xuICAgIHJldHVybiBuZXdDaGF0cm9vbU1vZGVsO1xuICB9KTtcbiAgb2xkUm9vbXMucmVzZXQobmV3Um9vbXMpO1xufSk7XG5zZWxmLmFwcEV2ZW50QnVzLm9uKFwic2V0UHJpdmF0ZVJvb21zXCIsIGZ1bmN0aW9uKHJvb21zKSB7XG4gIHZhciBvbGRSb29tcyA9IHNlbGYuY2hhdHJvb21Nb2RlbC5nZXQoJ3ByaXZhdGVSb29tcycpO1xuICB2YXIgbmV3Um9vbXMgPSBfLm1hcChyb29tcywgZnVuY3Rpb24ocm9vbSkge1xuICAgIHZhciBuZXdDaGF0cm9vbU1vZGVsID0gbmV3IGFwcC5DaGF0cm9vbU1vZGVsKHsgaWQ6IHJvb20uX2lkLCBuYW1lOiByb29tLm5hbWUsIG93bmVyOiByb29tLm93bmVyLCByb29tSW1hZ2U6IHJvb20ucm9vbUltYWdlLCBwcml2YWN5OiByb29tLnByaXZhY3ksIGN1cnJlbnRVc2VyOiByb29tLmN1cnJlbnRVc2VyfSk7XG4gICAgcmV0dXJuIG5ld0NoYXRyb29tTW9kZWw7XG4gIH0pO1xuICBvbGRSb29tcy5yZXNldChuZXdSb29tcyk7XG59KTtcbnNlbGYuYXBwRXZlbnRCdXMub24oXCJzZXRPbmxpbmVVc2Vyc1wiLCBmdW5jdGlvbihvbmxpbmVVc2Vycykge1xuICB2YXIgb2xkT25saW5lVXNlcnMgPSBzZWxmLmNoYXRyb29tTW9kZWwuZ2V0KCdvbmxpbmVVc2VycycpO1xuICB2YXIgdXBkYXRlZE9ubGluZVVzZXJzID0gXy5tYXAob25saW5lVXNlcnMsIGZ1bmN0aW9uKHVzZXIpIHtcbiAgICB2YXIgbmV3VXNlck1vZGVsID0gbmV3IGFwcC5Vc2VyTW9kZWwoe3VzZXJuYW1lOiB1c2VyLnVzZXJuYW1lLCB1c2VySW1hZ2U6IHVzZXIudXNlckltYWdlfSk7XG4gICAgcmV0dXJuIG5ld1VzZXJNb2RlbDtcbiAgfSk7XG4gIG9sZE9ubGluZVVzZXJzLnJlc2V0KHVwZGF0ZWRPbmxpbmVVc2Vycyk7XG59KTtcbnNlbGYuYXBwRXZlbnRCdXMub24oXCJzZXRPZmZsaW5lVXNlcnNcIiwgZnVuY3Rpb24ob2ZmbGluZVVzZXJzKSB7XG4gIHZhciBvbGRPZmZsaW5lVXNlcnMgPSBzZWxmLmNoYXRyb29tTW9kZWwuZ2V0KCdvZmZsaW5lVXNlcnMnKTtcbiAgdmFyIHVwZGF0ZWRPZmZsaW5lVXNlcnMgPSBfLm1hcChvZmZsaW5lVXNlcnMsIGZ1bmN0aW9uKHVzZXIpIHtcbiAgICB2YXIgbmV3VXNlck1vZGVsID0gbmV3IGFwcC5Vc2VyTW9kZWwoe3VzZXJuYW1lOiB1c2VyLnVzZXJuYW1lLCB1c2VySW1hZ2U6IHVzZXIudXNlckltYWdlfSk7XG4gICAgcmV0dXJuIG5ld1VzZXJNb2RlbDtcbiAgfSk7XG4gIG9sZE9mZmxpbmVVc2Vycy5yZXNldCh1cGRhdGVkT2ZmbGluZVVzZXJzKTtcbn0pO1xuXG5cblxuLy8gVVNFUiBKT0lOL0xFQVZFIENIQVRST09NXG4gIC8vIGFkZHMgbmV3IHVzZXIgdG8gdXNlcnMgY29sbGVjdGlvbiwgc2VuZHMgZGVmYXVsdCBqb2luaW5nIG1lc3NhZ2VcbiAgc2VsZi5hcHBFdmVudEJ1cy5vbihcInVzZXJKb2luZWRcIiwgZnVuY3Rpb24odXNlcikge1xuICAgIGNvbnNvbGUubG9nKCdtYWluLmUudXNlckpvaW5lZCcpO1xuICAgIHNlbGYuY2hhdHJvb21Nb2RlbC5hZGRVc2VyKHVzZXIpO1xuICAgIHNlbGYuY2hhdHJvb21Nb2RlbC5hZGRDaGF0KHtzZW5kZXI6IFwiQ2hhdHJvb20gUGlnXCIsIG1lc3NhZ2U6IHVzZXIudXNlcm5hbWUgKyBcIiBqb2luZWQgcm9vbS5cIiB9KTtcbiAgfSk7XG5cdC8vIHJlbW92ZXMgdXNlciBmcm9tIHVzZXJzIGNvbGxlY3Rpb24sIHNlbmRzIGRlZmF1bHQgbGVhdmluZyBtZXNzYWdlXG5cdHNlbGYuYXBwRXZlbnRCdXMub24oXCJ1c2VyTGVmdFwiLCBmdW5jdGlvbih1c2VyKSB7XG4gICAgY29uc29sZS5sb2coJ21haW4uZS51c2VyTGVmdCcpO1xuICAgIHNlbGYuY2hhdHJvb21Nb2RlbC5yZW1vdmVVc2VyKHVzZXIpO1xuICAgIHNlbGYuY2hhdHJvb21Nb2RlbC5hZGRDaGF0KHtzZW5kZXI6IFwiQ2hhdHJvb20gUGlnXCIsIG1lc3NhZ2U6IHVzZXIudXNlcm5hbWUgKyBcIiBsZWZ0IHJvb20uXCIgfSk7XG4gIH0pO1xuXG5cbi8vIENIQVRST09NIE1FU1NBR0lOR1xuXHQvLyBjaGF0IHBhc3NlZCBmcm9tIHNvY2tldGNsaWVudCwgYWRkcyBhIG5ldyBjaGF0IG1lc3NhZ2UgdXNpbmcgY2hhdHJvb21Nb2RlbCBtZXRob2Rcblx0c2VsZi5hcHBFdmVudEJ1cy5vbihcImNoYXRSZWNlaXZlZFwiLCBmdW5jdGlvbihjaGF0KSB7XG4gICAgc2VsZi5jaGF0cm9vbU1vZGVsLmFkZENoYXQoY2hhdCk7XG4gICAgJCgnI2NoYXRib3gtY29udGVudCcpWzBdLnNjcm9sbFRvcCA9ICQoJyNjaGF0Ym94LWNvbnRlbnQnKVswXS5zY3JvbGxIZWlnaHQ7XG4gIH0pO1xuICBzZWxmLmFwcEV2ZW50QnVzLm9uKFwibW9yZUNoYXRzXCIsIGZ1bmN0aW9uKGNoYXRsb2cpIHtcbiAgICB2YXIgb2xkQ2hhdGxvZyA9IHNlbGYuY2hhdHJvb21Nb2RlbC5nZXQoJ2NoYXRsb2cnKTtcbiAgICB2YXIgbW9yZUNoYXRsb2cgPSBfLm1hcChjaGF0bG9nLCBmdW5jdGlvbihjaGF0KSB7XG4gICAgICB2YXIgbmV3Q2hhdE1vZGVsID0gbmV3IGFwcC5DaGF0TW9kZWwoeyByb29tOiBjaGF0LnJvb20sIG1lc3NhZ2U6IGNoYXQubWVzc2FnZSwgc2VuZGVyOiBjaGF0LnNlbmRlciwgdGltZXN0YW1wOiBjaGF0LnRpbWVzdGFtcCwgdXJsOiBjaGF0LnVybCB9KTtcbiAgICAgIHJldHVybiBuZXdDaGF0TW9kZWw7XG4gICAgfSk7XG4gICAgc2VsZi5jaGF0cm9vbU1vZGVsLnRyaWdnZXIoJ21vcmVDaGF0cycsIG1vcmVDaGF0bG9nKTtcbiAgfSk7XG4gIHNlbGYuYXBwRXZlbnRCdXMub24oXCJub01vcmVDaGF0c1wiLCBmdW5jdGlvbihjaGF0bG9nKSB7XG4gICAgc2VsZi5jaGF0cm9vbU1vZGVsLnN0b3BMaXN0ZW5pbmcoJ21vcmVDaGF0cycpO1xuICB9KTtcblxuXG4vLyBTRVQgRElSRUNUIE1FU1NBR0VcbnNlbGYuYXBwRXZlbnRCdXMub24oXCJzZXRETWNoYXRsb2dcIiwgZnVuY3Rpb24oY2hhdGxvZykge1xuICB2YXIgb2xkQ2hhdGxvZyA9IHNlbGYuY2hhdHJvb21Nb2RlbC5nZXQoJ2NoYXRsb2cnKTtcbiAgdmFyIHVwZGF0ZWRDaGF0bG9nID0gXy5tYXAoY2hhdGxvZywgZnVuY3Rpb24oY2hhdCkge1xuICAgIHZhciBuZXdDaGF0TW9kZWwgPSBuZXcgYXBwLkNoYXRNb2RlbCh7IHJvb206IGNoYXQucm9vbSwgbWVzc2FnZTogY2hhdC5tZXNzYWdlLCBzZW5kZXI6IGNoYXQuc2VuZGVyLCB0aW1lc3RhbXA6IGNoYXQudGltZXN0YW1wLCB1cmw6IGNoYXQudXJsIH0pO1xuICAgIHJldHVybiBuZXdDaGF0TW9kZWw7XG4gIH0pO1xuICBvbGRDaGF0bG9nLnJlc2V0KHVwZGF0ZWRDaGF0bG9nKTtcbiAgJCgnI21lc3NhZ2UtaW5wdXQnKS5yZW1vdmVDbGFzcygnbWVzc2FnZS1pbnB1dCcpLmFkZENsYXNzKCdkaXJlY3QtbWVzc2FnZS1pbnB1dCcpO1xuICAkKCcjY2hhdEltYWdlVXBsb2FkQ29udGFpbmVyJykuZGF0YSgnY2hhdC10eXBlJywgJ21lc3NhZ2UnKTtcbiAgJCgnI2NoYXRib3gtY29udGVudCcpWzBdLnNjcm9sbFRvcCA9ICQoJyNjaGF0Ym94LWNvbnRlbnQnKVswXS5zY3JvbGxIZWlnaHQ7XG59KTtcbnNlbGYuYXBwRXZlbnRCdXMub24oXCJzZXRETWhlYWRlclwiLCBmdW5jdGlvbihoZWFkZXIpIHtcbiAgdmFyIG5ld0hlYWRlciA9IG5ldyBhcHAuQ2hhdHJvb21IZWFkZXJNb2RlbChoZWFkZXIpO1xuICBzZWxmLmNoYXRyb29tTW9kZWwuc2V0KCdjaGF0cm9vbScsIG5ld0hlYWRlcik7XG59KTtcblxuXG4vLyBESVJFQ1QgTUVTU0FHSU5HXG5zZWxmLmFwcEV2ZW50QnVzLm9uKFwiZGlyZWN0TWVzc2FnZVJlY2VpdmVkXCIsIGZ1bmN0aW9uKG1lc3NhZ2UpIHtcbiAgc2VsZi5jaGF0cm9vbU1vZGVsLmFkZENoYXQobWVzc2FnZSk7XG4gICQoJyNjaGF0Ym94LWNvbnRlbnQnKVswXS5zY3JvbGxUb3AgPSAkKCcjY2hhdGJveC1jb250ZW50JylbMF0uc2Nyb2xsSGVpZ2h0O1xufSk7XG5cblxuXG4vLyBDSEFUUk9PTSBBVkFJTEFCSUxJVFlcbnNlbGYuYXBwRXZlbnRCdXMub24oXCJjaGF0cm9vbUF2YWlsYWJpbGl0eVwiLCBmdW5jdGlvbihhdmFpbGFiaWxpdHkpIHtcbiAgc2VsZi5jaGF0cm9vbU1vZGVsLnRyaWdnZXIoJ2NoYXRyb29tQXZhaWxhYmlsaXR5JywgYXZhaWxhYmlsaXR5KTtcbn0pO1xuc2VsZi5hcHBFdmVudEJ1cy5vbihcImhvbWVSb29tQXZhaWxhYmlsaXR5XCIsIGZ1bmN0aW9uKGF2YWlsYWJpbGl0eSkge1xuICBzZWxmLm5hdmJhclZpZXcudHJpZ2dlcignaG9tZVJvb21BdmFpbGFiaWxpdHknLCBhdmFpbGFiaWxpdHkpO1xufSk7XG5zZWxmLmFwcEV2ZW50QnVzLm9uKFwiY2hhdHJvb21FeGlzdHNcIiwgZnVuY3Rpb24oYXZhaWxhYmlsaXR5KSB7XG4gIHNlbGYuY2hhdHJvb21Nb2RlbC50cmlnZ2VyKCdjaGF0cm9vbUV4aXN0cycsIGF2YWlsYWJpbGl0eSk7XG59KTtcblxuXG4vLyBDSEFUUk9PTSBJTlZJVEFUSU9OXG5zZWxmLmFwcEV2ZW50QnVzLm9uKFwidXNlckludml0ZWRcIiwgZnVuY3Rpb24odXNlcikge1xuICBjb25zb2xlLmxvZygnbWFpbi5lLnVzZXJJbnZpdGVkJyk7XG4gIHNlbGYuY2hhdHJvb21Nb2RlbC50cmlnZ2VyKCd1c2VySW52aXRlZCcsIHVzZXIpO1xufSk7XG5cblxuLy8gUkVESVJFQ1RcbnNlbGYuYXBwRXZlbnRCdXMub24oXCJyZWRpcmVjdFRvSG9tZVJvb21cIiwgZnVuY3Rpb24oZGF0YSkge1xuICBzZWxmLmNoYXRDbGllbnQuY29ubmVjdFRvUm9vbShkYXRhLmhvbWVSb29tKTtcbn0pO1xuXG5cbi8vIEVSUk9SIEhBTkRMSU5HXG5zZWxmLmFwcEV2ZW50QnVzLm9uKFwiY2hhdHJvb21BbHJlYWR5RXhpc3RzXCIsIGZ1bmN0aW9uKCkge1xuICBzd2FsKHtcbiAgICB0aXRsZTogXCJPSCBOTyBPSCBOTyBPSCBOT1wiLFxuICAgIHRleHQ6IFwiQ2hhdHJvb20gQWxyZWFkeSwgSXQgQWxyZWFkeSBFeGlzdHMhIEFuZC4gRG9uJ3QgR28gSW4gVGhlcmUuIERvbid0LiBZb3UuIFlvdSBTaG91bGQgSGF2ZS4gSSBUaHJldyBVcCBPbiBUaGUgU2VydmVyLiBUaG9zZSBQb29yIC4gLiAuIFRoZXkgV2VyZSBKdXN0ISBPSCBOTyBXSFkuIFdIWSBPSCBOTy4gT0ggTk8uXCIsXG4gICAgdHlwZTogXCJlcnJvclwiLFxuICAgIGNvbmZpcm1CdXR0b25Db2xvcjogXCIjNzQ5Q0E4XCJcbiAgfSk7XG59KTtcbnNlbGYuYXBwRXZlbnRCdXMub24oXCJkZXN0cm95Um9vbVJlc3BvbnNlXCIsIGZ1bmN0aW9uKHJlcykge1xuICBpZiAocmVzLmVycm9yKSB7XG4gICAgc3dhbCh7XG4gICAgICB0aXRsZTogXCJObyBUb3VjaHkhXCIsXG4gICAgICB0ZXh0OiBcIllvdSBDYW4ndCBEZWxldGUgWW91ciBIb21lIFJvb20sIE51aCBVaC4gV2hvIGFyZSB5b3UsIEZyYW56IFJlaWNoZWx0P1wiLFxuICAgICAgdHlwZTogXCJlcnJvclwiLFxuICAgICAgY29uZmlybUJ1dHRvbkNvbG9yOiBcIiM3NDlDQThcIixcbiAgICB9KTtcbiAgfVxuICBpZiAocmVzLnN1Y2Nlc3MpIHtcbiAgICBzd2FsKHtcbiAgICAgIHRpdGxlOiBcIkV2aXNjZXJhdGVkIVwiLFxuICAgICAgdGV4dDogXCJZb3VyIGNoYXRyb29tIGhhcyBiZWVuIHB1cmdlZC5cIixcbiAgICAgIHR5cGU6IFwic3VjY2Vzc1wiLFxuICAgICAgY29uZmlybUJ1dHRvbkNvbG9yOiBcIiM3NDlDQThcIixcbiAgICB9KTtcbiAgfVxufSk7XG5cblxuXG5cblxuXG5cblxuXG59O1xuIiwidmFyIGFwcCA9IGFwcCB8fCB7fTtcblxuKGZ1bmN0aW9uICgpIHtcblxuICAvLyAkKHdpbmRvdykuYmluZCgnYmVmb3JldW5sb2FkJywgZnVuY3Rpb24oZXZlbnRPYmplY3QpIHtcbiAgLy8gICAkLmFqYXgoe1xuICAvLyAgICAgIHVybDogXCIvbG9nb3V0XCIsXG4gIC8vICAgfSk7XG4gIC8vIH0pO1xuXG4gIHZhciBDaGF0cm9vbVJvdXRlciA9IEJhY2tib25lLlJvdXRlci5leHRlbmQoe1xuICAgIFxuICAgIHJvdXRlczoge1xuICAgICAgJyc6ICdzdGFydCcsXG4gICAgICAnbG9nJzogJ2xvZ2luJyxcbiAgICAgICdyZWcnOiAncmVnaXN0ZXInLFxuICAgICAgJ291dCc6ICdvdXQnLFxuICAgICAgJ2F1dGgnOiAnYXV0aGVudGljYXRlZCcsXG4gICAgICAnZmFjZWJvb2snOiAnZmFjZWJvb2snLFxuICAgICAgJ3R3aXR0ZXInOiAndHdpdHRlcidcbiAgICB9LFxuXG4gICAgc3RhcnQ6IGZ1bmN0aW9uKGNhbGxiYWNrKSB7XG4gICAgICB3aW5kb3cubG9jYXRpb24uaHJlZiA9ICcvIyc7XG4gICAgICB0aGlzLmluaXRNYWluQ29udHJvbGxlcigpO1xuICAgICAgaWYgKGNhbGxiYWNrKSB7XG4gICAgICAgIGNhbGxiYWNrKCk7XG4gICAgICB9IFxuICAgICAgLy8gZWxzZSB7XG4gICAgICAvLyAgICQuYWpheCh7XG4gICAgICAvLyAgICAgdXJsOiBcIi9sb2dvdXRcIixcbiAgICAgIC8vICAgfSk7XG4gICAgICAvLyB9XG4gICAgfSxcblxuXG4gICAgbG9naW46IGZ1bmN0aW9uKCkge1xuICAgICAgaWYgKCFhcHAubWFpbkNvbnRyb2xsZXIpIHtcbiAgICAgICAgdGhpcy5pbml0TWFpbkNvbnRyb2xsZXIoKTtcbiAgICAgIH1cbiAgICAgIHZhciBsb2dpbk1vZGVsID0gbmV3IGFwcC5Mb2dpbk1vZGVsKCk7XG4gICAgICB2YXIgbG9naW5WaWV3ID0gbmV3IGFwcC5Mb2dpblZpZXcoe3ZlbnQ6IGFwcC5tYWluQ29udHJvbGxlci52aWV3RXZlbnRCdXMsIG1vZGVsOiBsb2dpbk1vZGVsfSk7XG4gICAgICBhcHAubWFpbkNvbnRyb2xsZXIuY29udGFpbmVyTW9kZWwuc2V0KFwidmlld1N0YXRlXCIsIGxvZ2luVmlldyk7XG4gICAgfSxcblxuICAgIHJlZ2lzdGVyOiBmdW5jdGlvbigpIHtcbiAgICAgIGlmICghYXBwLm1haW5Db250cm9sbGVyKSB7XG4gICAgICAgIHRoaXMuaW5pdE1haW5Db250cm9sbGVyKCk7XG4gICAgICB9XG4gICAgICB2YXIgcmVnaXN0ZXJWaWV3ID0gbmV3IGFwcC5SZWdpc3RlclZpZXcoe3ZlbnQ6IGFwcC5tYWluQ29udHJvbGxlci52aWV3RXZlbnRCdXMgfSk7XG4gICAgICBhcHAubWFpbkNvbnRyb2xsZXIuY29udGFpbmVyTW9kZWwuc2V0KFwidmlld1N0YXRlXCIsIHJlZ2lzdGVyVmlldyk7XG4gICAgICByZWdpc3RlclZpZXcuaGVscGVycygpO1xuICAgIH0sXG5cbiAgICBhdXRoZW50aWNhdGVkOiBmdW5jdGlvbigpIHtcbiAgICAgIGlmICghYXBwLm1haW5Db250cm9sbGVyKSB7XG4gICAgICAgIHRoaXMuc3RhcnQoKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGFwcC5tYWluQ29udHJvbGxlci5hdXRoZW50aWNhdGVkKCk7XG4gICAgICB9XG4gICAgICAgIFxuICAgIH0sXG4gICAgZmFjZWJvb2s6IGZ1bmN0aW9uKCkge1xuICAgICAgdGhpcy5zdGFydCh0aGlzLmF1dGhlbnRpY2F0ZWQpO1xuICAgIH0sXG4gICAgdHdpdHRlcjogZnVuY3Rpb24oKSB7XG4gICAgICB0aGlzLnN0YXJ0KHRoaXMuYXV0aGVudGljYXRlZCk7XG4gICAgfSxcblxuICAgIGluaXRNYWluQ29udHJvbGxlcjogZnVuY3Rpb24oKSB7XG4gICAgICBhcHAubWFpbkNvbnRyb2xsZXIgPSBuZXcgYXBwLk1haW5Db250cm9sbGVyKCk7XG4gICAgICBhcHAubWFpbkNvbnRyb2xsZXIuaW5pdCgpO1xuICAgIH0sXG5cbiAgfSk7XG5cbiAgYXBwLkNoYXRyb29tUm91dGVyID0gbmV3IENoYXRyb29tUm91dGVyKCk7XG4gIEJhY2tib25lLmhpc3Rvcnkuc3RhcnQoKTtcblxufSkoKTsiXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=
